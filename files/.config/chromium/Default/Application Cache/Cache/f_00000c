/*
 * Copyright (c) 2012 Amazon.com, Inc. All rights reserved.
 */
function AppCacheEventProviderFactoryPropertyProvider(){function a(){if(!q)q=!0,g=window.applicationCache,n=jQuery.Deferred(),j()}function e(){x=!1;w=-1;n.done(function(){});KindleBuildInfo.getCurrentTotalAppcacheFileCount().then(n.resolve,n.reject)}function h(a,v,c){function g(){p.callEventListeners(a,v)}n.then(g,g);c&&(x=!0,n=jQuery.Deferred())}function j(){typeof g.addEventListener==="function"&&(g.addEventListener("error",function(a){h("error",a,!0)}),g.addEventListener("cached",function(a){h("cached",
a,!0)}),g.addEventListener("noupdate",function(a){h("noupdate",a,!0)}),g.addEventListener("updateready",function(a){h("updateready",a,!0)}),g.addEventListener("downloading",function(a){h("downloading",a,!1)}),g.addEventListener("checking",o,!1),g.addEventListener("progress",r,!1))}function o(a){x&&e();h("checking",a,!1)}function r(a){x&&e();w+=1;if(a.total!==void 0&&a.loaded!==void 0)n.resolve(a.total+1),p.callEventListeners("progress",a);else{var v=function(){a.loaded=w;return function(c){a.total=
c===-1?-1:c-1;p.callEventListeners("progress",a)}}();n.then(v,v)}}var g,p=ListenerManager(),w=-1,x=!0,n,q=!1;return{swapCache:{value:function(){a();g.swapCache()}},removeEventListener:{value:function(g,v){a();p.removeEventListener(g,v)}},addEventListener:{value:function(g,v,c){a();p.addEventListener(g,v,c)}}}}function AppCacheEventProviderFactory(){try{return Object.create(window.applicationCache||{},AppCacheEventProviderFactoryPropertyProvider())}catch(a){return window.applicationCache}}
var AppCacheEventProvider=AppCacheEventProviderFactory(),KindleApp=function(){function a(){J||(J=$(document.createElement("iframe")).attr("id",D.KINDLE_READER_ID).attr("src",KINDLE_READER_SRC).addClass(F),$("#"+D.KINDLE_READER_CONTAINER_ID).append(J))}function e(){M||(M=$(document.createElement("iframe")).attr("id",D.KINDLE_LIBRARY_ID).attr("src",KINDLE_LIBRARY_SRC).addClass(F),$("#"+D.KINDLE_LIBRARY_CONTAINER_ID).append(M))}function h(b){if(b)B.asin=b.asin,b.isSample!==void 0?B.isSample=b.isSample?
!0:!1:delete B.isSample;B.standAlone=M===void 0;if(B.asin&&G)K=KindleMetricsManager.startMetrics("Library::OpenReader"),B.metricsId=KindleMetricsManager.startMetrics("Reader:Open"),KindleMetricsManager.startSubTimer(B.metricsId,"initialize"),G.openBook(B),J&&J.focus(),B.standAlone&&$("#"+D.KINDLE_READER_CONTAINER_ID).removeClass("hidden")}function j(b){B.asin=void 0;B.metricsId=void 0;KindleLocalStorage.localStorageObject.setItem(L,"");KindleURL.removeASIN();G=null;$("#"+D.KINDLE_READER_CONTAINER_ID).addClass("hidden").empty();
J=void 0;b&&(N=b);if(I)I.onReaderClose()}function o(){O=setTimeout(function(){$("#"+D.KINDLE_LIBRARY_CONTAINER_ID).addClass("hidden")},3E3)}function r(){O&&(clearTimeout(O),O=void 0);$("#"+D.KINDLE_LIBRARY_CONTAINER_ID).removeClass("hidden");M&&M.focus()}function g(){N&&(KindleMetricsManager.endMetrics(N),N=null);a()}function p(){G&&G.unloadReader();KindleDBClient.persistDB()}function w(b){var d=KindleURL.getLandingPageURL(),f=KindleLocalStorage.localStorageObject.getItem(Kindle.App.BYPASS_LANDING_PAGE_STORAGE);
if(b)KindleLocalStorage.localStorageObject.setItem(Kindle.App.BYPASS_LANDING_PAGE_STORAGE,"true");else if(f!=="true")return KindleLocalStorage.localStorageObject.setItem(Kindle.App.BYPASS_LANDING_PAGE_STORAGE,"true"),window.location=d,!0;return!1}function x(){var b,d=!0;KindleHostDeviceDetector.isCookieEnabled()?KindleHostDeviceDetector.isLocalStorageEnabled()||(b=KINDLE_NO_LOCAL_STORAGE_SRC,d=!1):(b=KINDLE_NO_COOKIE_SRC,d=!1);d||(b=$(document.createElement("iframe")).attr("src",b).addClass(F),$("body").append(b));
return d}function n(){var b,d,f;f="library";if(B.asin)f="book";else if(B.clear)KindleURL.removeQueryParameter("clear");else if(d=KindleLocalStorage.localStorageObject.getItem(L))try{b=JSON.parse(d);if(b.isSample!==void 0)B.isSample=b.isSample;if(b.type==="reader")f="book",B.asin=b.asin}catch(A){B.asin=d}f==="library"&&(e(),r());a();b=KindleMetricsManager.startMetrics("App::Open",[KindleMetricsManager.BROWSER]);KindleHostDeviceDetector.isInAppMode()?KindleMetricsManager.increaseSubCounter(b,"inApp",
1):KindleMetricsManager.increaseSubCounter(b,"inBrowser",1);B.asin?KindleMetricsManager.increaseSubCounter(b,"inReader",1):KindleMetricsManager.increaseSubCounter(b,"inLibrary",1);KindleHostDeviceDetector.isOnline()?KindleMetricsManager.increaseSubCounter(b,"online",1):KindleMetricsManager.increaseSubCounter(b,"offline",1);KindleMetricsManager.endMetrics(b)}function q(){h()}function t(b,d,f){KindleTOS.setOpenBookReady();C();b?(f||KindleMetricsManager.addEvent("Library::ReaderOpenOffline"),$("#"+D.KINDLE_READER_CONTAINER_ID).removeClass("hidden"),
o()):(KindleMetricsManager.modifyMetricsMethod(K,"Library::ReaderOpenFail"),KindleMetricsManager.endMetrics(K),K=void 0,v());if(I)I.onReaderOpenStatus(b,d)}function v(b){j(b);e();r()}function c(b,d){var f;KindleModuleManager.getModuleSync(KindleModuleManager.METRICS_MANAGER).endMetrics(B.metricsId,!0);delete B.metricsId;KindleMetricsManager.modifyMetricsMethod(K,"Library::ReaderOpen"+(b==="topaz"?"Topaz":"Mobi"));KindleMetricsManager.endMetrics(K);K=void 0;f={asin:B.asin,type:"reader"};if(B.isSample!==
void 0)f.isSample=B.isSample;(!d||KindleHostDeviceDetector.isiOS())&&KindleLocalStorage.localStorageObject.setItem(L,JSON.stringify(f))}function z(b,d,f){var F=H.startMetrics("Store::TOSOpen"),y=b===A.LIBRARY?I&&I.onStoreOpenStatus:G&&G.onStoreOpenStatus;P||(P=!0,KindleTOS.open(d,f).then(function(d){y&&y(Kindle.STORE.OPEN_STORE);d?KindleLocalStorage.localStorageObject.removeItem(L):(b!==A.LIBRARY&&(j(),a()),o(),C(),b!==A.BOOKEXTRAS?KindleTOS.setStoreClosedCallback(u):KindleTOS.setStoreClosedCallback(s));
H.endMetrics(F);P=!1},function(){y&&y(Kindle.STORE.GENERIC_ERROR);H.modifyMetricsMethod(F,"Store::TOSOpenFail");H.endMetrics(F);P=!1}))}function l(b,d,f){var F=b===A.LIBRARY?I&&I.onStoreOpenStatus:G&&G.onStoreOpenStatus;if(!KindleHostDeviceDetector.isOnline()&&F)F(Kindle.STORE.OFFLINE_ERROR);else{var y=!1;B.storePath&&(y=!0);KindleHostDeviceDetector.isiOS()||y?z(b,d,f):(d?(b="http://www.amazon.com/dp/"+d+"/ref=kcr_store_sample",KindleLocalStorage.localStorageObject.removeItem(L)):b="http://www.amazon.com/b"+
(f?"/ref=kcr_store_emptylib_desktop":"/ref=kcr_store_libbutton_desktop")+"?_encoding=UTF8&node=1286228011",window.location.href=b,F&&F(Kindle.STORE.OPEN_STORE))}}function u(){k()}function s(){y(0);var b=KindleLocalStorage.localStorageObject.getItem(L);if(b)try{if(b=JSON.parse(b),b.type==="store"&&b.asin){f(b.asin,!1);return}}catch(d){k()}k()}function k(){B.asin?(a(),y(1E3)):(e(),r(),I&&I.libraryUpdateNeeded())}function f(b,d){var f=H.startMetrics("BEX::Open"),F=G&&G.onBookExtrasOpenStatus;y(100);
Q||(G&&G.pauseReader(),Q=!0,KindleBEX.open(b,!!d).then(function(){var y=null;F&&F(Kindle.BOOKEXTRAS.OPEN_BEX);d||(j(),a());G&&G.pauseReader();$("#"+D.KINDLE_READER_CONTAINER_ID).addClass("hidden");C();Q=!1;y={asin:b,type:"reader"};KindleLocalStorage.localStorageObject.setItem(L,JSON.stringify(y));H.increaseSubCounter(f,"Open",1);H.endMetrics(f)},function(){F&&(G.resumeReader(),F(Kindle.BOOKEXTRAS.GENERIC_ERROR));C();Q=!1;H.increaseSubCounter(f,"OpenFail",1);H.endMetrics(f)}))}function m(b){y(0);l(A.BOOKEXTRAS,
b)}function b(b){B.asin===void 0&&h({asin:b});G&&G.resumeReader();$("#"+D.KINDLE_READER_CONTAINER_ID).removeClass("hidden");J&&J.focus()}function d(b){var d=H.startMetrics("BEX::Opened");H.increaseSubCounter(d,b,1);H.endMetrics(d)}function y(b){R=setTimeout(function(){var b=$("#loading_spinner"),d=$(window).width(),f=parseInt(b.css("width"),10),F=$(window).height(),y=parseInt(b.css("height"),10);b.css("top",(F-y)/2+"px").css("left",(d-f)/2+"px").show()},b)}function C(){R&&clearTimeout(R);$("#loading_spinner").hide()}
var D={KINDLE_READER_ID:"KindleReaderIFrame",KINDLE_READER_CONTAINER_ID:"KindleReaderContainer",KINDLE_LIBRARY_ID:"KindleLibraryIFrame",KINDLE_LIBRARY_CONTAINER_ID:"KindleLibraryContainer",KINDLE_STORE_CONTAINER_ID:"KindleStoreContainer",KINDLE_BOOK_EXTRAS_CONTAINER_ID:"KindleBookExtrasContainer"},A={LIBRARY:"fromLibrary",READER:"fromReader",BOOKEXTRAS:"fromBookExtras"},E,F="KindleIFrame",L="last_app_activity",J,M,B={},G=null,I=null,N,K,P=!1,Q=!1,O,R,H;return{initialize:function(){E=[KindleModuleManager.APPCACHE_EVENTHANDLER,
KindleModuleManager.DB_CLIENT,KindleModuleManager.METRICS_MANAGER,KindleModuleManager.SERVICE_CLIENT,KindleModuleManager.APP_REGISTRATION,KindleModuleManager.CONSTANTS];KindleModuleManager.registerModule(KindleModuleManager.METRICS_MANAGER,KindleMetricsManager);KindleModuleManager.registerModule(KindleModuleManager.APP_REGISTRATION,KindleRegistrationHandler);KindleModuleManager.registerModule(KindleModuleManager.CONSTANTS,Kindle);try{KindleAppCacheEventHandler.initialize(KindleModuleManager.getModuleSync(KindleModuleManager.METRICS_MANAGER),
KindleModuleManager.getModuleSync(KindleModuleManager.CONSTANTS)),KindleModuleManager.registerModule(KindleModuleManager.APPCACHE_EVENTHANDLER,KindleAppCacheEventHandler)}catch(f){}KindleHostDeviceDetector.isiOS()&&$("body").addClass("ipad");if(x())window.onbeforeunload=p,KindleHostDeviceDetector.isiOSAppMode()||(KindleURL.normalizeQueryString(),B=KindleURL.getQueryParameters()),w(B.lnd==="true"||B.asin)||(B.lnd&&KindleURL.removeQueryParameter("lnd"),KindleDBClient.setMaxDbSize(B.maxDBSize),KindleModuleManager.registerModuleWithDeferred(KindleModuleManager.DB_CLIENT,
KindleDBClient.initialize()),KindleModuleManager.registerModuleWithDeferred(KindleModuleManager.SERVICE_CLIENT,KindleStreamingReaderClient.initialize()),KindleModuleManager.registerModuleWithDeferred(KindleModuleManager.JOURNAL_MANAGER,KindlJournalManager.initialize()),KindleMetricsManager.initialize(KindleStreamingReaderClient.uploadMetrics),H=KindleModuleManager.getModuleSync(KindleModuleManager.METRICS_MANAGER),B.storePath&&KindleTOS.setStoreURL(decodeURIComponent(B.storePath)),KindleTOS.setOpenBookCallback(h),
KindleTOS.setStoreClosedCallback(u),KindleBEX.setBookExtrasStoreOpenCallback(m),KindleBEX.setBookExtrasClosedCallback(b),KindleBEX.setBookExtrasLogMetricCallback(d),KindleLocalStorage.localStorageObject.getItem(Kindle.App.LOGGED_IN)?n():KindleModuleManager.getModuleList([KindleModuleManager.SERVICE_CLIENT]).then(function(b){b[KindleModuleManager.SERVICE_CLIENT].checkClientHashAndDeleteDBIfNeeded().done(function(){n()})}))},registerEventCallback:function(b,d){var f=[],F;for(F in Kindle.APP_CACHE)f.push(Kindle.APP_CACHE[F]);
f.indexOf(b)>=0&&KindleAppCacheEventHandler.addEventListener(b,d)},getSharedModuleSync:function(b){E.indexOf(b)===-1&&KindleDebug.error(b+"is not a shared module");return KindleModuleManager.getModuleSync(b)},getSharedModules:function(){return KindleModuleManager.getModuleList(E)},getAppInterfaceForReader:function(){return{onReaderReady:q,closeReader:v,onStartReadingStatus:t,onRendererLoaded:c,openBookExtras:f,openStore:function(b){l(A.READER,b)}}},setReaderInterface:function(b){KindleInterfaces.assertImplements(b,
KindleInterfaces.IKindleReader);G=b},getAppInterfaceForLibrary:function(){return{openStore:function(b,d){l(A.LIBRARY,b,d)},openBook:h,onLibraryLoaded:g,getQueryParameters:function(){return B}}},setLibraryInterface:function(b){KindleInterfaces.assertImplements(b,KindleInterfaces.IKindleLibrary);I=b},getQueryParams:function(){return B}}}();typeof amznJQ!=="undefined"&&amznJQ.declareAvailable("cascade");
var KindleAppCacheEventHandler=function(){function a(l){t?l&&_metricsManager.modifyMetricsMethod(t.metric,l):t={metric:_metricsManager.startMetrics(l||"KindleApp:AppCacheSuccess",[_metricsManager.BROWSER])}}function e(l){(typeof l==="undefined"||l)&&_metricsManager.endMetrics(t.metric);t=null}function h(){a();_metricsManager.increaseSubCounter(t.metric,"checking",void 0)}function j(){KindleHostDeviceDetector.isOnline()?(c.getValue()>0?_metricsManager.addEvent("KindleApp:AppCacheError:RestartBrowserFailed",
_metricsManager.BROWSER):v.getValue()>0?_metricsManager.addEvent("KindleApp:AppCacheError:RetryFailed",_metricsManager.BROWSER):_metricsManager.addEvent("KindleApp:AppCacheError:FirstTime",_metricsManager.BROWSER),KindleHostDeviceDetector.isiOS_4x()&&t.loaded===t.total&&v.getValue()>=1?(w(Kindle.APP_CACHE.CACHE_NEEDS_BROWSER_RESTART),c.increment(),_metricsManager.addEvent("KindleApp:AppCacheError:SafariRebootPrompt",_metricsManager.BROWSER)):(w(Kindle.APP_CACHE.CACHE_NEEDS_RETRY),v.increment(),_metricsManager.addEvent("KindleApp:AppCacheError:RetryPrompt",
_metricsManager.BROWSER)),KindleHostDeviceDetector.isiOS()&&KindleHostDeviceDetector.isOnline()&&q==="CHECKING"&&KindleLocalStorage.localStorageObject&&KindleLocalStorage.localStorageObject.getItem("cached")&&(_metricsManager.addEvent("KindleApp:AppCacheError:OnlineInstafail",_metricsManager.BROWSER),KindleLocalStorage.localStorageObject.setItem("cached",0),KindleModuleManager.getModuleSync(KindleModuleManager.APP_REGISTRATION).register()),q="",a("KindleApp:AppCacheError"),e()):w(Kindle.APP_CACHE.CACHE_DONE)}
function o(l){w(Kindle.APP_CACHE.CACHE_PROGRESS,{progressRatio:l.total?l.loaded+1/l.total+1:0});q="";a();t.loaded=l.loaded+1;t.total=l.total+1;_metricsManager.setSubCounter(t.metric,"total",l.total+1);_metricsManager.increaseSubCounter(t.metric,"progress",void 0)}function r(){c.getValue()>0?_metricsManager.addEvent("KindleApp:AppCacheError:RestartBrowserSucess",_metricsManager.BROWSER):v.getValue()>0&&_metricsManager.addEvent("KindleApp:AppCacheError:RetrySucess",_metricsManager.BROWSER);v.reset();
c.reset()}function g(){q="";w(Kindle.APP_CACHE.CACHE_DONE);r();a("KindleApp:AppCacheUpdate");e()}function p(){q="";w(Kindle.APP_CACHE.CACHE_CACHED);KindleLocalStorage.localStorageObject&&!KindleLocalStorage.localStorageObject.getItem("cached")&&KindleLocalStorage.localStorageObject.setItem("cached",1);r();e(!(!t||!t.loaded))}function w(l,c){c||(c={});z=l;n.callEventListeners(l,c)}var x,n=ListenerManager(),q="",t=null,v,c,z;return{initialize:function(l,a){_metricsManager=l;typeof Kindle==="undefined"&&
(Kindle=a);v=LocalStorageCounter("AppCacheRetryCount");c=LocalStorageCounter("AppCacheBrowserRestartCount");x=KindleHostDeviceDetector.isiOS_4x()?AppCacheEventProvider:KindleHostDeviceDetector.isFirefox()?AppCacheEventProvider:window.applicationCache;q=["UNCACHED","IDLE","CHECKING","DOWNLOADING","UPDATE READY","OBSOLETE"][x.status];try{x.addEventListener("checking",h,!1),x.addEventListener("error",j,!1),x.addEventListener("progress",o,!1),x.addEventListener("cached",p,!1),x.addEventListener("noupdate",
p,!1),x.addEventListener("updateready",g,!1)}catch(s){}},getCacheStatus:function(){return z},removeEventListener:function(c,a){n.removeEventListener(c,a)},addEventListener:function(c,a,v){n.addEventListener(c,a,v)}}}(),KindleBEX=function(){function a(c){n&&$("#"+p.KINDLE_BOOK_EXTRAS_CONTAINER_ID).addClass("hidden").empty();var a=new Date;n=$(document.createElement("iframe")).attr("id",p.KINDLE_BOOK_EXTRAS_ID+a.getTime()).attr("src",c).addClass(w);$("#"+p.KINDLE_BOOK_EXTRAS_CONTAINER_ID).append(n)}
function e(){$("#"+p.KINDLE_BOOK_EXTRAS_CONTAINER_ID).addClass("hidden").empty();n=null;v&&v(t)}function h(){clearTimeout(q);$("#"+p.KINDLE_BOOK_EXTRAS_CONTAINER_ID).removeClass("hidden");x.resolve(!1)}function j(){e()}function o(a){c&&c(a)}function r(c){z&&z("BookExtras::"+c)}function g(c){switch(c){case 0:x.reject();e();break;case 1:x.reject();e();break;case 4:KindleLocalStorage.localStorageObject.setItem(Kindle.BOOKEXTRAS.APP_CACHED,!0);break;case 5:KindleModuleManager.getModuleSync(KindleModuleManager.DB_CLIENT).getAppDb().updateBookExtras(t,
Kindle.BOOKEXTRAS.BEX_CACHED,function(){})}}var p={KINDLE_BOOK_EXTRAS_ID:"bex",KINDLE_BOOK_EXTRAS_CONTAINER_ID:"KindleBookExtrasContainer"},w="KindleIFrame",x,n,q,t,v,c,z;return{open:function(c){x=new $.Deferred;t=c;BexBrowserHost=new BexK4WBrowserHost({},{onBookExtrasReady:h,closeBookExtras:j,openStoreFromBex:o,logMetric:r,logBexStatus:g});q=setTimeout(function(){x.reject();e()},15E3);a(Kindle.BOOKEXTRAS.BEX_URL+t+"?ua=4");KindleHostDeviceDetector.isiOS()&&"onorientationchange"in window&&$(n).bind("orientationchange",
BexBrowserHost.onOrientationChanged);return x.promise()},setBookExtrasStoreOpenCallback:function(a){c=a},setBookExtrasClosedCallback:function(c){v=c},setBookExtrasLogMetricCallback:function(c){z=c}}}(),KindleBuildInfo=function(){function a(a,j,o){var r=$.Deferred();$.getJSON(e,Math.floor(Math.random()*1E9),function(g){g=g[a];o(g)?r.resolve(g):r.reject(j)}).error(function(){r.reject(j)});return r.promise()}var e="./offline/build_info.uncached.js";return{getCurrentTotalAppcacheFileCount:function(){return a("filecount",
-1,function(a){return typeof a==="number"&&a>1})}}}(),Kindle={VERSION:{MAJOR:9,MINOR:9,PATCH:9},ERROR:{OUT_OF_SPACE:"OutOfSpace",UNKNOWN_DB_ERROR:"UnknownDBError",TIMEOUT:"timeout",LOAD_FAILURE:"LoadFailure",REMOVE_FAILURE:"RemoveFailure",REMOVE_NETWORK_FAILURE:"RemoveNetworkFailure",CONTENT_LOANED:"ContentLoaned",CONTENT_LOAN_ENDED:"ContentLoanEnded",CONTENT_LICENSE_EXCEEDED:"ContentLicenseExceeded",CONTENT_UNSUPPORTED:"ContentUnsupported",CONTENT_RENTAL_EXPIRED:"ContentRentalExpired",SESSION_LIMIT_EXCEEDED:"SessionLimitExceeded",
BOOK_NOT_AVAILABLE:"BookNotAvailable",STORE_NOT_AVAILABLE:"StoreNotAvailable",BOOKEXTRAS_OPEN_FAILED:"BookExtrasFailed",BOOKEXTRAS_NO_CACHE_ERROR:"BookExtrasCacheFailed",STORE_OPEN_FAILED:"StoreOpenFailed",STORE_OPEN_OFFLINE_FAILED:"StoreOpenOfflineFailed",SYNC_FAILED:"SyncFailed",SYNC_FAILED_OFFLINE:"SyncFailedOffline",NOT_IMPLEMENTED:"NotImplemented",NETWORK:"Network",CANCELLED:"cancelled",CONTENT_UPGRADE:"ContentUpgrade",PINNED_CONTENT_UPGRADE:"PinnedContentUpgrade",LIBRARY_LOAD_FAILED:"LibraryLoadFailed",
UNKNOWN_ERR:"unknown"},BookInfo:{CachedState:{PARTIAL:"partial",CACHED:"cached",PINNING:"pinnning",PINNED:"pinned",FULLY_DOWNLOADED:["cached","pinned"],MAYBE_DOWNLOADED:["partial","cached","pinning","pinned"],isFullyDownloaded:function(a){return Kindle.BookInfo.CachedState.FULLY_DOWNLOADED.indexOf(a)>=0},isMaybeDownloaded:function(a){return Kindle.BookInfo.CachedState.MAYBE_DOWNLOADED.indexOf(a)>=0}}},Service:{},App:{LOGGED_IN:"logged_in",BYPASS_LANDING_PAGE_STORAGE:"bypass_landing_page",HAVE_RUN:"haveRun",
LIBRARY_FAIL_FLAG:"lf"},DB:{NEVER:-1,UNKNOWN_ERR:0,DATABASE_ERR:1,VERSION_ERR:2,TOO_LARGE_ERR:3,QUOTA_ERR:4,SYNTAX_ERR:5,CONSTRAINT_ERR:6,TIMEOUT_ERR:7,TEXT_TYPE:1,NUMBER_TYPE:2,OBJECT_TYPE:4,ALLOW_NULL:8,PRIMARY_KEY:16,AUTO_INCREMENT:32,PIECE_ID_TYPE:64,SECONDARY_KEY:128,OPERATOR:"operator",VALUES:"values",NOT_EQUAL:"notEqual",IN_ARRAY:"inArray",INSERT_LIST_OPERATION:"insertList",UPDATE_RECORD_OPERATION:"updateRecord",UPSERT_RECORD_OPERATION:"upsertRecord",DELETE_RECORD_OPERATION:"deleteRecord",
GET_RECORD_OPERATION:"getRecord",CREATE_TABLE_OPERATION:"createTable"},STORE:{OPEN_STORE:"open_store",GENERIC_ERROR:"generic_error",OFFLINE_ERROR:"offline_error"},APP_CACHE:{CACHE_PROGRESS:"cacheProgress",CACHE_CACHED:"cacheCached",CACHE_DONE:"cacheDone",CACHE_NEEDS_RETRY:"cacheNeedsRetry",CACHE_NEEDS_BROWSER_RESTART:"cacheNeedsBrowserRestart"},BOOKEXTRAS:{OPEN_BEX:"open_book_extras",BEX_LOCAL_STORAGE:"bex.data.",GENERIC_ERROR:"generic_error",BEX_URL:"https://bookextras.amazon.com/bookextras/",BEX_ISAVAILABLE:1,
BEX_CACHED:2,APP_CACHED:"book_extras_cached"}};Kindle.VERSION.toString=function(){return this.MAJOR+"."+this.MINOR+"."+this.PATCH};Kindle.VERSION.MAJOR=1;Kindle.VERSION.MINOR=2;Kindle.VERSION.PATCH=0;
var KindleMetricsManager=function(){function a(){q.length>0&&p().insertList(q).done(function(){q=[]})}function e(c){var k;if(c){k=[];for(var f in c)k.push(c[f])}return k}function h(c,k){var f={};f[l.FIELD_METHOD]=c;f[l.FIELD_TIMER_START]=(new Date).getTime();k&&(typeof k==="string"&&(k=[k]),f[l.FIELD_BREAK_DOWN]=k);t++;v[t]=f;return t}function j(c,k){var f;if((f=v[c])&&f[l.FIELD_TIMER_START]){f[l.FIELD_TIME]=(new Date).getTime()-f[l.FIELD_TIMER_START];delete f[l.FIELD_TIMER_START];if(k){var m,b;if(b=
f[l.FIELD_SUB_TIMERS])for(m in b);if(b=f[l.FIELD_SUB_COUNTERS])for(m in b);f=(new jQuery.Deferred).resolve().promise()}else{if(m=f[l.FIELD_SUB_TIMERS])for(b in m);f[l.FIELD_SUB_TIMERS]=e(f[l.FIELD_SUB_TIMERS]);f[l.FIELD_SUB_COUNTERS]=e(f[l.FIELD_SUB_COUNTERS]);n?f=p().insertRecord(f):(q.push(f),f=(new jQuery.Deferred).resolve().promise())}delete v[c]}else f=(new jQuery.Deferred).reject().promise();return f}function o(c,k,f){var m=v[c];(c=m[l.FIELD_SUB_COUNTERS])||(c=m[l.FIELD_SUB_COUNTERS]={});m=
c[k];m||(m=c[k]={},m[l.FIELD_NAME]=k,m[l.FIELD_COUNT]=0,f&&(typeof f==="string"&&(f=[f]),m[l.FIELD_BREAK_DOWN]=f));return m}function r(a){var k=new jQuery.Deferred;KindleHostDeviceDetector.isOnline()?c(z.devicePlatform,z.clientName,z.version,z.breakdownDeclarations,a).then(function(f){f.Output.metricProcessCount&&f.Output.metricProcessCount>0?k.resolve():k.reject()},function(){k.reject()}):k.reject();return k.promise()}function g(){var c,k=new jQuery.Deferred;if(KindleHostDeviceDetector.isOnline()){if(!p())return k.reject(),
k.promise();p().batchTransaction([{operation:Kindle.DB.GET_RECORD_OPERATION,tableName:w,params:[]},{operation:Kindle.DB.DELETE_RECORD_OPERATION,tableName:w,params:[]}]).done(function(f){if(f[0]&&f[0].length>0){c=f[0];for(f=0;f<c.length;f++){var m=c[f];if(m.breakDown)m.breakdown=m.breakDown,delete m.breakDown}r(c).done(k.resolve).fail(function(){p().insertList(c);k.reject()})}}).fail(function(){k.reject()})}else k.reject();return k.promise()}function p(){return x?x.getAppDb().getTable(w):null}var w=
"metrics",x=null,n=!1,q=[],t=0,v={},c,z,l={FIELD_METHOD:"method",FIELD_NAME:"name",FIELD_TIME:"time",FIELD_SUB_TIMERS:"timers",FIELD_SUB_COUNTERS:"counters",FIELD_BREAK_DOWN:"breakDown",FIELD_TIMER_START:"timerStart",FIELD_COUNT:"count",FIELD_VALUE:"value"},u={BREAK_DOWN_OS:"OS",BREAK_DOWN_ENGINE:"Engine",BREAK_DOWN_VERSION:"Version",BREAK_DOWN_BROWSER:"Browser"};return{OS:u.BREAK_DOWN_OS,BROWSER:u.BREAK_DOWN_BROWSER,ENGINE:u.BREAK_DOWN_ENGINE,VERSION:u.BREAK_DOWN_VERSION,ALL:function(){var c=[],
k;for(k in u)c.push(u[k]);return c}(),initialize:function(v){c=v;z={version:"1.0",clientName:"K4W",devicePlatform:KindleHostDeviceDetector.getDevicePlatform(),breakdownDeclarations:{Version:Kindle.VERSION.toString(),Browser:KindleUserAgentMetricsInfo.browserWithVersionString()}};KindleModuleManager.getModule(KindleModuleManager.DB_CLIENT).done(function(c){x=c;n=!0;a();setInterval(g,3E5)}).fail(function(){})},modifyMetricsMethod:function(c,k){v[c]&&(v[c][l.FIELD_METHOD]=k)},startMetrics:h,endMetrics:j,
cancelMetrics:function(c){delete v[c]},addEvent:function(c,k){var f=h(c,k);return j(f,!1)},sendEvent:function(c,k){var f={};f[l.FIELD_METHOD]=c;f[l.FIELD_TIME]=0;k&&(typeof k==="string"&&(k=[k]),f[l.FIELD_BREAK_DOWN]=k);return r([f])},startSubTimer:function(c,k,f){var m=v[c];(c=m[l.FIELD_SUB_TIMERS])||(c=m[l.FIELD_SUB_TIMERS]={});m=c[k];m||(m=c[k]={},m[l.FIELD_NAME]=k,m[l.FIELD_COUNT]=0,m[l.FIELD_TIME]=0,f&&(typeof f==="string"&&(f=[f]),m[l.FIELD_BREAK_DOWN]=f));m[l.FIELD_TIMER_START]||(m[l.FIELD_TIMER_START]=
(new Date).getTime())},endSubTimer:function(c,k){var f=v[c][l.FIELD_SUB_TIMERS][k];f[l.FIELD_TIMER_START]!==void 0&&(f[l.FIELD_COUNT]+=1,f[l.FIELD_TIME]+=(new Date).getTime()-f[l.FIELD_TIMER_START],delete f[l.FIELD_TIMER_START])},setSubCounter:function(c,k,f,m){c=o(c,k,m);typeof f==="undefined"&&(f=1);c[l.FIELD_COUNT]=f},increaseSubCounter:function(c,k,f,m){c=o(c,k,m);typeof f==="undefined"&&(f=1);c[l.FIELD_COUNT]+=f},uploadMetrics:g}}(),KindleRegistrationHandler=function(){function a(a){var j=e;
j+="?openid.assoc_handle=amzn_kweb";j+="&openid.return_to="+encodeURIComponent(a);j+="&openid.mode=logout";j+="&openid.ns=http%3A%2F%2Fspecs.openid.net%2Fauth%2F2.0";return j}var e="https://www.amazon.com/ap/signin";return{register:function(){var a=window,j=KindleURL.getBaseURL(),o=e;o+="?openid.assoc_handle=amzn_kweb";o+="&openid.return_to="+encodeURIComponent(j);o+="&openid.mode=checkid_setup";o+="&openid.ns=http%3A%2F%2Fspecs.openid.net%2Fauth%2F2.0";o+="&openid.identity=";o+="http%3A%2F%2Fspecs.openid.net%2Fauth%2F2.0%2Fidentifier_select";
o+="&openid.claimed_id=";o+="http%3A%2F%2Fspecs.openid.net%2Fauth%2F2.0%2Fidentifier_select";(j=KindleURL.getSiteState())&&(o+="&"+j);a.location=o},deregister:function(e,j){function o(){var a=new jQuery.Deferred;KindleModuleManager.getModule(KindleModuleManager.JOURNAL_MANAGER).then(function(c){c.uploadJournal().then(a.resolve,a.resolve)});return a.promise()}function r(){var a=new jQuery.Deferred;t.getAppDb().getPinnedSessionIds().done(function(c){KindleModuleManager.getModuleSync(KindleModuleManager.SERVICE_CLIENT).deregisterSessions(c).then(a.resolve,
a.reject)});return a.promise()}function g(){function a(){n.uploadMetrics().then(w,w)}q.then(a,a)}function p(){x.reject()}function w(){function v(){var c=$(document.createElement("iframe")).attr("id","iframe_reauth").attr("src",a("")).attr("style","display:none");$("body").append(c)}if(j)KindleLocalStorage.localStorageObject.clear(),v(),t.clear(function(){var c=KindleURL.getLandingPageURL();window.location=a(c)},function(){});else{KindleLocalStorage.localStorageObject.removeItem(Kindle.App.BYPASS_LANDING_PAGE_STORAGE);
KindleLocalStorage.localStorageObject.removeItem(Kindle.App.LOGGED_IN);KindleLocalStorage.localStorageObject.removeItem(Kindle.App.LIBRARY_FAIL_FLAG);t.getAppDb().clearDeviceToken();var c=KindleURL.getLandingPageURL();window.location=a(c)}x.resolve()}var x=new jQuery.Deferred,n=KindleModuleManager.getModuleSync(KindleModuleManager.METRICS_MANAGER),q;q=$.when(n.addEvent("Library::SignOut"),j?n.addEvent("Library::SignOut:Intentional"):n.addEvent("Library::SignOut:Unintentional"));var t=KindleModuleManager.getModuleSync(KindleModuleManager.DB_CLIENT);
e?w():$.when(o(),r()).then(g,p);return x.promise()}}}(),KindleStreamingReaderClient=function(){function a(){var b=$.cookie("session-id"),d=encodeURI(z+"getDeviceToken?serialNumber=A2CTZ977SKFQZY"),c=new jQuery.Deferred;w(d,b,function(b,d,A){b.deviceSessionToken?c.resolve(b):c.reject(A,"failed");f.addEvent("Service::GetDeviceTokenCall")},function(b,d,A){f.sendEvent("Service::GetDeviceTokenCallFail");c.reject(b,d,A)});return c.promise()}function e(b){b=b?"?lastSyncTime="+encodeURIComponent(b):"";return c+
"getOwnedContent"+b}function h(b){var d=c+"startReading?asin="+b.asin;d+=b.basePath?"&basePath="+b.basePath:"";d+=b.useNewPath?"&useNewPath="+b.useNewPath:"";d+=b.useProdBucket?"&useProdBucket="+b.useProdBucket:"";d+=b.kindleSessionId?"&kindleSessionId="+b.kindleSessionId:"";d+=b.contentVersion?"&contentVersion="+b.contentVersion:"";d+=b.formatVersion?"&formatVersion="+b.formatVersion:"";d+=b.isSample!==void 0?"&isSample="+(b.isSample?"true":"false"):"";return encodeURI(d)}function j(b){var d=c+"getFileUrl?asin="+
b.asin+"&contentVersion="+b.contentVersion+"&formatVersion="+b.formatVersion;d+=b.kindleSessionId?"&kindleSessionId="+b.kindleSessionId:"";d+=b.isSample?"&isSample="+b.isSample:"";d+=b.skeletonIds?"&skeletonIds="+b.skeletonIds.join(","):"";d+=b.fragmentIds?"&fragmentIds="+b.fragmentIds.join(","):"";d+=b.glyphIds?"&glyphIds="+b.glyphIds.join(","):"";d+=b.basePath?"&basePath="+b.basePath:"";d+=b.useNewPath?"&useNewPath="+b.useNewPath:"";d+=b.useProdBucket?"&useProdBucket="+b.useProdBucket:"";return encodeURI(d)}
function o(b,d){var f=c+b+"?asin="+d.asin+"&kindleSessionId="+d.kindleSessionId;return d.position&&d.position>0?(f+="&lastPageRead="+d.position+"&localTimeOffset="+d.localTimeOffset+"&countryCode="+d.countryCode,f+"&guid="+encodeURIComponent(d.guid)):encodeURI(f)}function r(b){b=u+"?sessions="+b.join();return encodeURI(b)}function g(b,d,f){function c(){var E=[];E[v]=x;$.ajax({url:b,dataType:"json",beforeSend:function(b){b.setRequestHeader("X-ADP-Session-Token",s);return!0},success:d,error:function(b,
d,E){b.status!==v&&(d!=="timeout"&&a-- >0?(setTimeout(c,A),A*=2):f(b,d,E))},statusCode:E})}var a=1,A=50;n(c,f)}function p(b,d,f,c){n(function(){var a=[];a[v]=x;a={url:b,type:"POST",dataType:"json",processData:!1,contentType:"application/json",data:JSON.stringify(d),beforeSend:function(b){b.setRequestHeader("X-ADP-Session-Token",s);return!0},success:f,error:function(b,d,f){b.status!==v&&c(b,d,f)},statusCode:a};$.ajax(a)},c)}function w(b,d,f,c){var a=[];a[v]=x;$.ajax({url:b,dataType:"json",beforeSend:function(b){b.setRequestHeader("x-amzn-sessionid",
d);return!0},success:f,error:function(b,d,f){b.status!==v&&c(b,d,f)},statusCode:a})}function x(){s!==void 0?KindleModuleManager.getModuleSync(KindleModuleManager.APP_REGISTRATION).deregister(!0):KindleModuleManager.getModuleSync(KindleModuleManager.APP_REGISTRATION).register()}function n(b,d){function f(b,c,a){k=s=null;t().clearDeviceToken();t().clearEID();d(b,c,a)}function c(){a().then(function(d){s=d.deviceSessionToken;k=d.clientHashId;jQuery.when(t().setDeviceToken(d.deviceSessionToken),t().setEID(d.eid)).then(b,
f)},f)}function m(d){s=d;b()}function A(){if(KindleLegacyDeviceTokenStorage.hasDeviceTokenFromStorage()){var d=KindleLegacyDeviceTokenStorage.getDeviceTokenFromStorage();s=d;t().setDeviceToken(d).then(b,f);KindleLegacyDeviceTokenStorage.clearDeviceTokenFromStorage()}else c()}s?b():t().getDeviceToken().then(m,A)}function q(){if(s){var b=KindleMetricsProfiler("checkToken");t().getDeviceToken().done(function(b){b!==s&&KindleModuleManager.getModuleSync(KindleModuleManager.APP_REGISTRATION).register()}).fail(function(){KindleModuleManager.getModuleSync(KindleModuleManager.APP_REGISTRATION).register()});
b.endTimer();b.log()}}function t(){return m.getAppDb()}var v=403,c="/service/web/reader/",z="/service/web/register/",l=c+"setOfflineStatus/",u=c+"deregisterSessions/",s,k,f,m;$.ajaxSetup({timeout:6E4});return{getBookKeyUrl:function(b,d,f){n(function(){var f=encodeURI("/service/web/cdn/images/"+b.asin+"/"+b.contentVersion+"/"+b.formatVersion+"/spacer.png"),c=encodeURIComponent(s);d(f+"?adpSessionToken="+c)},f)},getFileUrl:function(b){var b=j(b),d=new jQuery.Deferred;q();g(b,d.resolve,function(b,c,
a){d.reject(b,c,a);f.sendEvent("Service::GetFileUrlCallFail")});return d.promise()},stillReading:function(b){var b=o("stillReading",b),d=new jQuery.Deferred;q();g(b,d.resolve,function(b,c,a){d.reject(b,c,a);f.sendEvent("Service::StillReadingCallFail")});return d.promise()},setOfflineStatus:function(b){var b=encodeURI(l+"?asin="+b.asin+"&kindleSessionId="+b.kindleSessionId+"&offline="+(b.isOffline?"true":"false")),d=new jQuery.Deferred;g(b,function(b,c,a){d.resolve(b,c,a);f.addEvent("Service::SetOfflineStatusCall")},
function(b,c,a){d.reject(b,c,a);f.sendEvent("Service::SetOfflineStatusCallFail")});return d.promise()},deregisterSessions:function(b){var b=r(b),d=new jQuery.Deferred;g(b,function(b,c,a){f.addEvent("Service::DeregisterSessionsCall");d.resolve(b,c,a)},function(b,c,a){f.sendEvent("Service::DeregisterSessionsCallFail");d.reject(b,c,a)});return d.promise()},doneReading:function(b){var b=o("doneReading",b),d=new jQuery.Deferred;g(b,function(b,c,a){d.resolve(b,c,a);f.addEvent("Service::DoneReadingCall")},
function(b,c,a){d.reject(b,c,a);f.sendEvent("Service::DoneReadingCallFail")});return d.promise()},getOwnedContent:function(b){var b=e(b),d=new jQuery.Deferred;q();g(b,function(b,c,a){d.resolve(b,c,a);f.addEvent("Service::GetOwnedContentCall")},function(b,c,a){d.reject(b,c,a);f.sendEvent("Service::GetOwnedContentCallFail")});return d.promise()},startReading:function(b){var b=h(b),d=new jQuery.Deferred;q();g(b,function(b,c,a){d.resolve(b,c,a);f.addEvent("Service::StartReadingServiceCall")},function(b,
c,a){d.reject(b,c,a);f.sendEvent("Service::StartReadingServiceCallFail")});return d.promise()},getLPR:function(b,d){var a=c+"getLPR?asin="+encodeURIComponent(b)+"&guid="+encodeURIComponent(d),m=new jQuery.Deferred;g(a,function(b,d,c){m.resolve(b,d,c);f.addEvent("Service::GetLPRCall")},function(b,d,c){m.reject(b,d,c);f.sendEvent("Service::GetLPRCallFail")});return m.promise()},getAnnotations:function(b,d){var a=c+"getAnnotations?asin="+encodeURIComponent(b)+"&guid="+encodeURIComponent(d),m=new jQuery.Deferred;
g(a,function(b,d,c){m.resolve(b,d,c);f.addEvent("Service::GetAnnotationsCall")},function(b,d,c){m.reject(b,d,c);f.sendEvent("Service::GetAnnotationsCallFail")});return m.promise()},updateAnnotations:function(b,d){var a=encodeURI(c+"updateAnnotations"),m={Operation:"updateAnnotations",Input:{annotations:b,localTimeOffset:d}},k=new jQuery.Deferred;q();p(a,m,function(b,d,c){k.resolve(b,d,c);f.addEvent("Service::UpdateAnnotationsCall")},function(b,d,c){k.reject(b,d,c);f.sendEvent("Service::UpdateAnnotationsCallFail")});
return k.promise()},uploadMetrics:function(b,d,f,a,m){var A=encodeURI(c+"uploadMetrics"),b={Operation:"uploadMetrics",Input:{devicePlatform:b,clientName:d,version:f,metricBreakdown:a,metrics:m}},d=new jQuery.Deferred;p(A,b,d.resolve,d.reject);return d.promise()},checkTokenConsistency:q,checkClientHashAndDeleteDBIfNeeded:function(){function b(){KindleLocalStorage.localStorageObject.setItem(Kindle.App.BYPASS_LANDING_PAGE_STORAGE,"true");KindleModuleManager.getModuleSync(KindleModuleManager.APP_REGISTRATION).register();
f.resolve()}function d(){f.reject()}var f=new jQuery.Deferred;if(!k)return t().clearDeviceToken(),t().clearEID(),KindleModuleManager.getModuleSync(KindleModuleManager.APP_REGISTRATION).register(),f.reject(),f.promise();KindleLocalStorage.localStorageObject.setItem(Kindle.App.LOGGED_IN,"1");t().getClientHashId().done(function(c){k!==c?(KindleLocalStorage.localStorageObject.clear(),m.clear(b,d)):f.resolve()}).fail(function(){t().setClientHashId(k);f.resolve()});return f.promise()},getEID:function(){var b=
new jQuery.Deferred;t().getEID().then(b.resolve,function(){a().then(function(d){t().setEID(d.eid).then(b.resolve(d.eid),b.reject(d.eid))},function(){f.sendEvent("Service::GetEIDTokenCallFail");b.reject()})});return b.promise()},initialize:function(){var b=this,d=new jQuery.Deferred;KindleModuleManager.getModuleList([KindleModuleManager.METRICS_MANAGER,KindleModuleManager.DB_CLIENT]).then(function(c){f=c[KindleModuleManager.METRICS_MANAGER];m=c[KindleModuleManager.DB_CLIENT];n(function(){d.resolve(b)},
d.reject)});return d.promise()}}}(),KindleTOS=function(){function a(){var b="https://images-na.ssl-images-amazon.com/images/G/01/kindle/kindlefortheweb/store/"+m+"/BrowserHost-min.js",d=$.Deferred();$.getScript(b,function(){typeof BrowserHostAPI!=="undefined"?d.resolve():d.reject()});return d.promise()}function e(){var b=new jQuery.Deferred,d={w:$(window).width(),h:$(window).height(),dpi:null,osv:null,deviceType:v,bhv:m};KindleModuleManager.getModule([KindleModuleManager.SERVICE_CLIENT]).then(function(f){f.getEID().then(function(f){d.eid=
f;b.resolve("?"+$.param(d))},function(){KindleDebug.error("Couldn't fetch EID.");b.reject("?"+$.param(d))})},function(){KindleDebug.error("SRS not loaded");b.reject("?"+$.param(d))});return b.promise()}function h(){function b(d){var c=s?"&asin="+encodeURIComponent(s):"",d=f+d+c+"&ref_="+(s?"kcr_store_sample":k?"kcr_store_emptylib_ipad":"kcr_store_libbutton_ipad");n&&$("#"+q.KINDLE_STORE_CONTAINER_ID).addClass("hidden").empty();c=new Date;n=$(document.createElement("iframe")).attr("id",q.KINDLE_STORE_ID+
c.getTime()).attr("src",d).addClass(t);$("#"+q.KINDLE_STORE_CONTAINER_ID).append(n)}e().then(b,b)}function j(){$("#"+q.KINDLE_STORE_CONTAINER_ID).addClass("hidden").empty();y=n=null;C=!0;d&&d()}function o(){u||(u=$.Deferred(),typeof BrowserHostAPI!=="undefined"?u.resolve():a().then(function(){BrowserHost=new K4WBrowserHost({hostVersion:c,deviceType:v},{pageReady:r,closeStore:g,openBook:p,bookStatus:w,openInExternalBrowser:x});u.resolve()},u.reject));return u.promise()}function r(){clearTimeout(z);
$("#"+q.KINDLE_STORE_CONTAINER_ID).removeClass("hidden");l.resolve(!1)}function g(){j()}function p(f){if(C){C=!1;var c=f.type,f=f.asin;if(b)switch(c){case D.EBOOK:b({asin:f,isSample:!1});j();break;case D.SAMPLE:b({asin:f,isSample:!0}),y=f,$("#"+q.KINDLE_STORE_CONTAINER_ID).hide(),d&&d()}}}function w(b){return{id:b,status:1,percentDownloaded:1}}function x(b){clearTimeout(z);l.resolve(!0);var d=document.createElement("a");d.href=b;d.target="_blank";b=document.createEvent("MouseEvents");b.initEvent("click",
!0,!0);d.dispatchEvent(b)}var n,q={KINDLE_STORE_ID:"store",KINDLE_STORE_CONTAINER_ID:"KindleStoreContainer"},t="KindleIFrame",v="A2CTZ977SKFQZY",c=3,z,l,u,s,k,f="https://www.amazon.com/gp/kindle/kcp/tos.html",m="015",b,d,y,C=!0,D={EBOOK:"EBOK",SAMPLE:"EBSP"};return{open:function(b,d){l=$.Deferred();s=b;k=d;if(s&&s===y&&n)return $("#"+q.KINDLE_STORE_CONTAINER_ID).show(),l.resolve(!1),l.promise();o().then(function(){z=setTimeout(function(){l.reject();j()},3E4);h()},l.reject);return l.promise()},setOpenBookCallback:function(d){b=
d},setStoreClosedCallback:function(b){d=b},setOpenBookReady:function(){C=!0},setStoreURL:function(b){f=b}}}(),KindleURL=function(){function a(a){for(var g={},a=a.split("&"),e=0;e<a.length;e++){var n;n=a[e].split("=");var h=n[0],j="";n.length>1&&(j=n[1]);n={key:h,value:j};if(n.key)g[n.key]=n.value}return g}function e(a){var g="";a.indexOf("?")===0&&a.length>1&&(g+=a.substring(1));return g}function h(a){var g="";a&&(g+="?"+a);return g}function j(a){var g=r();g[a]&&delete g[a];a=$.param(g);a=h(a);o(a)}
function o(a){a=window.location.protocol+"//"+window.location.hostname+window.location.port+window.location.pathname+a+window.location.hash;window.history.replaceState&&window.history.replaceState(document.title,document.title,a)}function r(){var g={},w=window.location.search;w&&(g=e(w),g=a(g));return g}var g=["basePath","useNewPath","key","bucket","version","maxDBSize","useProdBucket","clear","asin","lnd"];return{normalizeQueryString:function(){var p=r(),w=p.siteState;if(w){var w=decodeURIComponent(w),
w=e(w),w=a(w),j;for(j in w)p[j]=w[j]}for(var n in p)g.indexOf(n)>-1||delete p[n];p=$.param(p);p=h(p);o(p)},removeQueryParameter:j,removeASIN:function(){j("asin")},getQueryParameters:r,getBaseURL:function(){return window.location.protocol+"//"+window.location.hostname+window.location.port+window.location.pathname},getLandingPageURL:function(){return window.location.protocol+"//"+window.location.hostname+window.location.port+"/about"},getSiteState:function(){var a="",g=window.location.search;g&&(g=
encodeURIComponent(g),a+="siteState="+g);return a}}}();BexBrowserHostSerializer={postObjectToHost:function(a,e){window.parent.postMessage({method:a,param:e},"*")},postObjectToBookExtras:function(a,e){var h={method:a,param:e};$('iframe[id^="bex"]')[0].contentWindow.postMessage(h,"*")},receiveMessage:function(a){if(a.origin.match(/\.amazon\.com:?\d*$/)&&BexBrowserHost[a.data.method])BexBrowserHost[a.data.method](a.data.param)}};
window.addEventListener("message",BexBrowserHostSerializer.receiveMessage,!1);
BexK4WBrowserHost=function(){return function(a,e){this.onBookExtrasReady=function(){e.onBookExtrasReady()};this.closeBookExtras=function(){e.closeBookExtras()};this.openStoreFromBex=function(a){e.openStoreFromBex(a)};this.logMetric=function(a){e.logMetric(a)};this.logBexStatus=function(a){e.logBexStatus(a)};this.onOrientationChanged=function(){setTimeout(function(){BexBrowserHostSerializer.postObjectToBookExtras("onOrientationChanged",{screenWidth:window.top.innerWidth,screenHeight:window.top.innerHeight})},
500)}}}();
BexBrowserHost=function(){return function(){this.pageReady=function(){BexBrowserHostSerializer.postObjectToHost("onBookExtrasReady")};this.closeBookExtras=function(){BexBrowserHostSerializer.postObjectToHost("closeBookExtras")};this.openStoreFromBex=function(a){BexBrowserHostSerializer.postObjectToHost("openStoreFromBex",a)};this.logMetric=function(a){BexBrowserHostSerializer.postObjectToHost("logMetric",a)};this.logBexStatus=function(a){BexBrowserHostSerializer.postObjectToHost("logBexStatus",a)};
this.onOrientationChanged=function(){}}}();function KindleAssert(){}
var KindleDebug=function(){return{error:function(){},log:function(){},warn:function(){},saveLogs:function(){saveLog=!0}}}(),KindleHostDeviceDetector=function(){function a(){return navigator.platform.indexOf("iPad")!==-1}function e(){return navigator.platform.indexOf("iPhone")!==-1||navigator.platform.indexOf("iPod")!==-1}function h(){return navigator.userAgent.indexOf("Cloud9")!==-1}function j(){return"standalone"in navigator&&navigator.standalone}function o(){return window.chrome&&window.top.chrome.app&&
window.top.chrome.app.isInstalled}function r(){return navigator.userAgent.indexOf("PlayBook")!==-1}return{isiOS:function(){return a()||e()||r()||h()},isiPad:a,isiPad1:function(){return a()&&KindleHostPadDetector.isPad1(j())},isiPhone:e,isiOS_4x:function(){return(a()||e())&&navigator.userAgent.indexOf("OS 4")!==-1},isiOS_5x:function(){return(a()||e())&&navigator.userAgent.indexOf("OS 5")!==-1},isFirefox:function(){return navigator.userAgent.indexOf("Firefox")!==-1},isSafari:function(){return navigator.userAgent.indexOf("Safari")!==
-1},isIE:function(){return navigator.userAgent.indexOf("MSIE")!==-1},isPlayBook:r,isCloud9:h,isOnline:function(){return navigator.onLine},isChrome:function(){return window.chrome},isiOSAppMode:j,isChromeApp:o,isInAppMode:function(){return j()||o()},isCookieEnabled:function(){return navigator.cookieEnabled},isLocalStorageEnabled:function(){if(KindleLocalStorage.localStorageObject===null)return!1;try{KindleLocalStorage.localStorageObject.setItem("testLocalStorage","1"),KindleLocalStorage.localStorageObject.removeItem("testLocalStorage")}catch(a){return!1}return!0},
isWebSQLSupported:function(){return!!window.openDatabase},isIndexedDBSupported:function(){return!!window.mozIndexedDB||!!window.webkitIndexedDB},getDevicePlatform:function(){return a()?"iPad":e()?"iPhone":r()?"playBook":h()?"otter":"desktop"}}}(),KindleHostPadDetector=function(){return{isPad1:function(a){if(KindleLocalStorage.localStorageObject.getItem("definitelyNotPad1"))return!1;var e=0,h=1E3,j=0,o;for(i=0;i<3;i++)o=SunSpiderBenchmark.get3DSpeed(),o>e?e=o:o<h&&(h=o),j+=o;e=j/3;if(e>=200&&a)return!0;
if(e>=100&&!a)return!0;KindleLocalStorage.localStorageObject.setItem("definitelyNotPad1","true");return!1}}}();
function KindleInterfacesFactory(){function a(a,h){for(var j in h)if(h.hasOwnProperty(j)&&typeof a[j]!==typeof h[j])return!1;return!0}return{IKindleLibrary:{onReaderOpenStatus:function(){},onReaderClose:function(){},onStoreOpenStatus:function(){},libraryUpdateNeeded:function(){}},IKindleReader:{openBook:function(){},unloadReader:function(){},onStoreOpenStatus:function(){},onBookExtrasOpenStatus:function(){},pauseReader:function(){},resumeReader:function(){}},IKindleAppForLibrary:{openStore:function(){},
openBook:function(){},onLibraryLoaded:function(){},getQueryParameters:function(){}},IKindleAppForReader:{onReaderReady:function(){},closeReader:function(){},onStartReadingStatus:function(){},onRendererLoaded:function(){},openBookExtras:function(){},openStore:function(){}},checkImplements:a,assertImplements:function(e,h){KindleAssert(a(e,h),"Object fails to provide all properties of interface prototype")}}}
var KindleInterfaces=KindleInterfacesFactory(),KindlJournalManager=function(){function a(a){var g=[],e;for(e in a){var j=a[e].entry;j&&g.push(j)}return g}function e(a){var g=[],e;for(e in a)g.push({entry:a[e]});return r.getAppDb().getTable(o).insertList(g)}function h(a){var e=new jQuery.Deferred;g.updateAnnotations(a,KindleLocale.getLocalTimeOffset()).then(function(a){(a=a.Output.validAnnotations)&&a>0?e.resolve():e.reject()},function(){e.reject()});return e.promise()}function j(){var g=new jQuery.Deferred;
r.getAppDb().getTable(o).getRecord().then(function(e){function j(){r.getAppDb().deleteJournalEntries(e).then(g.resolve,g.reject)}var n=a(e);n.length>0?h(n).then(j,g.reject):g.resolve()},g.reject);return g.promise()}var o="journal",r=null,g=null;return{initialize:function(){var a=new jQuery.Deferred,e=this;KindleModuleManager.getModuleList([KindleModuleManager.SERVICE_CLIENT,KindleModuleManager.DB_CLIENT]).then(function(j){g=j[KindleModuleManager.SERVICE_CLIENT];r=j[KindleModuleManager.DB_CLIENT];
a.resolve(e)},a.reject);return a.promise()},saveToJournal:function(a){var g=new jQuery.Deferred;e(a).then(function(){j().then(g.resolve,g.resolve)},g.reject);return g.promise()},uploadJournal:j}}(),KindleLegacyDeviceTokenStorage=function(){return{hasDeviceTokenFromStorage:function(){return KindleLocalStorage.localStorageObject.getItem("kindleDeviceToken")!==null},getDeviceTokenFromStorage:function(){return KindleLocalStorage.localStorageObject.getItem("kindleDeviceToken")},setDeviceToken:function(a){KindleLocalStorage.localStorageObject.setItem("kindleDeviceToken",
a)},clearDeviceTokenFromStorage:function(){KindleLocalStorage.localStorageObject.removeItem("kindleDeviceToken")}}}(),KindleLocalStorage=function(){var a=null;if("localStorage"in window&&window.localStorage!==null&&window.localStorage)a=window.localStorage;return{localStorageObject:a}}(),KindleLocale=function(){var a=-(new Date).getTimezoneOffset();return{getLocalTimeOffset:function(){return a},getCountryCode:function(){return"US"}}}(),KindleMetricsProfiler=function(a){function e(a){for(var e=0,h=
0;h<a.length;h+=1)e+=a[h].end-a[h].start;return e}var h={};h.name=a;h.counters=null;h.subTimers=null;h.runs=[{start:(new Date).getTime(),end:null}];h.endTimer=function(){var a=this.runs[this.runs.length-1];if(a.end===null)a.end=(new Date).getTime()};h.addCount=function(a,e){if(this.counters===null)this.counters={};this.counters[a]===void 0?this.counters[a]=e:this.counters[a]+=e};h.createSubTimer=function(a){if(this.subTimers===null)this.subTimers={};this.subTimers[a]===void 0?this.subTimers[a]=KindleMetricsProfiler(a):
this.subTimers[a].runs.push({start:(new Date).getTime(),end:null});return this.subTimers[a]};h.log=function(){this.logAsPercentageOfTime("",e(this.runs))};h.logAsPercentageOfTime=function(a,h){var r=a+":"+this.name,g;e(this.runs);for(g in this.counters);for(g in this.subTimers)this.subTimers[g].logAsPercentageOfTime(r,h)};return h};
function KindleModuleManagerFactory(){function a(a,c){if(q[a])throw"Duplicate registration of module "+a;if(!c)throw"Module is not initialized with an object "+a;q[a]=c;t[a].resolve(c)}function e(a){if(q.hasOwnProperty(a))throw"Duplicate registration of module "+a;q[a]=void 0}function h(g,c){t[g]||(t[g]=new jQuery.Deferred);a(g,c)}function j(g,c){e(g);t[g]||(t[g]=new jQuery.Deferred);c(t[g]);t[g].done(function(c){a(g,c)})}function o(a){t[a]||(t[a]=new jQuery.Deferred);return t[a].promise()}function r(a){if(!q[a])throw"Trying to get uninitialized module "+
a;return q[a]}function g(a,c){q[a]=c}function p(a){var c=q[a];return{done:function(a){a(c)},fail:function(){},when:function(a){a(c)}}}function w(a){for(var c={},g=0;g<a.length;g++)c[name]=q[a];return{done:function(a){a(c)},fail:function(){},when:function(a){a(c)}}}function x(){q={}}var n={CONSTANTS:"Constants",APPCACHE_EVENTHANDLER:"appcache_eventHandler",DB_CLIENT:"DBClient",METRICS_MANAGER:"metrics_manager",SERVICE_CLIENT:"ServiceClient",APP_REGISTRATION:"Registration",JOURNAL_MANAGER:"JournalManager",
BOOK_METADATA:"book_metaData",BOOK_FRAGMAP:"book_fragmap"},q={},t={};return{CONSTANTS:n.CONSTANTS,DB_CLIENT:n.DB_CLIENT,METRICS_MANAGER:n.METRICS_MANAGER,SERVICE_CLIENT:n.SERVICE_CLIENT,APP_REGISTRATION:n.APP_REGISTRATION,JOURNAL_MANAGER:n.JOURNAL_MANAGER,BOOK_METADATA:n.BOOK_METADATA,BOOK_FRAGMAP:n.BOOK_FRAGMAP,ERROR_CODE_CANCEL:"canceled",registerModule:h,registerModuleList:function(a){for(var c in a)h(c,a[c])},registerModuleWithInitializer:j,registerModuleWithDeferred:function(a,c){j(a,function(a){c.done(a.resolve).fail(a.reject)})},
detachModule:function(a){var c=q[a],g=t[a];g&&!g.isResolved()&&g.reject("canceled");delete q[a];delete t[a];return c},getModule:o,getModuleList:function(a){var c=new jQuery.Deferred,g,l=[];for(g=0;g<a.length;g++)l.push(o(a[g]));$.when.apply($,l).done(function(){var g,l={};for(g=0;g<a.length;g++)l[a[g]]=arguments[g];c.resolve(l)}).fail(c.reject);return c.promise()},getModuleSync:r,isModuleInitialized:function(a){return q[a]!==void 0},isModuleRegistered:function(a){return q.hasOwnProperty(a)},switchToTestMode:function(){this.registerModuleTest=
g;this.getModule=p;this.getModuleSync=r;this.getModuleList=w;this.clear=x;delete this.registerModuleWithDeferred;delete this.registerModuleWithInitializer}}}
var KindleModuleManager=KindleModuleManagerFactory(),KindleRemoteClient=function(){return{getStoreURL:function(){var a=new jQuery.Deferred;$.get("/remote/store").then(function(e){(e=e.url)?a.resolve(e):a.reject()},a.reject);return a.promise()},uploadFeedback:function(a){var e={DevicePlatform:KindleHostDeviceDetector.getDevicePlatform(),UserAgent:navigator.userAgent,WindowHeight:window.innerHeight,WindowWidth:window.innerWidth},a={version:KindleVersion.getDisplayableVersion(),message:a,info:e},a={url:"/remote/feedback",
type:"POST",processData:!1,contentType:"application/json",data:JSON.stringify(a)};return $.ajax(a)}}}(),KindleUserAgentMetricsInfo=function(){var a,e,h,j,o,r={chrome:14,firefox:7,safari:5,ie:9,ios:4};return{browserWithVersionString:function(){if(!a){e=GoogleUserAgent.browserName.toLowerCase();h=GoogleUserAgent.browserVersionString.toLowerCase();var g;["ipad","iphone"].indexOf(e)!==-1&&((g=/CPU OS ([0-9_]+) /.exec(navigator.userAgent))&&g.length>=2&&(h=g[1]),osName=e="ios");a:{if(g=h){var p=/^0*([1-9]+)/.exec(g);
if(p&&p.length>=2){j=parseInt(p[1],10);break a}else KindleDebug.error("Bad regex on versionString: "+g)}j=void 0}"undefined"===typeof j?o="other":r[e]?(g=r[e],p=g+3,o=j<g?[e,"old"].join("@"):j>=p?[e,"new"].join("@"):[e,j].join("@")):o="other";a=!0}return o}}}(),KindleVersion=function(){var a=null;return{getVersion:function(){return"010200011"},getDisplayableVersion:function(){if(!a){var e=parseInt("010200011".slice(0,2),10),h=parseInt("010200011".slice(2,4),10),j=parseInt("010200011".slice(4,6),10),
o=parseInt("010200011".slice(6),10);a=e;a+=".";a+=h;a+=".";a+=j;a+=".";a+=o}return a}}}(),debugLib=function(){function a(a){var c=window.location.href;local=c.slice(0,c.indexOf("/",7));a="[\\?&]"+a.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]")+"=([^&#?]*)";a=RegExp(a).exec(window.location.href);return a===null?null:a[1]}function e(a){var c="";c+=t===!0||t==="true"?"<span style='color:"+o[a[1]]+"'>":"<span style='color:black'>";q===!0&&(c+="<i>// "+a[0]+"</i><br/>");for(var e=a[2];e>0;)c+="-----",e--;
for(e=3;e<a.length;e++)c+=a[e],c+=" ";c+="</span><br/>";g.document.write(c)}var h=null,j=!1,o=["black","#8B0000","#A0522D","#DAA520","green","blue","purple","gray","#708090","#BC8F8F","pink"],r=null,g=null,p=!1,w=[],x=9,n=!0,q=!1,t=!1;return{DEBUG_MESSAGES:void 0,DEBUG_BOXES:void 0,DEBUG_OVERLAY:h,debugMap:function(a,c,g,l,e,s){if(p){if(!j)j=!0,r=a.contentDocument.getElementsByTagName("body")[0],h=document.createElement("DIV"),h.id="pixelDisplay",h.style.top=r.offsetTop+"px",h.style.left=r.offsetLeft+
"px",h.style.width=r.offsetWidth+"px",h.style.height=r.offsetHeight+"px",h.style.position="absolute",r.appendChild(h);a="blue";switch("ALL"){case "YP":a="red";break;case "BLOCKQUOTE":a="white";break;case "DIV":a="red";break;case "YA":a="red";break;case "IMG":a="green";break;case "SUPAN":a="blue";break;case "TAUBLE":a="purple";break;case "TUR":a="teal";break;case "UB":a="pink"}var k=document.createElement("DIV");k.title="Nid: "+l+", starting %: "+e+", # lines: "+s+", top:"+c+", height:"+g;k.style.top=
c+"px";$(k).css("height",g+"px");$(k).css("font-size","0px");k.style.left=r.offsetLeft+"px";k.style.width=r.offsetWidth+"px";k.style.position="absolute";k.style.backgroundColor=a;k.style.opacity=".4";k.style.filter="alpha(opacity=40)";h.appendChild(k)}},resetMap:function(){j=!1},initialize:function(){var e=a("type"),c=a("level");t=a("code");p=Boolean(a("box"));c&&(x=c);e&&(w=e.split(","),g||(e=new Date,g=window.open("","debugLog","width=1000,height=800,scrollbars=yes"),g.document.write("<html>"),
g.document.write("<title>DEBUG LOG</title>"),g.document.write("<body>"),g.document.write("<div id='logChrome' style='width:100%; height:50px; tex-align:center'>"),g.document.write("<br/>"),g.document.write("   <div style='position:absolute; color:black; left:0px; float:left;'>========================== DEBUG "+e+"==========================</div>"),g.document.write("</div>"),g.document.write("</body>"),g.document.write("</html>")),g.focus(),w.length===1?(e=w[0].toUpperCase(),e==="ALL"||e==="*"?q=n=
!0:(q=n=!1,g.document.write("<span style='color:black'>"),g.document.write("//DEBUG: <i>"+e+"</i><br/>"),g.document.write("</span>"))):w.length>1&&(n=!1,q=!0))},debug:function(){var a=arguments;if(!(w.length<1))if(n&&a[1]<=x)e(a);else try{for(var c=a[0].toUpperCase(),g=0;g<w.length;g++){var l=w[g].toUpperCase();c===l&&a[1]<=x&&e(a)}}catch(h){c="";for(g=0;g<a.length;g++)c+="ARG "+g+": ",c+=a[g].toString(),c+=", ";e(["DEBUG ERROR",1,0,"Invalid Debug Statement:",c])}},debugMsg:function(){}}}();debugLib.initialize();
var KindleAppDb=function(a){function e(){return KindleModuleManager.getModuleSync(KindleModuleManager.DB_CLIENT).getBookDb()}function h(a){var e=new jQuery.Deferred;r.getRecord("keyValue",{key:a}).then(function(a){a&&a.length>0&&e.resolve(a[0].value);e.reject()},e.reject);return e.promise()}function j(a,e){return r.upsertRecord("keyValue",{value:e},{key:a})}function o(a){return r.deleteRecord("keyValue",{key:a})}var r=a;a.updateBookData=function(a,h,j,o,n){function q(a){if(a.length<1||!e())return(new jQuery.Deferred).resolve().promise();
var c=new jQuery.Deferred;e().deleteBooksData(a).then(c.resolve,c.resolve);return c.promise()}var t,v,c=[],z=[];for(t in a)z.push(a[t].asin),c.push({operation:Kindle.DB.DELETE_RECORD_OPERATION,tableName:"bookdata",params:[{asin:a[t].asin}]});for(t in h)a=h[t],c.push({operation:Kindle.DB.UPSERT_RECORD_OPERATION,tableName:"bookdata",params:[a,{asin:a.asin}]});v=c.length;c.push({operation:Kindle.DB.UPSERT_RECORD_OPERATION,tableName:"keyValue",params:[{value:String(j)},{key:"synctime"}]});r.batchTransaction(c).done(function(){q(z).done(function(){o(v)})}).fail(n)};
a.getAllBooks=function(a){r.getRecord("bookdata").done(a)};a.getBook=function(a,e){r.getRecord("bookdata",{asin:a}).done(function(a){e(a.length>0?a[0]:{})})};a.getBookDataLastSyncTime=function(a){h("synctime").done(function(e){a(e?e:Kindle.DB.NEVER)}).fail(function(){a(Kindle.DB.NEVER)})};a.updateLastPositionRead=function(a,e,h,j){r.updateRecord("bookdata",{lastPositionRead:e,lastTimeRead:h},{asin:a}).fail(j)};a.updateLastFPRSyncTime=function(a,e,h){r.updateRecord("bookdata",{lastFPRSyncTime:e},{asin:a}).fail(h)};
a.updateLastReadTime=function(a,e,h,j){r.upsertRecord("bookdata",{lastTimeRead:e,lastFPRSyncTime:h},{asin:a}).fail(j)};a.updateMaxPosition=function(a,e,h){r.updateRecord("bookdata",{maxPosition:e},{asin:a}).fail(h)};a.getBookExtras=function(a,e){var h=KindleLocalStorage.localStorageObject.getItem(Kindle.BOOKEXTRAS.BEX_LOCAL_STORAGE+a),h=[{isAvailable:parseInt(h,10),asin:a}];e(h)};a.updateBookExtras=function(a,e){KindleLocalStorage.localStorageObject.setItem(Kindle.BOOKEXTRAS.BEX_LOCAL_STORAGE+a,e)};
a.getDeviceToken=function(){return h("kindleDeviceToken")};a.setDeviceToken=function(a){return j("kindleDeviceToken",a)};a.clearDeviceToken=function(){return o("kindleDeviceToken")};a.getClientHashId=function(){return h("kindleUserHashId")};a.setClientHashId=function(a){return j("kindleUserHashId",a)};a.clearClientHashId=function(){return o("kindleUserHashId")};a.getEID=function(){return h("eid")};a.setEID=function(a){return j("eid",a)};a.clearEID=function(){return o("eid")};a.getValueForKey=h;a.setValueForKey=
j;a.removeValueForKey=o;a.getCachedAsins=function(a){function h(e){var n,q=[];for(n=0;n<e.length;n++)a.indexOf(e[n].cacheState)>=0&&q.push(e[n]);j.resolve(q)}var j=new jQuery.Deferred;e()?e().getRecord("bookinfo",null,{asin:!0,cacheState:!0,cachedSize:!0}).then(a?h:j.resolve,j.reject):j.resolve([]);return j.promise()};a.getCachedCovers=function(){function a(e){var g,j={};for(g=0;g<e.length;g++)j[e[g].asin]=e[g].coverData;h.resolve(j)}var h=new jQuery.Deferred;e()?e().getRecord("covers",null).then(a,
h.reject):a([]);return h.promise()};a.getBookCachedState=function(a){return e()?e().getRecord("bookinfo",{asin:a},{cacheState:!0}):(a=new jQuery.Deferred,a.resolve([]),a.promise())};a.getPinnedSessionIds=function(){function a(e){var g,h=[];if(e)for(g=0;g<e.length;g++)h.push(e[g].context.kindleSessionId);j.resolve(h)}function h(){j.resolve([])}var j=new jQuery.Deferred;e()?e().getRecord("bookinfo",{cacheState:Kindle.BookInfo.CachedState.PINNED},{context:!0}).then(a,h):j.resolve([]);return j.promise()};
return a},KindleBookDb=function(a){function e(){switch(KindleHostDeviceDetector.getDevicePlatform()){case "iPad":case "iPhone":case "playBook":return 5E7;case "desktop":return 5E8;default:return 5E8}}function h(a,f){var c={},b;for(b in a)a.hasOwnProperty(b)&&!f[b]&&(c[b]=a[b]);c=JSON.stringify(c);return c==="{}"?"":c}function j(a,f){if(f){var c=JSON.parse(f),b;for(b in c)c.hasOwnProperty(b)&&(a[b]=c[b])}return a}function o(a,f,c,b,d,e){var g=(new Date).getTime();u.getRecord(a,{asin:c,id:{operator:Kindle.DB.IN_ARRAY,
values:b}}).then(function(a){f(a,g,d)},function(a){e(a)})}function r(a,f,c,b,d,e){(new Date).getTime();var g=0,l,A=[],E;for(E in b)l=f(c,b[E]),g+=l.size,A.push(l);u.insertList(a,A).then(function(){(new Date).getTime();d(g)},function(a){e(a)})}function g(a,f,c,b){var d=KindleMetricsProfiler("getIds:"+a);u.getPieceIds(a,f).then(function(a){d.addCount(f,a.length);d.endTimer();d.log();c(a)},function(a){b(a)})}function p(a,f,c){(new Date).getTime();var f=[],b=0,d;for(d in a){var e=a[d],g=e.id;b+=e.piece.length+
e.metadata.length;f[g]=j({fragmentData:e.piece,fragmentMetadata:JSON.parse(e.metadata)},e.other)}(new Date).getTime();c(f);(new Date).getTime()}function w(a,c){var e=c.fragmentData,b=JSON.stringify(c.fragmentMetadata),d=h(c,{fragmentData:1,fragmentMetadata:1});return{asin:a,id:c.fragmentMetadata.id,size:e.length+b.length+d.length,piece:e,metadata:b,other:d}}function x(a,c,e){(new Date).getTime();var c=[],b;for(b in a){var d=a[b];c[d.id]=j({skeletonData:d.piece,skeletonMetadata:JSON.parse(d.metadata)},
d.other)}(new Date).getTime();e(c)}function n(a,c){var e=c.skeletonData,b=JSON.stringify(c.skeletonMetadata),d=h(c,{skeletonData:1,skeletonMetadata:1});return{asin:a,id:c.skeletonMetadata.id,size:e.length+b.length+d.length,piece:e,metadata:b,other:d}}function q(a,c,e){(new Date).getTime();var c=[],b=0,d;for(d in a){var g=a[d],l=g.id;b+=g.piece.length+g.metadata.length;c[l]=j({glyphData:JSON.parse(g.piece),glyphFragmentMetadata:JSON.parse(g.metadata)},g.other)}(new Date).getTime();e(c);(new Date).getTime()}
function t(a,c){var e=JSON.stringify(c.glyphData),b=JSON.stringify(c.glyphFragmentMetadata),d=h(c,{glyphData:1,glyphFragmentMetadata:1});return{asin:a,id:c.glyphFragmentMetadata.id,size:e.length+b.length+d.length,piece:e,metadata:b,other:d}}function v(a){return u.dbDeleteBooksData(a)}function c(a){return u.dbGetBookStatistics(a)}function z(){var a=new jQuery.Deferred;u.getRecord("bookinfo",{cacheState:Kindle.BookInfo.CachedState.PINNED},{cachedSize:!0}).then(function(c){var e=0,b;for(b in c)e+=c[b].cachedSize;
a.resolve(e)},function(){a.reject()});return a.promise()}function l(){var a=new jQuery.Deferred;z().then(function(c){c=e()-1E6-c*2.4;c=Math.round(c/2.4);a.resolve(c)},function(){a.resolve(0)});return a.promise()}var u=a,s=null;a.deleteBooksData=v;a.deleteOtherBooksData=function(a){for(var c=new jQuery.Deferred,e=["fragments","glyphs","skeleton","bookinfo","annotationsCache","covers"],b=[],d=0;d<e.length;d++)b.push({operation:Kindle.DB.DELETE_RECORD_OPERATION,tableName:e[d],params:[{asin:{operator:Kindle.DB.NOT_EQUAL,
values:[a]}}]});u.batchTransaction(b).then(function(){c.resolve()},function(a){c.reject(a)});return c.promise()};a.deleteOldestBookData=function(a){function c(){s.resolve(arguments);s=null}function e(){s.reject(arguments);s=null}function b(a){var b=a[0].asin,g=a[0].openTime,l;for(l=1;l<a.length;l++)if(a[l].openTime<g)g=a[l].openTime,b=a[l].asin;v([b]).then(c,e)}s||(s=new jQuery.Deferred,u.getOldBookList(a).then(b,e));return s};a.getBookStatistics=c;a.BookInfoDB=function(a){function f(){var a=new jQuery.Deferred;
l().then(function(c){b=c;a.resolve(c)},function(){b=0;a.resolve()});return a.promise()}var e=0,b=0;return{getFragments:function(b){var c=new jQuery.Deferred;o("fragments",p,a,b,c.resolve,c.reject);return c.promise()},putFragments:function(b){var c=new jQuery.Deferred;r("fragments",w,a,b,function(a){e+=a;c.resolve(a)},c.reject);return c.promise()},getFragmentIds:function(){var b=new jQuery.Deferred;g("fragments",a,b.resolve,b.reject);return b.promise()},getSkeleton:function(b){var c=new jQuery.Deferred;
o("skeleton",x,a,b,c.resolve,c.reject);return c.promise()},putSkeletons:function(b){var c=new jQuery.Deferred;r("skeleton",n,a,b,function(a){e+=a;c.resolve(a)},c.reject);return c.promise()},getGlyphs:function(b){var c=new jQuery.Deferred;o("glyphs",q,a,b,c.resolve,c.reject);return c.promise()},putGlyphs:function(b){var c=new jQuery.Deferred;r("glyphs",t,a,b,function(a){e+=a;c.resolve(a)},c.reject);return c.promise()},getGlyphIds:function(){var b=new jQuery.Deferred;g("glyphs",a,b.resolve,b.reject);
return b.promise()},getBookInfo:function(){var b=new jQuery.Deferred;u.getRecord("bookinfo",{asin:a}).then(function(a){a.length===1?(e=a[0].cachedSize,b.resolve(a[0])):b.reject()},b.reject);return b.promise()},insertBookInfo:function(b){b=$.extend(!0,{},b,{asin:a,openTime:(new Date).getTime()});return u.insertRecord("bookinfo",b)},updateBookCacheState:function(b){return u.updateRecord("bookinfo",{cacheState:b},{asin:a})},savePinningFinishState:function(b,c){return u.batchTransaction([{operation:Kindle.DB.UPDATE_RECORD_OPERATION,
tableName:"bookinfo",params:[{cacheState:b},{asin:a}]},{operation:Kindle.DB.UPDATE_RECORD_OPERATION,tableName:"bookinfo",params:[{context:c,openTime:(new Date).getTime()},{asin:a}]}])},updateBookContext:function(b){return u.updateRecord("bookinfo",{context:b,openTime:(new Date).getTime()},{asin:a})},getBookStatistics:function(){var b=new jQuery.Deferred;c(a).then(function(c){c.totalSize!==c.cachedSize?(e=c.cachedSize=c.totalSize,u.updateRecord("bookinfo",{cachedSize:e},{asin:a}).then(function(){b.resolve(c)},
b.reject)):b.resolve(c)},b.reject);return b.promise()},getCacheQuota:function(){return{cachedSize:e,cacheQuota:b}},computeCacheQuota:function(){return f().promise()}}};return a},KindleDBClient=function(){function a(){if(!u)throw{name:"databaseInitializationError",message:"Please call initialize function first"};}function e(a){var b=new jQuery.Deferred;a.wrapper?a.wrapper.dropTables().then(b.resolve,b.reject):b.resolve();return b.promise()}function h(a){if(s)return s.promise();s=new jQuery.Deferred;
A.initDfd=new jQuery.Deferred;var b=KindleStubDBWrapper(d);q(!1);b.createTables(y,A.version).then(function(){g(b);KindleAppDb(b);A.wrapper=b;A.initDfd.resolve(b);m=k=b;u=!0;s.resolve(a)},function(a){s.reject(a)});return s.promise()}function j(){function a(){++g===e&&(m=null,KindleStubDBWrapper(d).dropTables(),c.resolve())}function b(f){return function(b){var d=[],e;for(e in b)d.push({operation:Kindle.DB.UPSERT_RECORD_OPERATION,tableName:f,params:[b[e],b[e]]});k.batchTransaction(d).then(a,c.reject)}}
var c=new jQuery.Deferred;if(!m)return c.resolve(),c.promise();var f=m.getTableNames(),e=f.length,g=0,A;for(A in f)m.getRecord(f[A]).then(b(f[A]),c.reject);return c.promise()}function o(a){var b=new jQuery.Deferred,c,f,d;c=window.mozIndexedDB?mozIndexedDB.open(a.shortName):webkitIndexedDB.open(a.shortName);c.onsuccess=function(e){if(d!==void 0)b.resolve(d,f);else if(f=e.target.result,d=KindleIDBWrapper(f),d.createTableInfos(a.tables)||c.abort(),c.onupgradeneeded===void 0&&Number(f.version)!==Number(a.version)){var g=
f.setVersion(a.version||"1.0");g.onerror=b.reject;g.onsuccess=function(){d.createDataStores(a.tables)?b.resolve(d,f):g.abort()}}else b.resolve(d,f)};c.onerror=function(a){b.reject(a)};if(c.onupgradeneeded!==void 0)c.onupgradeneeded=function(b){b.oldVersion===0&&b.newVersion===1?(f=b.target.result,d=KindleIDBWrapper(f),d.createTableInfos(a.tables)||c.abort(),d.createDataStores(a.tables)||c.abort()):c.abort()};return b.promise()}function r(a){var c=new jQuery.Deferred,f=a.defaultSize;b!==void 0&&f>
b*1E6&&(f=b*1E6);a=openDatabase(a.shortName,a.version,a.displayName,f);c.resolve(a);return c.promise()}function g(a){function b(c){return{tableName:c,insertRecord:function(b){return a.insertRecord(c,b)},insertList:function(b){return a.insertList(c,b)},updateRecord:function(b,f){return a.updateRecord(c,b,f)},getRecord:function(b,f){return a.getRecord(c,b,f)},deleteRecord:function(b){return a.deleteRecord(c,b)},batchTransaction:function(b){var f;for(f=0;f<b.length;f++)b[f].tableName=c;return a.batchTransaction(b)}}}
var c=a.getTableNames(),f,d;for(d in c)f=c[d],D[f]=b(f);a.getTable=function(a){return D[a]}}function p(){function a(){g(c);KindleAppDb(c);A.wrapper=c;A.initDfd.resolve(c)}var b,c={};if(!A.initDfd)A.initDfd=new jQuery.Deferred,KindleHostDeviceDetector.isWebSQLSupported()?r(A).then(function(f){b=f;c=KindleSqlWrapper(b);c.createTables(y,A.version).then(a,A.initDfd.reject);KindleLocalStorage.localStorageObject.setItem("haveDB","1")},A.initDfd.reject):KindleHostDeviceDetector.isIndexedDBSupported()?o(A).then(function(b,
f){function d(){KindleModuleManager.getModuleSync(KindleModuleManager.APP_REGISTRATION).register()}KindleLocalStorage.localStorageObject.setItem("haveDB","1");f.onversionchange=function(a){a.version==="0"&&(f.close(),setTimeout(d,500))};c=b;a()},A.initDfd.reject):h(this);return A.initDfd.promise()}function w(){function a(){g(c);KindleBookDb(c);E.wrapper=c;E.initDfd.resolve(c)}var b,c={};if(!E.initDfd){E.initDfd=new jQuery.Deferred;try{KindleHostDeviceDetector.isWebSQLSupported()?r(E).then(function(f){b=
f;c=KindleSqlWrapper(b);c.createTables(C,E.version).then(a,E.initDfd.reject)},E.initDfd.reject):KindleHostDeviceDetector.isIndexedDBSupported()&&o(E).then(function(b){c=b;a()},E.initDfd.reject)}catch(f){E.initDfd.reject()}}return E.initDfd.promise()}function x(){if(KindleHostDeviceDetector.isChromeApp())return!0;if(KindleHostDeviceDetector.isFirefox()&&KindleLocalStorage.localStorageObject.getItem("haveDB"))return!0;var a=KindleLocalStorage.localStorageObject.getItem("booksdb");if(a==="true")return!0;
else if(a==="false")return!1}function n(){return!KindleHostDeviceDetector.isWebSQLSupported()&&!KindleHostDeviceDetector.isIndexedDBSupported()?!1:KindleHostDeviceDetector.isChrome()&&!KindleHostDeviceDetector.isChromeApp()?!1:!0}function q(a){KindleLocalStorage.localStorageObject.setItem("booksdb",a?"true":"false")}function t(){var a;a=new jQuery.Deferred;if(f)return a.resolve(f),a.promise();if(!n())return a.reject(),a.promise();E.initDfd=null;w().then(function(b){f=b;q(!0);a.resolve(f)},function(){q(!1);
a.reject()});return a.promise()}function v(){var a;a=new jQuery.Deferred;if(k&&k!==m)return a.resolve(k).promise();A.initDfd=null;p().then(function(b){k=b;a.resolve(k)},function(){a.reject()});return a.promise()}function c(a){function b(){k=m;KindleLocalStorage.localStorageObject.removeItem("haveDB");f.reject()}function c(){t().then(function(){j().then(function(){m=null;KindleLocalStorage.localStorageObject.removeItem(d);f.resolve(a)},b)},b)}var f;return(KindleHostDeviceDetector.isFirefox()?KindleLocalStorage.localStorageObject.getItem("haveDB"):
1)?t():(f=new jQuery.Deferred,v().then(c,b),f.promise())}function z(a){function b(c,d){k=c;f=d;u=!0;l.resolve(a)}function c(b){KindleHostDeviceDetector.isFirefox()?(KindleLocalStorage.localStorageObject.removeItem("haveDB"),h(a).done(l.resolve)):l.reject(b)}var d,e;l||(l=new jQuery.Deferred,(KindleHostDeviceDetector.isFirefox()?KindleLocalStorage.localStorageObject.getItem("haveDB"):1)?(d=p(),e=x()?w():(new jQuery.Deferred).resolve(null).promise(),$.when(d,e).then(b,c)):h(a).done(l.resolve));return l.promise()}
var l=null,u=!1,s=null,k=null,f=null,m=null,b=void 0,d="app_db_storage",y={bookdata:{asin:17,title:9,authors:12,purchaseDate:10,maxPosition:10,lastTimeRead:10,lastPositionRead:10,lastFPRSyncTime:10},keyValue:{key:17,value:9},metrics:{method:1,time:2,timers:12,counters:12,breakDown:12},journal:{id:32,entry:4}},C={bookinfo:{asin:17,cacheState:129,cachedSize:10,openTime:2,context:4,metadata:4,fragmap:4},skeleton:{asin:17,id:82,size:2,piece:1,metadata:1,other:1},fragments:{asin:17,id:82,size:2,piece:1,
metadata:1,other:1},glyphs:{asin:17,id:82,size:2,piece:1,metadata:1,other:1},annotationsCache:{asin:17,annotationsData:4},covers:{asin:17,coverData:1}},D={},A={shortName:"K4W",version:"1.0",displayName:"Kindle Cloud Reader",defaultSize:5E6,initDfd:null,wrapper:null,tables:y},E={shortName:"K4Wbooks",version:"1.0",displayName:"Kindle Cloud Reader Books",defaultSize:5E7,initDfd:null,wrapper:null,tables:C};return{setMaxDbSize:function(a){b=a},initialize:function(){return z(this)},enableFullDb:function(){return c(this)},
getAppDb:function(){a();return k},getBookDb:function(){a();return f},bookDbPossible:n,bookDbEnabled:x,setBookDbDisabled:function(){q(!1)},persistDB:function(){k&&k.persist&&k.persist();f&&f.persist&&f.persist()},clear:function(a,b){function c(){A.wrapper=null;k=A.initDfd=null;E.wrapper=null;m=f=E.initDfd=null;u=!1;s=_initializeFullDeferred=null;a()}e(A).then(function(){e(E).then(c,b)},b)}}}();
function KindleIDBWrapper(a){function e(a){if(!C[a])throw{name:"databaseAccessError",message:"Trying to access undefined table "+a};}function h(){var a=[],b;for(b in C)a.push(b);return a}function j(a,c,f){if(C[a].info[c]&Kindle.DB.PIECE_ID_TYPE){for(a=""+f;a.length<b;)a="0"+a;return a}else return f}function o(a,b){if(a&&b){e(b);var c=C[b],f="";if(c.genKeyPath)for(var c=c.keyList,d=0;d<c.length;++d){if(a[c[d]]===void 0){f=void 0;break}f+=j(b,c[d],a[c[d]]);d<c.length-1&&(f+=m)}else f=a[c.keyPath];return f}}
function r(a,b,c){for(var f="",d,e,g=0;g<b.length;++g){d=b[g];e=c[d];if(!e)break;e=e.hasOwnProperty(Kindle.DB.OPERATOR)?e[Kindle.DB.VALUES][0]:e;f+=j(a,d,e);g<b.length-1&&(f+=m)}return f}function g(a,b,c){var f="",d,e,g;for(g=0;g<b.length;++g){e=b[g];d=c[e];if(!d)throw{name:"CreateUpperBoundException",message:"Need at least the root primary key to create an upper bound"};if(d.hasOwnProperty(Kindle.DB.OPERATOR)){var l=d[Kindle.DB.VALUES][d[Kindle.DB.VALUES].length-1];if(typeof l==="number")d=d[Kindle.DB.VALUES][d[Kindle.DB.VALUES].length-
1];else if(typeof l==="string")d=l;else throw{name:"InvalidKeyException",message:"Tried to generate a lowerbound key with invalid keys"};}f+=j(a,e,d);g<b.length-1&&(f+=m)}return f}function p(a,b,c){var f=new jQuery.Deferred,d=new jQuery.Deferred,e=$.makeArray(a),c=y.transaction(e,c);c.oncomplete=function(){d.then(f.resolve,f.reject)};c.onerror=f.reject;c.onabort=function(){f.reject({code:Kindle.DB.QUOTA_ERR,message:"Assumed QUOTA_ERR"})};b(c,a,d);return f.promise()}function w(a,b){if(C[b]===void 0)return Kindle.DB.CONSTRAINT_ERR;
var c={autoIncrement:C[b].autoInc};if(!c.autoIncrement&&!C[b].genKeyPath)c.keyPath=C[b].keyPath;var c=a.createObjectStore(b,c),f,d;for(d in C[b].indexes)f=C[b].indexes[d],c.createIndex(f.name,f.keyPath,{unique:f.unique});return null}function x(a,b,c){function f(){++d===e&&h.resolve(s)}var d=0,e=c.length,g=C[b].tableInfo,m=C[b].keyPath,l=C[b].genKeyPath,k=C[b].autoInc,h=new jQuery.Deferred,j,s=[],y;for(y in c){for(var u in c[y])j=g[u],j&Kindle.DB.TEXT_TYPE?c[y][u]=typeof c[y][u]==="string"?c[y][u]:
String(c[y][u]):j&Kindle.DB.NUMBER_TYPE&&(c[y][u]=typeof c[y][u]==="number"?c[y][u]:Number(c[y][u]));!k&&!c[y][m]?(j=l?o(c[y],b):m,j=a.put(c[y],j)):j=k?a.add(c[y]):a.put(c[y]);j.onsuccess=f;j.onerror=h.reject;s.push(c[y])}return h.promise()}function n(a,b){if(!a||!b)throw{name:"databaseInsertError",message:"Tried to insert with an empty table name or empty object list"};e(a);return p(a,function(a,c,f){a=a.objectStore(c);x(a,c,b).then(f.resolve,f.reject)},IDBTransaction.READ_WRITE)}function q(a,b,
c){function f(a,b){return a-b}e(b);var d=c?$.extend(!0,{},c):c,m,l=C[b].tableInfo,k=C[b].keyPath,c=C[b].keyList,h=C[b].autoInc,j=new jQuery.Deferred,y=!1,u;if(d)for(var s in d){var n=d[s];if(n){var z=l[s],n=n.hasOwnProperty(Kindle.DB.OPERATOR);if(z&Kindle.DB.TEXT_TYPE)if(n){for(var q in d[s][Kindle.DB.VALUES])z=d[s][Kindle.DB.VALUES][q],d[s][Kindle.DB.VALUES][q]=typeof z==="string"?z:String(z);d[s][Kindle.DB.VALUES].sort()}else typeof d[s]!=="string"&&(d[s]=String(d[s]));else if(z&Kindle.DB.NUMBER_TYPE)if(n){for(var t in d[s][Kindle.DB.VALUES])z=
d[s][Kindle.DB.VALUES][t],d[s][Kindle.DB.VALUES][t]=typeof z==="number"?z:Number(z);d[s][Kindle.DB.VALUES].sort(f)}else typeof d[s]!=="number"&&(d[s]=Number(d[s]));!y&&n&&(y=!0)}}!y&&d&&(d[k]?m=d[k]:h||(m=o(d,b)));if(m)u=a.get(m),u.onsuccess=function(a){(a=a.target.result)?j.resolve([a]):j.resolve([])},u.onerror=j.reject;else{var v=[],p;if(d){m=!0;for(var w in c)if(!d[c[w]]){m=!1;break}if(m)m=r(b,c,d),b=g(b,c,d),b=IDBKeyRange.bound(m,b,!1,!1),u=a.openCursor(b);else{w={};for(var x in c)if(d[c[x]]){p=
c[x];w[p]=d[p];break}if(!p){for(var D in d)if(d[D].hasOwnProperty(Kindle.DB.OPERATOR)){p=D;w[D]=d[D];break}p||(p=Object.keys(d)[0])}w[p]&&w[p].hasOwnProperty(Kindle.DB.OPERATOR)?(m=r(b,[p],w),b=g(b,[p],w),b=IDBKeyRange.bound(m,b,!1,!1)):b=IDBKeyRange.only(d[p]);try{u=a.index(p).openCursor(b)}catch(S){u=a.openCursor()}}}else u=a.openCursor();u.onerror=j.reject;u.onsuccess=function(a){var a=a.target.result,b=!0;if(a){for(var c in d){var f=d[c];if(f){if(f.hasOwnProperty(Kindle.DB.OPERATOR))switch(b=
$.inArray(a.value[c],f[Kindle.DB.VALUES])!==-1,f[Kindle.DB.OPERATOR]){case Kindle.DB.NOT_EQUAL:b=!b}else f!==a.value[c]&&(b=!1);if(!b)break}}b&&v.push(a.value);a["continue"]()}else j.resolve(v)}}return j.promise()}function t(a,b,c){var d=c[0],c=c[1],f=new jQuery.Deferred;q(a,b,c).then(function(c){if(c.length>0){for(var e in c)c[e]=$.extend(c[e],d);x(a,b,c).then(f.resolve,f.reject)}else f.resolve(c)},f.reject);return f.promise()}function v(a,b,c){return p(a,function(a,f,d){a=a.objectStore(f);t(a,f,
[b,c]).then(d.resolve,d.reject)},IDBTransaction.READ_WRITE)}function c(a,b,c){var f=new jQuery.Deferred;t(a,b,c).then(function(d){d.length===0?(c[0]=$.extend(c[0],c[1]),x(a,b,[c[0]]).then(f.resolve,f.reject)):f.resolve(d)},f.reject);return f.promise()}function z(a,b,c){return q(a,b,c[0])}function l(a,b,c){function f(c){function g(){return function(){++m===c.length&&d.resolve()}}var m=0;if(c.length===0)d.resolve();else for(var l in c){var k=o(c[l],b);e=a["delete"](k);e.onsuccess=g(k,c[l]);e.onerror=
d.reject}}var c=c[0],d=new jQuery.Deferred,e;c?q(a,b,c).then(f,d.reject):(e=a.clear(),e.onsuccess=d.resolve,e.onerror=d.reject);return d.promise()}function u(a){for(var b=new jQuery.Deferred,c=y.transaction(a,IDBTransaction.READ_WRITE),d=0;d<a.length;d++)c.objectStore(a[d]).clear().onerror=b.reject;c.oncomplete=b.resolve;c.onabort=b.reject;c.onerror=b.reject;return b.promise()}function s(){return k(function(a){return a.value})}function k(a){return p("bookinfo",function(b,c,d){var f=[],b=b.objectStore(c).openCursor();
b.onsuccess=function(b){b=b.target.result;if(b===void 0)d.resolve(f);else{var c=a(b);c&&f.push(c);b["continue"]()}};b.onerror=d.reject},IDBTransaction.READ_ONLY)}function f(a){function b(a){l.reject(a)}function c(a){l.reject(a)}function f(a){a=a.target.result;a!==void 0&&(a["delete"](),a["continue"]())}function e(){}var g=h(),m,l,k,j,s,u,n,z;l=new jQuery.Deferred;u=y.transaction(g,IDBTransaction.READ_WRITE);u.oncomplete=function(){l.resolve()};u.onerror=b;u.onabort=b;for(k=0;k<a.length;++k){j=a[k];
s=o({asin:j,id:0},"skeleton");z=o({asin:j,id:d},"skeleton");z=IDBKeyRange.bound(s,z);for(s=0;s<g.length;s++)m=C[g[s]],n=u.objectStore(g[s]),m.genKeyPath?(m=n.openCursor(z),m.onsuccess=f):(m=n["delete"](j),m.onsuccess=e),m.onerror=c}return l.promise()}var m=String.fromCharCode(31),b=8,d="99999999",y=a,C={},D={};D[Kindle.DB.INSERT_LIST_OPERATION]=x;D[Kindle.DB.UPDATE_RECORD_OPERATION]=t;D[Kindle.DB.UPSERT_RECORD_OPERATION]=c;D[Kindle.DB.DELETE_RECORD_OPERATION]=l;D[Kindle.DB.GET_RECORD_OPERATION]=z;
D[Kindle.DB.CREATE_TABLE_OPERATION]=w;return{createTableInfos:function(a){var b,c;for(c in a){b=c;var d=!0,f=!1,e=void 0,g=[],l=[],k="",j=[],h=a[c],s=void 0;for(s in h){e=h[s];if(e&Kindle.DB.AUTO_INCREMENT||e&Kindle.DB.PRIMARY_KEY)f?d=!1:(f=!!(e&Kindle.DB.AUTO_INCREMENT))||g.push(s);e&(Kindle.DB.PRIMARY_KEY|Kindle.DB.SECONDARY_KEY)&&j.push({name:s,keyPath:s,unique:!1,multientry:!1})}if(d){for(var e=!1,u=0;u<g.length;++u)k+=g[u],l[u]=h[s],u<g.length-1&&(k+=m,e=!0);g.length===0&&(f=!0);C[b]={info:h,
keyList:g,keyPath:k?k:void 0,genKeyPath:e,genKeyTypes:l,indexes:j,autoInc:f,tableInfo:h}}b=d;if(b&Kindle.DB.CONSTRAINT_ERROR)return!1}return!0},createDataStores:function(a){var b,c;for(c in a)if($.inArray(c,y.objectStoreNames)!==-1&&y.deleteObjectStore(c),b=w(y,c,[a[c]]),b&Kindle.DB.CONSTRAINT_ERROR)return!1;return!0},createTables:function(){KindleDebug.warning("Using deprecated function - createTables()")},dropTables:function(){function a(){s().then(b,g)}function b(a){function f(){d(a).then(e,g)}
a.length===0?e():c(a).then(f,g)}function c(a){function b(){++f===a.length&&d.resolve()}for(var d=new jQuery.Deferred,f=0,e=0;e<a.length;e++)v("bookinfo",{cacheState:Kindle.BookInfo.CachedState.PARTIAL},{asin:a[e].asin}).then(b,d.reject);return d.promise()}function d(a){function b(){++e===a.length&&c.resolve()}for(var c=new jQuery.Deferred,e=0,g=0;g<a.length;g++)f([a[g].asin]).then(b,c.reject);return c.promise()}function e(){u($.makeArray(y.objectStoreNames)).then(m.resolve,g)}function g(){KindleDebug.error("Error occured signing out");
m.reject()}var m=new jQuery.Deferred;y.name==="K4Wbooks"?u(["annotationsCache"]).then(a,g):e();return m.promise()},getTableNames:h,insertRecord:function(a,b){return n(a,[b])},insertList:n,upsertRecord:function(a,b,d){return p(a,function(a,f,e){a=a.objectStore(f);c(a,f,[b,d]).then(e.resolve,e.reject)},IDBTransaction.READ_WRITE)},updateRecord:v,getRecord:function(a,b,c){return p(a,function(a,d,f){a=a.objectStore(d);z(a,d,[b]).then(function(a){if(c)for(var b in a)for(var d in a[b])d in c||delete a[b][d];
f.resolve(a)},f.reject)},IDBTransaction.READ_ONLY)},deleteRecord:function(a,b){return p(a,function(a,c,d){a=a.objectStore(c);l(a,c,[b]).then(d.resolve,d.reject)},IDBTransaction.READ_WRITE)},batchTransaction:function(a){if(!a||a.length===0){var b=new jQuery.Deferred;b.resolve([]);return b.promise()}var b=[],c=!0,d=[],f=0,g;for(g in a)$.inArray(a[g].tableName,b)===-1&&(e(a[g].tableName),b.push(a[g].tableName)),c&&a[g].operation!==Kindle.DB.GET_RECORD_OPERATION&&(c=!1);return p(b,function(b,c,g){function m(b){return function(c){d[b]=
c;++f===a.length?g.resolve(d):k()}}function l(){b.abort();g.reject()}function k(){(h=a[j])||g.reject();e(h.tableName);D[h.operation](b.objectStore(h.tableName),h.tableName,h.params).then(m(j),l);++j}var h,j=0;k();return g.promise()},c?IDBTransaction.READ_ONLY:IDBTransaction.READ_WRITE)},getPieceIds:function(a,b){e(a);return p(a,function(c,f,e){var g=[],l,c=c.objectStore(a),f=o({asin:b,id:0},a);l=o({asin:b,id:d},a);f=IDBKeyRange.bound(f,l);c=c.openCursor(f);c.onsuccess=function(a){var b,a=a.target.result;
a===void 0?e.resolve(g):(b=a.key.split(m),b=parseInt(b[1],10),g.push(b),a["continue"]())};c.onerror=e.reject},IDBTransaction.READ_ONLY)},getOldBookList:function(a){return k(function(b){if(b.key!==a&&b.value.cacheState!==Kindle.BookInfo.CachedState.PINNED)return b.value})},dbGetBookStatistics:function(a){function b(a){g.reject(a)}function c(a){g.reject(a)}function f(a){l[a]={count:0,size:0};return function(b){b=b.target.result;b===void 0?l.totalsize+=l[a].size:(l[a].count++,l[a].size+=b.value.size,
b["continue"]())}}var e=["skeleton","fragments","glyphs","bookinfo"],g,m,l,k,h,j;g=new jQuery.Deferred;l={totalSize:0,cacheState:"",cachedSize:0};k=y.transaction(e,IDBTransaction.READ_ONLY);k.oncomplete=function(){var a;for(a=0;a<e.length-1;++a)l.totalSize+=l[e[a]].size;g.resolve(l)};k.onerror=b;k.onabort=b;m=o({asin:a,id:0},e[0]);j=o({asin:a,id:d},e[0]);j=IDBKeyRange.bound(m,j);for(m=0;m<e.length-1;m++)l[e[m]]={count:0,size:0},h=k.objectStore(e[m]),h=h.openCursor(j),h.onsuccess=f(e[m]),h.onerror=
c;h=k.objectStore("bookinfo");h=h.get(a);h.onsuccess=function(a){a=a.target.result;if(a!==void 0)l.cacheState=a.cacheState,l.cachedSize=a.cachedSize||0};h.onerror=c;return g.promise()},dbDeleteBooksData:f,deleteJournalEntries:function(a){return p("journal",function(b,c,d){b=b.objectStore(c).openCursor();b.onsuccess=function(b){b=b.target.result;if(b===void 0)d.resolve();else{var c=b.value,f;for(f in a)if(c.type===a[f].type&&c.guid===a[f].guid&&c.start===a[f].start&&c.end===a[f].end&&c.position===
a[f].position&&c.modifiedTimestamp===a[f].modifiedTimestamp&&c.asin===a[f].asin){delete a[f];b["delete"]();break}b["continue"]()}};b.onerror=d.reject},IDBTransaction.READ_WRITE)}}}
function KindleSqlWrapper(a){function e(a){if(!s[a])throw{name:"databaseAccessError",message:"Trying to access undefined table "+a};}function h(c,e){var b=new jQuery.Deferred,d=[];a[e?"readTransaction":"transaction"](function(a){c(a,d)},function(a){b.reject(a)},function(){b.resolve(d)});return b.promise()}function j(){var a=[],c;for(c in s)a.push(c);return a}function o(a,c,b){var d=[],e,g;for(g in a)e=c[g],e!==void 0?a[g]&Kindle.DB.OBJECT_TYPE?d.push(JSON.stringify(e)):d.push(e):b&&!(a[g]&Kindle.DB.AUTO_INCREMENT)&&
d.push(null);return d}function r(a,c){var b="",d,e;for(e in a)if(d=c[e])if(b+=(b?" AND ":"")+e,d.hasOwnProperty(Kindle.DB.OPERATOR))switch(d[Kindle.DB.OPERATOR]){case Kindle.DB.NOT_EQUAL:b+=" != ?";break;case Kindle.DB.IN_ARRAY:b+=" IN (?";for(var g=1;g<d[Kindle.DB.VALUES].length;g++)b+=", ?";b+=")"}else b+=" = ?";return b}function g(a,c){var b="DELETE FROM "+a;c&&(b+=" WHERE "+r(s[a],c));return b+";"}function p(a,c,b){if(b===void 0)b="*";else{var d=s[a],e="",g;for(g in d)b[g]&&(e+=(e?", ":"")+g);
b=e}b="SELECT "+b+" FROM "+a;c&&(b+=" WHERE "+r(s[a],c));return b+";"}function w(a,c){e(a);return h(function(b){x(b,a,[c])},!1)}function x(a,c,b,d,e){var b=b[0],g,d=s[c],e="INSERT OR "+(e?"IGNORE":"REPLACE")+" INTO "+c+" (",l="",k="";for(g in d)d[g]&Kindle.DB.AUTO_INCREMENT||(l+=(l?", ":"")+g,k+=(k?", ":"")+"?");e+=l+") VALUES ("+k+");";g=e;var c=s[c],h;for(h in b)d=o(c,b[h],!0),a.executeSql(g,d)}function n(a,c,b,d,e){var d=b[0],b=b[1],g=s[c],l=s[c],k="",h;for(h in l)d[h]!==void 0&&(k+=(k?", ":"")+
h+" = ?");c="UPDATE "+(e?"OR IGNORE ":"")+c+" SET "+(k+" WHERE "+r(l,b));c+=";";d=o(g,d).concat(o(g,b));a.executeSql(c,d)}function q(a,c,b){n(a,c,b,[],!0);x(a,c,[[$.extend({},b[0],b[1])]],[],!0)}function t(a,c){var b={},d,e,g;for(g in a)d=c[g],d!==void 0&&d!==null&&(e=a[g],b[g]=e&Kindle.DB.OBJECT_TYPE?JSON.parse(d):d);return b}function v(a,c,b){e(a);return h(function(d,e){z(d,a,[c,b],e)},!0)}function c(a){var c=[],b;if(a)for(var d in a)b=a[d],b.hasOwnProperty(Kindle.DB.VALUES)?c=c.concat(b[Kindle.DB.VALUES]):
c.push(b);return c}function z(a,e,b,d){var g=b[0],l=s[e];a.executeSql(p(e,g,b[1]),c(g),function(a,b){if(b.rows.length>0)for(var c=0;c<b.rows.length;c++)d.push(t(l,b.rows.item(c)))})}function l(a,e,b){b=b[0];a.executeSql(g(e,b),c(b))}function u(a){return h(function(c,b){for(var d,e=0;e<a.length;e++)if(d=k[a[e].operation])b[e]=[],d(c,a[e].tableName,a[e].params,b[e])},!1)}var s={},k={};k[Kindle.DB.INSERT_LIST_OPERATION]=x;k[Kindle.DB.UPDATE_RECORD_OPERATION]=n;k[Kindle.DB.UPSERT_RECORD_OPERATION]=q;
k[Kindle.DB.DELETE_RECORD_OPERATION]=l;k[Kindle.DB.GET_RECORD_OPERATION]=z;k[Kindle.DB.CREATE_TABLE_OPERATION]=function(a,c,b){var b=b[0],d="CREATE TABLE IF NOT EXISTS "+c+"(",e="",g,l=!0,k;for(k in b)l?l=!1:d+=", ",d+=k+" ",g=b[k],g&Kindle.DB.TEXT_TYPE||g&Kindle.DB.OBJECT_TYPE?d+="TEXT ":g&Kindle.DB.AUTO_INCREMENT?d+="INTEGER PRIMARY KEY AUTOINCREMENT ":g&Kindle.DB.NUMBER_TYPE&&(d+="INTEGER "),g&Kindle.DB.PRIMARY_KEY?(e+=e?", ":" PRIMARY KEY (",e+=k):g&Kindle.DB.ALLOW_NULL||(d+="NOT NULL");e&&(d+=
", "+e+")");d+=");";s[c]=b;a.executeSql(d,[])};return{createTables:function(a){var c,b=[];for(c in a)b.push({operation:Kindle.DB.CREATE_TABLE_OPERATION,tableName:c,params:[a[c]]});return u(b)},dropTables:function(){return h(function(a){for(var c in s)a.executeSql("DROP TABLE IF EXISTS "+c+";")},!1)},getTableNames:j,insertRecord:function(a,c){return w(a,[c])},insertList:w,upsertRecord:function(a,c,b){e(a);return h(function(d){q(d,a,[c,b])},!1)},updateRecord:function(a,c,b){e(a);return h(function(d){n(d,
a,[c,b])},!1)},getRecord:v,deleteRecord:function(a,c){e(a);return h(function(b){l(b,a,[c])},!1)},batchTransaction:u,getPieceIds:function(a,c){var b=new jQuery.Deferred;v(a,{asin:c},{id:!0}).then(function(a){var c=[],f;for(f in a)c.push(a[f].id);b.resolve(c)},b.reject);return b.promise()},getOldBookList:function(a){var c=new jQuery.Deferred;v("bookinfo",{asin:{operator:Kindle.DB.NOT_EQUAL,values:[a]},cacheState:{operator:Kindle.DB.NOT_EQUAL,values:[Kindle.BookInfo.CachedState.PINNED]}},{asin:!0,openTime:!0}).then(function(a){a.length===
0?c.reject():c.resolve(a)},c.reject);return c.promise()},dbGetBookStatistics:function(a){for(var c=new jQuery.Deferred,b=["skeleton","fragments","glyphs"],d={totalSize:0,cacheState:"",cachedSize:0},e,g=[],l=0;l<b.length;l++)g.push({operation:Kindle.DB.GET_RECORD_OPERATION,tableName:b[l],params:[{asin:a},{size:!0}]});g.push({operation:Kindle.DB.GET_RECORD_OPERATION,tableName:"bookinfo",params:[{asin:a},{cacheState:!0,cachedSize:!0}]});u(g).then(function(a){for(var f=0;f<b.length;f++){var g=a[f],l=
0,k=void 0;for(k in g)l+=g[k].size;e={count:g.length,size:l};d[b[f]]=e;d.totalSize+=e.size}d.cacheState=a[3][0].cacheState;d.cachedSize=a[3][0].cachedSize;c.resolve(d)},function(){c.resolve(d)});return c.promise()},dbDeleteBooksData:function(a){var c,b,d,e=[];d=j();for(b=0;b<a.length;++b)for(c=0;c<d.length;++c)e.push({operation:Kindle.DB.DELETE_RECORD_OPERATION,tableName:d[c],params:[{asin:a[b]}]});return u(e)},deleteJournalEntries:function(a){var c=[],b;for(b in a)c.push({operation:Kindle.DB.DELETE_RECORD_OPERATION,
tableName:"journal",params:[{id:a[b].id}]});return u(c)}}}
function KindleStubDBWrapper(a){function e(a){if(!n[a])throw{name:"databaseAccessError",message:"Trying to access undefined table "+a};}function h(a,g){var l=g[0],h,j,k,f;for(f in l){h={};k=a;j=h;var m;m=k;var b=l[f];e(m);var d=n[m],o=!0,p=void 0,r=void 0;for(r in d.info)if(p=d.info[r],b[r]===void 0)if(p&Kindle.DB.AUTO_INCREMENT)t[m]++,b[r]=t[m];else{if(!(p&Kindle.DB.ALLOW_NULL)||p&Kindle.DB.PRIMARY_KEY)o=!1}else if(p&Kindle.DB.AUTO_INCREMENT)o=!1;else{switch(typeof b[r]){case "number":o=p&Kindle.DB.NUMBER_TYPE;
break;case "string":o=p&Kindle.DB.TEXT_TYPE;break;case "object":o=p&Kindle.DB.OBJECT_TYPE}if(!o)break}m=o?null:Kindle.DB.CONSTRAINT_ERR;o=d=b=void 0;if(m===null){o=n[k].keyList;d=q[k];for(k=0;k<o.length-1;k++)b=o[k],d[b]||(d[b]={}),d=d[j];j.container=d;j.key=o[o.length-1]}j=m;if(j===null)k=l[f][h.key],h.container[k]===void 0?h.container[k]=l[f]:j=Kindle.DB.CONSTRAINT_ERR;else{j=Kindle.DB.CONSTRAINT_ERR;break}}return j}function j(a,e){var g=new jQuery.Deferred,j=h(a,[e]);j?g.reject(j):g.resolve();
return g.promise()}function o(a,g){e(a);var l=n[a].keyList,h=q[a],j,k,f={};for(j=0;j<l.length;j++)if(k=l[j],g[k])if(j===l.length-1){f.key=g[k];break}else h[g[k]]||(q[g[k]]={}),h=q[g[k]],delete g[k];else break;if(j<l.length-1)throw"unsupported use case for in-memory DB!!";f.container=h;f.selection=g;return f}function r(a,e){var g=e[0],h=null,j=o(a,e[1]);j.container&&j.key&&j.container[j.key]?$.extend(j.container[j.key],g):h=Kindle.DB.CONSTRAINT_ERR;return h}function g(a,e){$.extend(e[0],e[1]);var g=
h(a,[[e[0]]]);g===Kindle.DB.CONSTRAINT_ERR&&(g=r(a,e));return g}function p(a,e,g){var e=e[0],h=n[a],j=q[a],k,f;if(e){if(a=o(a,e),j=a.container)if(a.key)j[a.key]&&g.push(j[a.key]);else for(k in a=a.selection,h=!0,j){for(f in a)if(j[k][f]!==e[f]){h=!1;break}h&&g.push(j[k])}}else if(h.keyList.length!==1)throw"unsupported use case for in-memory DB!!";else for(k in j)g.push(j[k]);return null}function w(a,e){var g=e[0],j,h=q[a],k,f,m;if(g){if(j=o(a,g),h=j.container)if(j.key)delete h[j.key];else for(k in j=
j.selection,m=!0,h){for(f in j)if(h[k][f]!==g[f]){m=!1;break}m&&delete h[k]}}else q[a]={};return null}function x(a){var e=new jQuery.Deferred,g,j=[],h;for(h in a)if(g=a[h],j[h]=[],g=v[g.operation](g.tableName,g.params,j[h]))break;g===null?e.resolve(j):e.reject(g);return e.promise()}var n={},q={},t={},v={};v[Kindle.DB.INSERT_LIST_OPERATION]=h;v[Kindle.DB.UPDATE_RECORD_OPERATION]=r;v[Kindle.DB.UPSERT_RECORD_OPERATION]=g;v[Kindle.DB.DELETE_RECORD_OPERATION]=w;v[Kindle.DB.GET_RECORD_OPERATION]=p;v[Kindle.DB.CREATE_TABLE_OPERATION]=
function(a,e){var g=!0,j=!1,h,k=[],f=0,m=e[0],b;for(b in m)if(h=m[b],h&Kindle.DB.AUTO_INCREMENT||h&Kindle.DB.PRIMARY_KEY)j?g=!1:(j=h&Kindle.DB.AUTO_INCREMENT,k.push(b));if(g){if(k.length===0)k.push("id"),m.id=Kindle.DB.AUTO_INCREMENT,j=!0;n[a]={info:m,keyList:k};(h=q[a])||(q[a]={});if(j){for(var d in h)f=Math.max(f,parseInt(d,10));t[a]=f}}return g?null:Kindle.DB.CONSTRAINT_ERR};(function(){var c;try{c=JSON.parse(KindleLocalStorage.localStorageObject.getItem(a))}catch(e){}c&&typeof c==="object"&&(q=
c)})();return{persist:function(){var c=null;try{KindleLocalStorage.localStorageObject.setItem(a,JSON.stringify(q))}catch(e){c=Kindle.DB.QUOTA_ERR}return c},createTables:function(a){var e,g,h;e=new jQuery.Deferred;h=[];for(g in a)h.push({operation:Kindle.DB.CREATE_TABLE_OPERATION,tableName:g,params:[a[g]]});x(h).then(e.resolve,e.reject);return e.promise()},dropTables:function(){q={};n={};t={};KindleLocalStorage.localStorageObject.setItem(a,null);return(new $.Deferred).resolve().promise()},getTableNames:function(){var a=
[],e;for(e in n)a.push(e);return a},insertRecord:function(a,e){return j(a,[e])},insertList:j,upsertRecord:function(a,e,h){var j=new jQuery.Deferred;(a=g(a,[e,h]))?j.reject(a):j.resolve();return j.promise()},updateRecord:function(a,e,g){var h=new jQuery.Deferred;(a=r(a,[e,g]))?h.reject(a):h.resolve();return h.promise()},getRecord:function(a,e){var g=new jQuery.Deferred,h=[],j=p(a,[e],h);j?g.reject(j):g.resolve(h);return g.promise()},deleteRecord:function(a,e){var g=new jQuery.Deferred,h=w(a,[e]);h?
g.reject(h):g.resolve();return g.promise()},batchTransaction:x,deleteJournalEntries:function(a){var e=[],g;for(g in a)e.push({operation:Kindle.DB.DELETE_RECORD_OPERATION,tableName:"journal",params:[{id:a[g].id}]});return x(e)}}};
