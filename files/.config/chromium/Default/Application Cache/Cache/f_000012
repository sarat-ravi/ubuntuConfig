/*
 * Copyright (c) 2012 Amazon.com, Inc. All rights reserved.
 */
function KindleBookDownloaderFactory(e){var k=5E3,d=0,c=1E3,b={};b.type=e.type;b.asin=e.asin;b.cache=e.cache;b.readAheadActive=!1;b.readAheadPauseCount=0;b.dbPutter=e.dbPutter;b.dbGetIdList=e.dbGetIdList;b.dbOosHandler=e.dbOosHandler;b.dbCheckCache=e.dbCheckCache;b.dbIsCached=e.dbIsCached;b.dbIsOos=e.dbIsOos;b.netGetter=e.netGetter;b.urlGetter=e.urlGetter;b.fileGetter=e.fileGetter;b.fileProgress=e.fileProgress;b.downloadError=e.downloadError;b.pauseReadAhead=function(){this.readAheadPauseCount++};
b.resumeReadAhead=function(c){this.readAheadPauseCount=Math.max(0,--this.readAheadPauseCount);if(this.readAheadPauseCount===0)this.nextReadAheadId=c};b.removeIdFromReadAhead=function(c){if(this.readAheadActive){var b;for(b=0;b<this.readAheadIds.length;b++)if(this.readAheadIds[b]===c){this.readAheadIds.splice(b,1);break}for(b=0;b<this.readAheadUrls.length;b++)if(this.readAheadUrls[b].id===c){this.readAheadUrls.splice(b,1);break}}};b.readAheadOne=function(b){function c(){a.readAheadActive&&(a.numReadAheadNetRequests--,
a.readAheadUrls.length===0?a.numReadAheadNetRequests===0&&setTimeout(function(){a.getReadAheadUrls(b)},a.interReadWait):setTimeout(function(){a.readAheadOne(b)},a.interReadWait))}function d(){c()}function f(b){function h(){a.readAheadRemaining--;a.fileProgress(a.readAheadRemaining);c()}var f;f=b.fragmentMetadata!==void 0?b.fragmentMetadata.id:b.skeletonMetadata!==void 0?b.skeletonMetadata.id:b.glyphFragmentMetadata!==void 0?b.glyphFragmentMetadata.id:void 0;var g=[];g[f]=b;a.dbPutter(g,h,function(b){function f(){a.dbPutter(g,
h,l)}function l(){a.readAheadActive=!1;a.dbIsOos()}!(b.code===Kindle.DB.CONSTRAINT_ERR||b.message==="constraint failed")&&b.code===Kindle.DB.QUOTA_ERR?(a.dbCheckCache(),a.dbOosHandler(f,l)):c()})}var a=this;if(b===this.readAheadGeneration)if(a.readAheadStillAlive++,this.readAheadPauseCount>0)setTimeout(function(){a.readAheadOne(b)},a.startReadWait);else if(a.readAheadUrls.length===0&&a.numReadAheadNetRequests===0)a.getReadAheadUrls(b);else for(;a.numReadAheadNetRequests<a.numReadAhead&&a.readAheadUrls.length>
0;){a.numReadAheadNetRequests++;var n=a.readAheadUrls.shift();a.fileGetter(n,f,d)}};b.getReadAheadUrls=function(b){function c(a){f.readAheadUrls=a;setTimeout(function(){f.readAheadOne(b)},f.interReadWait)}function d(){}var f=this;if(b===this.readAheadGeneration&&this.readAheadActive)if(f.dbCheckCache()){f.readAheadStillAlive++;for(var a=[],n=0;n<f.readAheadIds.length&&f.readAheadIds[n]<f.nextReadAheadId;)n++;n===f.readAheadIds.length&&(n=0);a=f.readAheadIds.splice(n,f.numReadAheadUrls);a.length===
0?f.refreshReadAheadList(b):(f.nextReadAheadId=n<f.readAheadIds.length?f.readAheadIds[n]:0,f.urlGetter(a,c,d))}else f.readAheadActive=!1};b.refreshReadAheadList=function(b){function c(d){function m(){f.getReadAheadUrls(b)}var h=a.createSubTimer("success");f.readAheadStillAlive++;var p,g=[];for(p in d)g[d[p]]=!0;f.readAheadIds=[];for(p=0;p<=f.maxReadAheadId;p++)g[p]||f.readAheadIds.push(p);h.addCount("needed",f.readAheadIds.length);h.addCount("total",f.maxReadAheadId+1);h.endTimer();a.endTimer();a.log();
f.readAheadIds.length>0?(f.readAheadRemaining=f.readAheadIds.length,setTimeout(m,f.startReadWait)):(f.readAheadActive=!1,f.dbIsCached())}function d(){a.endTimer();f.downloadError(Kindle.ERROR.UNKNOWN_DB_ERROR)}var f=this;if(b===this.readAheadGeneration){var a;this.readAheadActive&&(a=KindleMetricsProfiler("bookDownloader.getIdList"),this.dbGetIdList(c,d))}};b.readAheadWatchdog=function(){var b=this;if(this.readAheadActive){if(this.readAheadStillAlive===0)this.readAheadGeneration++,this.readAheadRemaining<
this.generationReadAheadRemaining?(this.numReadAheadNetRequests=0,this.generationReadAheadRemaining=this.readAheadRemaining,this.watchDogTimeout=15E3,this.refreshReadAheadList(this.readAheadGeneration)):this.timeoutRetry?(this.generationReadAheadRemaining=this.readAheadRemaining+1,this.watchDogTimeout=12E4):this.downloadError(Kindle.ERROR.TIMEOUT);setTimeout(function(){b.readAheadWatchdog()},this.watchDogTimeout)}this.readAheadStillAlive=0};b.startReadAhead=function(b,j){var o=this,f=k;this.cache?
(this.readAheadUrls=[],this.readAheadIds=[],this.numReadAheadNetRequests=this.nextReadAheadId=0,this.maxReadAheadId=b,this.readAheadActive=!0,this.readAheadGeneration=this.readAheadStillAlive=0,this.readAheadRemaining=b+1,this.generationReadAheadRemaining=b+2,this.watchDogTimeout=15E3,j?(this.startReadWait=this.interReadWait=f=0,this.numReadAhead=8,this.numReadAheadUrls=200):(this.startReadAheadWait=k,this.interReadWait=d,this.startReadWait=c,this.numReadAhead=4,this.numReadAheadUrls=20,this.timeoutRetry=
!0),this.debugCounter=15,setTimeout(function(){o.readAheadWatchdog()},f)):this.readAheadActive=!1};b.cancelReadAhead=function(){this.readAheadActive=!1;this.readAheadGeneration=-1;this.readAheadIds=this.readAheadUrls=null};b.setReadAheadTimersForTestMode=function(){c=d=k=0};return b}
var KindleReaderBookInfoProvider=function(){var e=3E4,k="fragmentIds",d="glyphIds",c="skeletonIds",b="book_context",l="book_metaData",j="book_key",o="book_skeleton",f="book_fragmap",a="book_ok_to_download";return{BookInfo:function(n,m){function h(){var a=new jQuery.Deferred;KindleLibraryBookCover.getOfflineCover(F).then(function(b){u.getModuleSync(KindleModuleManager.DB_CLIENT).getBookDb().getTable("covers").insertRecord({asin:F,coverData:b}).then(a.resolve,a.reject)},a.reject);return a.promise()}
function p(a){function g(){var c=u.getModuleSync(b);y.savePinningFinishState(a,c).then(h.resolve,h.reject);f&&(A.endMetrics(J),J=null)}function c(){f&&(A.endMetrics(J),J=null);h.reject(Kindle.ERROR.NETWORK)}var f,h=new jQuery.Deferred;J||(J=A.startMetrics("SetOfflineState"),f=!0);T().done(function(){var f;u.isModuleInitialized(b)?(f=u.getModuleSync(b),f={asin:F,kindleSessionId:f.kindleSessionId,isOffline:a===Kindle.BookInfo.CachedState.PINNED},u.getModuleSync(u.SERVICE_CLIENT).setOfflineStatus(f).then(g,
c)):h.reject()});return h.promise()}function g(){ea&&(ea.endTimer(),ea.log(),ea=null);var a=R!==ga&&R!==Kindle.BookInfo.CachedState.PINNED?p(ga):!0;$.when(a).then(function(){h().then(U.resolve,U.resolve)},function(a){a===Kindle.ERROR.NETWORK?U.reject(a):U.reject(Kindle.ERROR.UNKNOWN_DB_ERROR)});y.getBookStatistics().then(function(a){D.metricId&&(a.fragments!==void 0&&(A.increaseSubCounter(D.metricId,"fragmentCount",a.fragments.count),A.increaseSubCounter(D.metricId,"fragmentsSize",a.fragments.size)),
a.glyphs!==void 0&&(A.increaseSubCounter(D.metricId,"glyphCount",a.glyphs.count),A.increaseSubCounter(D.metricId,"glyphsSize",a.glyphs.size)),A.endMetrics(D.metricId))},function(){D.metricId&&A.endMetrics(D.metricId)})}function r(a,b,g){function c(a,f,h){function d(a){if(a.skeletonMetadata!==void 0&&a.skeletonMetadata.encryption===1){var g=KindleO_Aaa.o_aad(a.skeletonData,m);a.skeletonData=g;delete a.skeletonMetadata.encryption}b(a)}function p(a,b){g(null,b,null,h)}var m;u.getModule(j).then(function(b){m=
b;G(a,d,p,f)},g)}function f(a,c,h){function d(a){if(a.fragmentMetadata!==void 0&&a.fragmentMetadata.encryption===1){var g=KindleO_Aaa.o_aad(a.fragmentData,m);a.fragmentData=g;delete a.fragmentMetadata.encryption}b(a)}function p(a,b){g(null,b,null,h)}var m;u.getModule(j).then(function(b){m=b;G(a,d,p,c)},g)}function h(a,c,f){G(a,function(a){if(a.glyphFragmentMetadata!==void 0)a.glyphFragmentMetadata.id=f;b(a)},function(a,b){g(null,b,null,f)},c)}if(a.skeletonUrls)for(var d=a.skeletonUrls,p=0;p<d.length;p++)c(d[p].signedUrl,
"loadSkeleton"+d[p].id,d[p].id);if(a.fragmentUrls){d=a.fragmentUrls;for(p=0;p<d.length;p++)f(d[p].signedUrl,"loadFragment"+d[p].id,d[p].id)}if(a.glyphUrls){a=a.glyphUrls;for(d=0;d<a.length;d++)h(a[d].signedUrl,"loadGlyphFragment"+a[d].id,a[d].id)}}function q(a,g){var c=new jQuery.Deferred;u.getModule(b).done(function(b){var f={asin:F,contentVersion:b.contentVersion,formatVersion:b.formatVersion,isSample:I};if(b.kindleSessionId)f.kindleSessionId=b.kindleSessionId;if(b.basePath)f.basePath=b.basePath;
if(b.useNewPath)f.useNewPath=b.useNewPath;if(b.useProdBucket)f.useProdBucket=b.useProdBucket;f[a]=g;u.getModuleSync(u.SERVICE_CLIENT).getFileUrl(f).then(c.resolve,c.reject)});return c.promise()}function t(){var a=u.getModuleSync(l),b=u.getModuleSync(f);sa?R===Kindle.BookInfo.CachedState.CACHED||R===Kindle.BookInfo.CachedState.PINNED?g():y.computeCacheQuota().then(function(){ea=KindleMetricsProfiler("readAhead");D.fragmentsDownloading=!0;S.startReadAhead(b.fragmentMetadata.numberOfFragments-1,ya);
if(a.numOfGlyphFragments)D.glyphsDownloading=!0,V.startReadAhead(a.numOfGlyphFragments-1)},U.reject):U.reject()}function s(a){S&&(S.cancelReadAhead(),S=null);V&&(V.cancelReadAhead(),V=null);U.reject(a)}function v(){function a(g){A.startSubTimer(J,"getFragMap");var c=u.getModuleSync(b);G(c.fragmentMapUrl,function(a){g.resolve(a);A.endSubTimer(J,"getFragMap")},function(a,b){g.reject(b)},"loadFragmap")}u.isModuleRegistered(f)||u.registerModuleWithInitializer(f,a);return u.getModule(f)}function x(a){var b;
a.cpr!==void 0&&(b={},KindleCompression.lzAddStringsToDictionary(a.cpr,b),KindleCompression.lzAddNumbersToDictionary(b),W=KindleCompression.lzGetDecompressionDictionary(b));a.cprJson!==void 0&&(b={},KindleCompression.lzAddStringsToDictionary(a.cprJson,b,256),KindleCompression.lzAddNumbersToDictionary(b,256),ja=KindleCompression.lzGetDecompressionDictionary(b))}function O(){function a(g){A.startSubTimer(J,"getMetaData");var c=u.getModuleSync(b);G(c.metadataUrl,function(a){x(a);A.endSubTimer(J,"getMetaData");
g.resolve(a)},function(a,b){g.reject(b)},"loadMetadata")}u.isModuleRegistered(l)||u.registerModuleWithInitializer(l,a);return u.getModule(l)}function z(){function a(g){var c=u.getModuleSync(b),c={asin:F,contentVersion:c.contentVersion,formatVersion:c.formatVersion};u.getModuleSync(u.SERVICE_CLIENT).getBookKeyUrl(c,function(a){KindleO_Aaa.iToStr(a,g.resolve,g.reject)},g.reject)}u.isModuleRegistered(j)||u.registerModuleWithInitializer(j,a);return u.getModule(j)}function C(){function a(b){if(b.skeletonMetadata.compression===
1)b.skeletonData=KindleCompression.lzExpandWithStaticDictionary(b.skeletonData,W),delete b.skeletonMetadata.compression;return b}function b(g){ka.getPieces([0],function(b){u.getModule(l).then(function(){g.resolve(a(b));A.endSubTimer(J,"getSkeleton")},g.reject)},g.reject)}u.isModuleRegistered(o)||(A.startSubTimer(J,"getSkeleton"),u.registerModuleWithInitializer(o,b));return u.getModule(o)}function G(a,b,g,c){var f=new jQuery.Deferred;$.jsonp({url:a,callback:c,cache:!0,timeout:e,error:function(a,b){g&&
g(a,b);f.reject(b)},success:function(a){b&&b(a);f.resolve(a)}});return f.promise()}function X(){var a={asin:F,type:"fragment",cache:ca,netGetter:function(a,b,g){Y(k,a,b,g)},dbGetter:function(a,b,g){y.getFragments(a).then(b,g)},dbGetIdList:function(a,b){y.getFragmentIds().then(a,b)},dbPutter:function(a,b,g){y.putFragments(a).then(b,g)},dbCheckCache:function(){var a=y.getCacheQuota();return a.cachedSize>a.cacheQuota?(s(Kindle.ERROR.OUT_OF_SPACE),!1):!0},dbOosHandler:function(a,b){u.getModuleSync(u.DB_CLIENT).getBookDb().deleteOldestBookData(F).then(a,
b)},dbIsCached:function(){D.fragmentsDownloading=!1;D.glyphsDownloading||g()},dbIsOos:function(){s(Kindle.ERROR.OUT_OF_SPACE)},urlGetter:function(a,b,g){$.when(q(k,a)).then(function(a){b(a.fragmentUrls)},g)},fileGetter:function(a,b,g){r({fragmentUrls:[a]},b,g)},fileProgress:function(a){var b;ta&&(b=u.getModuleSync(f),ta(b.fragmentMetadata.numberOfFragments-a,b.fragmentMetadata.numberOfFragments))},downloadError:function(a){s(a)}};S=KindleBookDownloaderFactory(a);a.downloader=S;la=KindleBookPieceManagerFactory(a);
ka=KindleBookPieceManagerFactory({asin:F,type:"skeleton",cache:ca,netGetter:function(a,b,g){Y(c,a,b,g)},dbGetter:function(a,b,g){y.getSkeleton(a).then(b,g)},dbPutter:function(a,b,g){y.putSkeletons(a).then(b,g)},dbOosHandler:function(a,b){u.getModuleSync(u.DB_CLIENT).getBookDb().deleteOldestBookData(F).then(a,b)},downloader:{pauseReadAhead:function(){},resumeReadAhead:function(){},removeIdFromReadAhead:function(){}}});a={asin:F,type:"glyph",cache:ca,netGetter:function(a,b,g){Y(d,a,b,g)},dbGetter:function(a,
b,g){y.getGlyphs(a).then(b,g)},dbGetIdList:function(a,b){y.getGlyphIds().then(a,b)},dbPutter:function(a,b,g){y.putGlyphs(a).then(b,g)},dbCheckCache:function(){return!0},dbOosHandler:function(a,b){y.deleteOldestBookData(F).then(a,b)},dbIsCached:function(){D.glyphsDownloading=!1;D.fragmentsDownloading||g()},dbIsOos:function(){s(Kindle.ERROR.OUT_OF_SPACE)},urlGetter:function(a,b,g){$.when(q(d,a)).then(function(a){b(a.glyphUrls)},g)},fileGetter:function(a,b,g){r({glyphUrls:[a]},b,g)},fileProgress:function(){},
downloadError:function(a){s(a)}};V=KindleBookDownloaderFactory(a);a.downloader=V;qa=KindleBookPieceManagerFactory(a)}function T(){function a(g){if(g.cacheState&&(R=g.cacheState,R===Kindle.BookInfo.CachedState.PINNING))ga=Kindle.BookInfo.CachedState.PINNED;g.context!==void 0&&u.registerModule(b,g.context);g.metadata!==void 0&&(x(g.metadata),u.registerModule(l,g.metadata));g.fragmap!==void 0&&u.registerModule(f,g.fragmap);A.endSubTimer(J,"checkDB");K.resolve(g)}function g(a){A.endSubTimer(J,"checkDB");
a&&a.code===Kindle.DB.DATABASE_ERR&&a.message.indexOf("no such table")>=0&&u.getModuleSync(u.APP_REGISTRATION).deregister();K.resolve()}if(!K){K=new jQuery.Deferred;A.startSubTimer(J,"checkDB");var c=u.getModuleSync(u.DB_CLIENT);c.getBookDb()?(y=c.getBookDb().BookInfoDB(F),y.getBookInfo().then(a,g)):(ca=sa=!1,g())}return K.promise()}function P(){D.metricId=A.startMetrics("BookDownload::Reading",A.BREAK_DOWN_HARDWARE);u.getModuleList([b,l,f,o,a]).done(function(a){var g=$.extend({},a[b]);delete g.kindleSessionId;
a={metadata:a[l],fragmap:a[f],context:g,cacheState:ma};y&&ca&&y.insertBookInfo(a)})}function B(g,c){function h(g){k.endTimer();A.endMetrics(q,!0);(function(){var h;if(g.downloadRestrictionReason)s.reject(g.downloadRestrictionReason.reasonCode);else{h=r.createSubTimer("finishStartReading");if(u.isModuleInitialized(b)){var d=u.getModuleSync(b);if(d.contentVersion===g.contentVersion&&d.lastPageReadData.position!==g.lastPageReadData.position)d.lastPageReadData=g.lastPageReadData,y.updateBookContext(d);
d.kindleSessionId=g.kindleSessionId}else u.registerModule(b,g);if(g.isSample)I=!0,sa=ca=!1,u.registerModule(j,!0);else if(n.isSample===!0){h.endTimer();r.endTimer();r.log();s.reject(Kindle.ERROR.UNKNOWN_ERR);return}m||(X(),C(),O(),P());la.setNetworkReady();qa.setNetworkReady();ka.setNetworkReady();h.endTimer();h=r.createSubTimer("resolve");s.resolve(!0);h.endTimer();r.endTimer();r.log();$.when(O(),v(),z(),C()).fail(function(){c("LoadFailure")});u.getModuleList([b,l,f,o,a]).done(t).fail(U.reject)}})()}
function d(a){m?s.resolve(!1):s.reject(a);R===Kindle.BookInfo.CachedState.PINNED?U.resolve():U.reject(Kindle.ERROR.NETWORK)}function p(a){e.endTimer();m=a;q=A.startMetrics("Reader::StartReading");k=r.createSubTimer("startReading");a=$.extend({asin:F},n);if(m&&m.context&&R===Kindle.BookInfo.CachedState.PINNED)a.kindleSessionId=m.context.kindleSessionId;x=Ba(a);m&&(X(),la.setNetworkReady(),qa.setNetworkReady(),ka.setNetworkReady(),C());x.then(h,d)}var m,r,e,k,q,x,s=new jQuery.Deferred;U=new jQuery.Deferred;
J=g;r=KindleMetricsProfiler("bookInfo.startReading");e=r.createSubTimer("getInfoFromDB");n.isSample===!0?p(null):T().done(p);return s.promise()}function H(){var a=n.bucket+"/"+n.asin+"/"+n.version;a+=n.sample===void 0?"/book":"/sample";var b={baseUrl:a,fragmentMapUrl:a+"/frags/gz_fragmap.jsonp",imageBaseUrl:a,locationMapUrl:a+"/locations.jsonp",metadataUrl:a+"/metadata.jsonp",mobiToHtmlUrl:a+"/mobiToHtml.jsonp",htmlToMobiUrl:a+"/htmlToMobi.jsonp",version:n.version,auth:n.auth?n.auth:"",contentKey:n.key?
n.key:"",lastPageReadData:{deviceName:null,position:-1,syncTime:0}},g=b.contentKey;n.key&&(_deferredKey=new jQuery.Deferred,_deferredKey.resolve());Ba=function(){return(new jQuery.Deferred(function(a){a.resolve(g)})).promise()};Y=function(a,g,f,h){var p=[],m=[],l=[];switch(a){case c:for(a=0;a<g.length;a++)l.push({id:g[a],signedUrl:b.baseUrl+"/frags/gz_skeleton"+g[a]+".jsonp"+b.auth});break;case k:for(a=0;a<g.length;a++)p.push({id:g[a],signedUrl:b.baseUrl+"/frags/gz_frag"+g[a]+".jsonp"+b.auth});break;
case d:for(a=0;a<g.length;a++)m.push({id:g[a],signedUrl:b.baseUrl+"/glyphs/glyphFragment"+g[a]+".jsonp"+b.auth})}g={};if(l.length)g.skeletonUrls=l;if(p.length)g.fragmentUrls=p;if(m.length)g.glyphUrls=m;r(g,f,h)}}var F=n.asin,I,u=m||KindleModuleManager,A=u.getModuleSync(u.METRICS_MANAGER),K=null,y=null,R=null,W=null,ja=null,sa=!0,ca=!0,D={},la=null,ka=null,qa=null,S=null,V=null,U=null,ta=null,ga=Kindle.BookInfo.CachedState.CACHED,ya=!1,ma=Kindle.BookInfo.CachedState.PARTIAL,ea=null,J=null,Y=function(a,
b,g,c){$.when(q(a,b)).then(function(a){r(a,g,c)},function(a,g,f){c(a,g,f,b)})},Ba=function(a){var b=new jQuery.Deferred;u.getModuleSync(u.SERVICE_CLIENT).startReading(a).then(function(a){if(n.basePath)a.basePath=n.basePath;if(n.useNewPath)a.useNewPath=n.useNewPath;if(n.useProdBucket)a.useProdBucket=n.useProdBucket;b.resolve(a)},function(){b.reject("timeout")});return b.promise()};n.bucket!==void 0&&H();return{getAsin:function(){return F},startReading:function(b,g){u.registerModule(a,!0);return B(b,
g)},doneReading:function(){S&&S.cancelReadAhead();V&&V.cancelReadAhead()},getImageBaseUrl:function(){return u.getModuleSync(b).imageBaseUrl+"/"},getKindleSessionId:function(){return u.getModuleSync(b).kindleSessionId},getFragmentMap:function(a,b){setTimeout(function(){u.getModule(f).then(a,b)},15)},getBookType:function(){var a=new jQuery.Deferred;u.getModule(f).then(function(b){a.resolve(b.fragmentMetadata.bookType)},a.reject);return a.promise()},isBookSample:function(){return I},getBookSkeleton:function(a,
b){u.getModule(o).then(a,b)},getBookFragments:function(a,b,g){la.getPieces(g,function(b){if(b.fragmentMetadata.compression===1||b.fragmentMetadata.compression===2){b.fragmentData=KindleCompression.lzExpandWithStaticDictionary(b.fragmentData,W);if(b.paraData!==void 0&&typeof b.paraData==="string"){var g=KindleCompression.lzExpandWithStaticDictionary(b.paraData,ja,256);b.paraData=JSON.parse(g)}delete b.fragmentMetadata.compression}a(b)},b)},getGlyphFragments:function(a,b,g){qa.getPieces(g,function(b){if(b.glyphFragmentMetadata.compression===
1||typeof b.glyphData==="string"){var g=KindleCompression.lzExpandWithStaticDictionary(b.glyphData,ja,256);b.glyphData=JSON.parse(g);delete b.glyphFragmentMetadata.compression}a(b)},b)},getMetadata:function(a,b){return u.getModule(l).then(a,b)},UNKNOWN_FPR:-1,getFurthestPositionReadData:function(){return u.getModuleSync(b).lastPageReadData},getBookPositions:function(){var a=new jQuery.Deferred;u.getModule(l).then(function(g){var c=KindleModuleManager.getModuleSync(b);a.resolve({toc:g.positions.toc,
srl:c.srl||g.positions.srl,cover:g.positions.cover})},a.reject);return a.promise()},startDownloading:function(b,g,c){ga=Kindle.BookInfo.CachedState.PINNED;ya=!0;u.registerModuleWithDeferred(a,c);return B(b,g)},cancelDownloading:function(){S.cancelReadAhead();V.cancelReadAhead();U.reject(Kindle.ERROR.CANCELLED)},getDownloadComplete:function(a){ta=a;return U.promise()},isBookDownloaded:function(){return R===Kindle.BookInfo.CachedState.CACHED||R===Kindle.BookInfo.CachedState.PINNED},setCachedState:p,
getSizeInfo:function(){var a=new jQuery.Deferred;$.when(u.getModule(l),y.computeCacheQuota()).then(function(b,g){a.resolve({bookSize:b.bookSize,quota:g})},a.reject);return a.promise()}}}}}();
function KindleBookPieceManagerFactory(e){var k={},d;k.type=e.type;k.asin=e.asin;k.cache=e.cache;k.dbGetter=e.dbGetter;k.dbPutter=e.dbPutter;k.downloader=e.downloader;k.netGetter=e.netGetter;k.getPieces=function(c,b,l){function j(a){for(var c in a)b(a[c]);var f=[],d;for(d=0;d<m.length;d++)c=m[d],a[c]===void 0&&f.push(c);m=f;f.length>0?n(f):h.downloader.resumeReadAhead(g)}function o(){d||(d=new jQuery.Deferred);d.done(function(){n(m)})}function f(a){function c(){b(a)}var f;f=a.fragmentMetadata!==void 0?
a.fragmentMetadata.id:a.skeletonMetadata!==void 0?a.skeletonMetadata.id:a.glyphFragmentMetadata!==void 0?a.glyphFragmentMetadata.id:void 0;if(h.cache){var d=[];d[f]=a;h.dbPutter(d,c,c);h.downloader.removeIdFromReadAhead(f);--p===0&&h.downloader.resumeReadAhead(g)}else b(a)}function a(b,g,c,d){var p;Object.prototype.toString.call(d)==="[object Array]"?(p=d,d="list"):p=[d];r[d]=r[d]+1||1;r[d]<=2?h.netGetter(p,f,a):l(b,g,c)}function n(b){p=b.length;h.netGetter(b,f,a)}Object.prototype.toString.call(c)!==
"[object Array]"&&(c=[c]);var m=c.slice(0),h=this,p=0,g=Math.max.apply(Math,m)+1,r=[];this.cache?(this.downloader.pauseReadAhead(),this.dbGetter(c,j,o)):n(c)};k.setNetworkReady=function(){d||(d=new jQuery.Deferred);d.resolve()};return k}
var KindleCompression=function(){function e(a,b,c){var f,c=c>0?c:l;for(f in b)b[f]>=c&&(c=b[f]+1);f=c;for(var d in a)for(var c=a[d],g=2;g<=c.length;g++){var r=c.substr(0,g);b.hasOwnProperty(r)||(b[r]=f++)}return b}function k(a,b){var d,h=l;d="";for(var p=0;p<b.length;){var g=b.charAt(p);p++;g.charCodeAt(0)<=c?a.hasOwnProperty(d+g)?d+=g:(d.length>0&&h<j&&(a[d+g]=h,h++,h===o&&(h=f)),d=g):d=""}return a}function d(){if(defaultDictionary===void 0||defaultDictionary==={})defaultDictionary=k({},defaultDictionaryString);
return defaultDictionary}var c=9983,b=c+1,l=b+100+1,j=65533,o=55295,f=57344;return{lzCompress:function(a){var d={},m=[],h,p=l,g,r,e;g=h="";for(var k=0;k<a.length;){var s=a.charAt(k);k++;if(s.charCodeAt(0)<=c){for(;g.length>0;){r=Math.min(100,g.length);e=g.substr(0,r);g=g.substr(r);m.push(b+r);for(r=0;r<e.length;r++)m.push(e.charCodeAt(r))}d.hasOwnProperty(h+s)?h+=s:(h.length>0&&(m.push(h.length===1?h.charCodeAt(0):d[h]),p<j&&(d[h+s]=p,p++,p===o&&(p=f))),h=s)}else h.length>0&&(m.push(h.length===1?
h.charCodeAt(0):d[h]),h=""),g+=s}for(h.length>0&&m.push(h.length===1?h.charCodeAt(0):d[h]);g.length>0;){r=Math.min(100,g.length);e=g.substr(0,r);g=g.substr(r);m.push(b+r);for(r=0;r<e.length;r++)m.push(e.charCodeAt(r))}for(i=0;i<m.length;i++)m[i]=String.fromCharCode(m[i]);return m.join("")},lzExpand:function(a){for(var d={},m=[],h,p=l,g="",r,e=0;e<a.length;){h=a.charCodeAt(e);e++;if(h<=c)h=String.fromCharCode(h);else if(h>=l)(h=d[h])||(h=g+r);else{g=h-b;m.push(a.substr(e,g));e+=g;g="";continue}m.push(h);
r=h.charAt(0);p<j&&g.length>0&&(d[p]=g+r,p++,p===o&&(p=f));g=h}return m.join("")},lzBuildDictionary:k,lzGetDecompressionDictionary:function(a){var b=[],c;for(c in a)b[a[c]]=c;return b},lzAddStringsToDictionary:e,lzAddNumbersToDictionary:function(a,b){for(var c=[],f=100;f<1E3;f++)c.push(""+f);return e(c,a,b)},lzCompressWithStaticDictionary:function(a,f){if(f===void 0||f==={})f=d();var l=[],h,p,g,r;p=h="";for(var j=0;j<a.length;){var e=a.charAt(j);j++;if(e.charCodeAt(0)<=c){for(;p.length>0;){g=Math.min(100,
p.length);r=p.substr(0,g);p=p.substr(g);l.push(b+g);for(g=0;g<r.length;g++)l.push(r.charCodeAt(g))}f.hasOwnProperty(h+e)?h+=e:(h.length>0&&l.push(h.length===1?h.charCodeAt(0):f[h]),h=e)}else h.length>0&&(l.push(h.length===1?h.charCodeAt(0):f[h]),h=""),p+=e}for(h.length>0&&l.push(h.length===1?h.charCodeAt(0):f[h]);p.length>0;){g=Math.min(100,p.length);r=p.substr(0,g);p=p.substr(g);l.push(b+g);for(g=0;g<r.length;g++)l.push(r.charCodeAt(g))}for(i=0;i<l.length;i++)l[i]=String.fromCharCode(l[i]);return l.join("")},
lzExpandWithStaticDictionary:function(a,f,m){if(f===void 0||f===[]){if(defaultDeDictionary===void 0||defaultDeDictionary===[]){d();defaultDeDictionary=[];for(var h in defaultDictionary)defaultDeDictionary[defaultDictionary[h]]=h}f=defaultDeDictionary}h=c;var p=l;m!==void 0&&(h=m-1,p=m);for(var m=[],g=0;g<a.length;){var r=a.charCodeAt(g);g++;r<=h?m.push(String.fromCharCode(r)):r>=p?m.push(f[r]):(r-=b,m.push(a.substr(g,r)),g+=r)}return m.join("")}}}(),KindleO_Aaa=function(){function e(a){for(var b=
[],g,f,d,l,m,j,e=0;e<a.length;)g=a.charCodeAt(e++)&255,f=a.charCodeAt(e++)&255,d=a.charCodeAt(e++)&255,l=g>>2,g=(g&3)<<4|f>>4,m=(f&15)<<2|d>>6,j=d&63,isNaN(f)?m=j=64:isNaN(d)&&(j=64),b.push(c.charAt(l)+c.charAt(g)+c.charAt(m)+c.charAt(j));return b.join("")}function k(a,b){var g=[];g.length=256;for(var c=0;c<256;c++)g[c]=c;for(var f=0,d,c=0;c<256;c++)f=f+g[c]+b[c%b.length]&255,d=g[c],g[c]=g[f],g[f]=d;for(var f=c=0,l=[],m=0;m<a.length;m++)c=c+1&255,f=f+g[c]&255,d=g[c],g[c]=g[f],g[f]=d,l.push(String.fromCharCode(a.charCodeAt(m)^
g[g[c]+g[f]&255]));return l.join("")}function d(a,b){for(var g="",c=b?o:j,f=c.length,d=0;d<a;d++)g+=c.charAt(Math.floor(Math.random()*f));return g}for(var c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",b=[],l=0;l<c.length;l+=1)b[c.charCodeAt(l)]=l;for(var j="eeeeeeeeeeeeeeeeettttttttaaaaaaaaaaaaaaaaooooooiiiiiiinnnnssssrrrrhhhhllldddcccuuummmfffpoggwwyybbvkxjqz",o=j+"                                             ",f=[],a=0;a<10;a++)f[a]=d(15,!1);var n=["p","span","div","em",
"i","strong","b","a","big","small"],m=!1;return{iToStr:function(a,b,g){var c=new Image;c.onload=function(){var a=KindleHostDeviceDetector.isIE(),g=c.height,f=c.width,d=document.createElement("canvas").getContext("2d");d.drawImage(c,0,0);for(var h,l,m,j,e,o="",n=0,k,B=0;B<g;){h=d.getImageData(0,B,f,1);n=0;for(k=h.data.length-4;n<k;){l=h.data[n++]&7;m=h.data[n++]&3;j=h.data[n++]&7;n++;e=l*32+m*8+j;if(a){var H=void 0,H=0;e>=65&&e<=90||e>=50&&e<=55||e===0?H=e:(H=l>=2?-1:1,H=(l+H+8)%8*32+(m+H+4)%4*8+(j+
H+8)%8);H>=65&&H<=90||H>=50&&H<=55||(H=0);e=H}if(e===0)break;o+=String.fromCharCode(e)}if(e===0)break;B++}b(o)};c.onerror=function(){g()};c.src=a},o_aaa:e,o_aac:function(a,b){var g;g=a.replace(/\x0d\x0a/g,"\n");for(var c=[],f=0;f<g.length;f++){var d=g.charCodeAt(f);d<128?c.push(String.fromCharCode(d)):(d>127&&d<2048?c.push(String.fromCharCode(d>>6|192)):(c.push(String.fromCharCode(d>>12|224)),c.push(String.fromCharCode(d>>6&63|128))),c.push(String.fromCharCode(d&63|128)))}g=c.join("");c=b;c+="00000000000000000000000000000000".substring(0,
32-c.length);f=[];for(l=0;l<c.length;l+=2)f.push(parseInt(c.substring(l,l+2),16));return e(k(g,f))},o_aad:function(a,c){var g;g=[];for(var f,d,l,m,e,j=0;j<a.length;)f=b[a.charCodeAt(j++)],d=b[a.charCodeAt(j++)],m=b[a.charCodeAt(j++)],e=b[a.charCodeAt(j++)],f=f<<2|d>>4,d=(d&15)<<4|m>>2,l=(m&3)<<6|e,g.push(String.fromCharCode(f)),m!==64&&g.push(String.fromCharCode(d)),e!==64&&g.push(String.fromCharCode(l));g=g.join("");m=[];for(e=0;e<c.length;e++)m.push(c.charCodeAt(e));g=k(g,m);m=[];for(e=0;e<g.length;)j=
g.charCodeAt(e),j<128?(m.push(String.fromCharCode(j)),e++):j>191&&j<224?(f=g.charCodeAt(e+1),m.push(String.fromCharCode((j&31)<<6|f&63)),e+=2):(f=g.charCodeAt(e+1),d=g.charCodeAt(e+2),m.push(String.fromCharCode((j&15)<<12|(f&63)<<6|d&63)),e+=3);return m.join("")},o_aae:function(a){var b;if(!m){for(b=0;b<10;b++)$(f[b]).addClass("noDisplay");m=!0}var g=$(a).html(),c=!1,l="",e=0;for(b=0;b<g.length;b++)if(g[b]===">")c=!1;else if(g[b]==="<")c=!0;else if(b%60===7&&!c){l+=g.substring(e,b);var e=b,j=n[Math.floor(Math.random()*
n.length)];l+="<"+j+' class="'+f[Math.floor(Math.random()*f.length)]+'">'+d(30,!0)+"</"+j+">"}l+=g.substring(e,g.length);$(a).html(l)},o_aaf:function(a){a:{for(var b=0;b<f.length;b++)if(f[b]===a){a=!0;break a}a=!1}return a}}}();function KindleAssert(){}
var KindleDebug=function(){return{error:function(){},log:function(){},warn:function(){},saveLogs:function(){saveLog=!0}}}(),KindleHostDeviceDetector=function(){function e(){return navigator.platform.indexOf("iPad")!==-1}function k(){return navigator.platform.indexOf("iPhone")!==-1||navigator.platform.indexOf("iPod")!==-1}function d(){return navigator.userAgent.indexOf("Cloud9")!==-1}function c(){return"standalone"in navigator&&navigator.standalone}function b(){return window.chrome&&window.top.chrome.app&&
window.top.chrome.app.isInstalled}function l(){return navigator.userAgent.indexOf("PlayBook")!==-1}return{isiOS:function(){return e()||k()||l()||d()},isiPad:e,isiPad1:function(){return e()&&KindleHostPadDetector.isPad1(c())},isiPhone:k,isiOS_4x:function(){return(e()||k())&&navigator.userAgent.indexOf("OS 4")!==-1},isiOS_5x:function(){return(e()||k())&&navigator.userAgent.indexOf("OS 5")!==-1},isFirefox:function(){return navigator.userAgent.indexOf("Firefox")!==-1},isSafari:function(){return navigator.userAgent.indexOf("Safari")!==
-1},isIE:function(){return navigator.userAgent.indexOf("MSIE")!==-1},isPlayBook:l,isCloud9:d,isOnline:function(){return navigator.onLine},isChrome:function(){return window.chrome},isiOSAppMode:c,isChromeApp:b,isInAppMode:function(){return c()||b()},isCookieEnabled:function(){return navigator.cookieEnabled},isLocalStorageEnabled:function(){if(KindleLocalStorage.localStorageObject===null)return!1;try{KindleLocalStorage.localStorageObject.setItem("testLocalStorage","1"),KindleLocalStorage.localStorageObject.removeItem("testLocalStorage")}catch(b){return!1}return!0},
isWebSQLSupported:function(){return!!window.openDatabase},isIndexedDBSupported:function(){return!!window.mozIndexedDB||!!window.webkitIndexedDB},getDevicePlatform:function(){return e()?"iPad":k()?"iPhone":l()?"playBook":d()?"otter":"desktop"}}}(),KindleHostPadDetector=function(){return{isPad1:function(e){if(KindleLocalStorage.localStorageObject.getItem("definitelyNotPad1"))return!1;var k=0,d=1E3,c=0,b;for(i=0;i<3;i++)b=SunSpiderBenchmark.get3DSpeed(),b>k?k=b:b<d&&(d=b),c+=b;k=c/3;if(k>=200&&e)return!0;
if(k>=100&&!e)return!0;KindleLocalStorage.localStorageObject.setItem("definitelyNotPad1","true");return!1}}}();
function KindleInterfacesFactory(){function e(e,d){for(var c in d)if(d.hasOwnProperty(c)&&typeof e[c]!==typeof d[c])return!1;return!0}return{IKindleLibrary:{onReaderOpenStatus:function(){},onReaderClose:function(){},onStoreOpenStatus:function(){},libraryUpdateNeeded:function(){}},IKindleReader:{openBook:function(){},unloadReader:function(){},onStoreOpenStatus:function(){},onBookExtrasOpenStatus:function(){},pauseReader:function(){},resumeReader:function(){}},IKindleAppForLibrary:{openStore:function(){},
openBook:function(){},onLibraryLoaded:function(){},getQueryParameters:function(){}},IKindleAppForReader:{onReaderReady:function(){},closeReader:function(){},onStartReadingStatus:function(){},onRendererLoaded:function(){},openBookExtras:function(){},openStore:function(){}},checkImplements:e,assertImplements:function(k,d){KindleAssert(e(k,d),"Object fails to provide all properties of interface prototype")}}}
var KindleInterfaces=KindleInterfacesFactory(),KindlJournalManager=function(){function e(b){var c=[],a;for(a in b){var d=b[a].entry;d&&c.push(d)}return c}function k(c){var f=[],a;for(a in c)f.push({entry:c[a]});return l.getAppDb().getTable(b).insertList(f)}function d(b){var c=new jQuery.Deferred;j.updateAnnotations(b,KindleLocale.getLocalTimeOffset()).then(function(a){(a=a.Output.validAnnotations)&&a>0?c.resolve():c.reject()},function(){c.reject()});return c.promise()}function c(){var c=new jQuery.Deferred;
l.getAppDb().getTable(b).getRecord().then(function(b){function a(){l.getAppDb().deleteJournalEntries(b).then(c.resolve,c.reject)}var j=e(b);j.length>0?d(j).then(a,c.reject):c.resolve()},c.reject);return c.promise()}var b="journal",l=null,j=null;return{initialize:function(){var b=new jQuery.Deferred,c=this;KindleModuleManager.getModuleList([KindleModuleManager.SERVICE_CLIENT,KindleModuleManager.DB_CLIENT]).then(function(a){j=a[KindleModuleManager.SERVICE_CLIENT];l=a[KindleModuleManager.DB_CLIENT];
b.resolve(c)},b.reject);return b.promise()},saveToJournal:function(b){var f=new jQuery.Deferred;k(b).then(function(){c().then(f.resolve,f.resolve)},f.reject);return f.promise()},uploadJournal:c}}(),KindleLegacyDeviceTokenStorage=function(){return{hasDeviceTokenFromStorage:function(){return KindleLocalStorage.localStorageObject.getItem("kindleDeviceToken")!==null},getDeviceTokenFromStorage:function(){return KindleLocalStorage.localStorageObject.getItem("kindleDeviceToken")},setDeviceToken:function(e){KindleLocalStorage.localStorageObject.setItem("kindleDeviceToken",
e)},clearDeviceTokenFromStorage:function(){KindleLocalStorage.localStorageObject.removeItem("kindleDeviceToken")}}}(),KindleLocalStorage=function(){var e=null;if("localStorage"in window&&window.localStorage!==null&&window.localStorage)e=window.localStorage;return{localStorageObject:e}}(),KindleLocale=function(){var e=-(new Date).getTimezoneOffset();return{getLocalTimeOffset:function(){return e},getCountryCode:function(){return"US"}}}(),KindleMetricsProfiler=function(e){function k(c){for(var b=0,d=
0;d<c.length;d+=1)b+=c[d].end-c[d].start;return b}var d={};d.name=e;d.counters=null;d.subTimers=null;d.runs=[{start:(new Date).getTime(),end:null}];d.endTimer=function(){var c=this.runs[this.runs.length-1];if(c.end===null)c.end=(new Date).getTime()};d.addCount=function(c,b){if(this.counters===null)this.counters={};this.counters[c]===void 0?this.counters[c]=b:this.counters[c]+=b};d.createSubTimer=function(c){if(this.subTimers===null)this.subTimers={};this.subTimers[c]===void 0?this.subTimers[c]=KindleMetricsProfiler(c):
this.subTimers[c].runs.push({start:(new Date).getTime(),end:null});return this.subTimers[c]};d.log=function(){this.logAsPercentageOfTime("",k(this.runs))};d.logAsPercentageOfTime=function(c,b){var d=c+":"+this.name,e;k(this.runs);for(e in this.counters);for(e in this.subTimers)this.subTimers[e].logAsPercentageOfTime(d,b)};return d};
function KindleModuleManagerFactory(){function e(a,b){if(m[a])throw"Duplicate registration of module "+a;if(!b)throw"Module is not initialized with an object "+a;m[a]=b;h[a].resolve(b)}function k(a){if(m.hasOwnProperty(a))throw"Duplicate registration of module "+a;m[a]=void 0}function d(a,b){h[a]||(h[a]=new jQuery.Deferred);e(a,b)}function c(a,b){k(a);h[a]||(h[a]=new jQuery.Deferred);b(h[a]);h[a].done(function(b){e(a,b)})}function b(a){h[a]||(h[a]=new jQuery.Deferred);return h[a].promise()}function l(a){if(!m[a])throw"Trying to get uninitialized module "+
a;return m[a]}function j(a,b){m[a]=b}function o(a){var b=m[a];return{done:function(a){a(b)},fail:function(){},when:function(a){a(b)}}}function f(a){for(var b={},c=0;c<a.length;c++)b[name]=m[a];return{done:function(a){a(b)},fail:function(){},when:function(a){a(b)}}}function a(){m={}}var n={CONSTANTS:"Constants",APPCACHE_EVENTHANDLER:"appcache_eventHandler",DB_CLIENT:"DBClient",METRICS_MANAGER:"metrics_manager",SERVICE_CLIENT:"ServiceClient",APP_REGISTRATION:"Registration",JOURNAL_MANAGER:"JournalManager",
BOOK_METADATA:"book_metaData",BOOK_FRAGMAP:"book_fragmap"},m={},h={};return{CONSTANTS:n.CONSTANTS,DB_CLIENT:n.DB_CLIENT,METRICS_MANAGER:n.METRICS_MANAGER,SERVICE_CLIENT:n.SERVICE_CLIENT,APP_REGISTRATION:n.APP_REGISTRATION,JOURNAL_MANAGER:n.JOURNAL_MANAGER,BOOK_METADATA:n.BOOK_METADATA,BOOK_FRAGMAP:n.BOOK_FRAGMAP,ERROR_CODE_CANCEL:"canceled",registerModule:d,registerModuleList:function(a){for(var b in a)d(b,a[b])},registerModuleWithInitializer:c,registerModuleWithDeferred:function(a,b){c(a,function(a){b.done(a.resolve).fail(a.reject)})},
detachModule:function(a){var b=m[a],c=h[a];c&&!c.isResolved()&&c.reject("canceled");delete m[a];delete h[a];return b},getModule:b,getModuleList:function(a){var c=new jQuery.Deferred,f,d=[];for(f=0;f<a.length;f++)d.push(b(a[f]));$.when.apply($,d).done(function(){var b,f={};for(b=0;b<a.length;b++)f[a[b]]=arguments[b];c.resolve(f)}).fail(c.reject);return c.promise()},getModuleSync:l,isModuleInitialized:function(a){return m[a]!==void 0},isModuleRegistered:function(a){return m.hasOwnProperty(a)},switchToTestMode:function(){this.registerModuleTest=
j;this.getModule=o;this.getModuleSync=l;this.getModuleList=f;this.clear=a;delete this.registerModuleWithDeferred;delete this.registerModuleWithInitializer}}}
var KindleModuleManager=KindleModuleManagerFactory(),KindleRemoteClient=function(){return{getStoreURL:function(){var e=new jQuery.Deferred;$.get("/remote/store").then(function(k){(k=k.url)?e.resolve(k):e.reject()},e.reject);return e.promise()},uploadFeedback:function(e){var k={DevicePlatform:KindleHostDeviceDetector.getDevicePlatform(),UserAgent:navigator.userAgent,WindowHeight:window.innerHeight,WindowWidth:window.innerWidth},e={version:KindleVersion.getDisplayableVersion(),message:e,info:k},e={url:"/remote/feedback",
type:"POST",processData:!1,contentType:"application/json",data:JSON.stringify(e)};return $.ajax(e)}}}(),KindleUserAgentMetricsInfo=function(){var e,k,d,c,b,l={chrome:14,firefox:7,safari:5,ie:9,ios:4};return{browserWithVersionString:function(){if(!e){k=GoogleUserAgent.browserName.toLowerCase();d=GoogleUserAgent.browserVersionString.toLowerCase();var j;["ipad","iphone"].indexOf(k)!==-1&&((j=/CPU OS ([0-9_]+) /.exec(navigator.userAgent))&&j.length>=2&&(d=j[1]),osName=k="ios");a:{if(j=d){var o=/^0*([1-9]+)/.exec(j);
if(o&&o.length>=2){c=parseInt(o[1],10);break a}else KindleDebug.error("Bad regex on versionString: "+j)}c=void 0}"undefined"===typeof c?b="other":l[k]?(j=l[k],o=j+3,b=c<j?[k,"old"].join("@"):c>=o?[k,"new"].join("@"):[k,c].join("@")):b="other";e=!0}return b}}}(),KindleVersion=function(){var e=null;return{getVersion:function(){return"010200011"},getDisplayableVersion:function(){if(!e){var k=parseInt("010200011".slice(0,2),10),d=parseInt("010200011".slice(2,4),10),c=parseInt("010200011".slice(4,6),10),
b=parseInt("010200011".slice(6),10);e=k;e+=".";e+=d;e+=".";e+=c;e+=".";e+=b}return e}}}(),debugLib=function(){function e(a){var b=window.location.href;local=b.slice(0,b.indexOf("/",7));a="[\\?&]"+a.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]")+"=([^&#?]*)";a=RegExp(a).exec(window.location.href);return a===null?null:a[1]}function k(a){var c="";c+=h===!0||h==="true"?"<span style='color:"+b[a[1]]+"'>":"<span style='color:black'>";m===!0&&(c+="<i>// "+a[0]+"</i><br/>");for(var f=a[2];f>0;)c+="-----",f--;
for(f=3;f<a.length;f++)c+=a[f],c+=" ";c+="</span><br/>";j.document.write(c)}var d=null,c=!1,b=["black","#8B0000","#A0522D","#DAA520","green","blue","purple","gray","#708090","#BC8F8F","pink"],l=null,j=null,o=!1,f=[],a=9,n=!0,m=!1,h=!1;return{DEBUG_MESSAGES:void 0,DEBUG_BOXES:void 0,DEBUG_OVERLAY:d,debugMap:function(a,b,f,h,e,m){if(o){if(!c)c=!0,l=a.contentDocument.getElementsByTagName("body")[0],d=document.createElement("DIV"),d.id="pixelDisplay",d.style.top=l.offsetTop+"px",d.style.left=l.offsetLeft+
"px",d.style.width=l.offsetWidth+"px",d.style.height=l.offsetHeight+"px",d.style.position="absolute",l.appendChild(d);a="blue";switch("ALL"){case "YP":a="red";break;case "BLOCKQUOTE":a="white";break;case "DIV":a="red";break;case "YA":a="red";break;case "IMG":a="green";break;case "SUPAN":a="blue";break;case "TAUBLE":a="purple";break;case "TUR":a="teal";break;case "UB":a="pink"}var j=document.createElement("DIV");j.title="Nid: "+h+", starting %: "+e+", # lines: "+m+", top:"+b+", height:"+f;j.style.top=
b+"px";$(j).css("height",f+"px");$(j).css("font-size","0px");j.style.left=l.offsetLeft+"px";j.style.width=l.offsetWidth+"px";j.style.position="absolute";j.style.backgroundColor=a;j.style.opacity=".4";j.style.filter="alpha(opacity=40)";d.appendChild(j)}},resetMap:function(){c=!1},initialize:function(){var b=e("type"),c=e("level");h=e("code");o=Boolean(e("box"));c&&(a=c);b&&(f=b.split(","),j||(b=new Date,j=window.open("","debugLog","width=1000,height=800,scrollbars=yes"),j.document.write("<html>"),
j.document.write("<title>DEBUG LOG</title>"),j.document.write("<body>"),j.document.write("<div id='logChrome' style='width:100%; height:50px; tex-align:center'>"),j.document.write("<br/>"),j.document.write("   <div style='position:absolute; color:black; left:0px; float:left;'>========================== DEBUG "+b+"==========================</div>"),j.document.write("</div>"),j.document.write("</body>"),j.document.write("</html>")),j.focus(),f.length===1?(b=f[0].toUpperCase(),b==="ALL"||b==="*"?m=n=
!0:(m=n=!1,j.document.write("<span style='color:black'>"),j.document.write("//DEBUG: <i>"+b+"</i><br/>"),j.document.write("</span>"))):f.length>1&&(n=!1,m=!0))},debug:function(){var b=arguments;if(!(f.length<1))if(n&&b[1]<=a)k(b);else try{for(var c=b[0].toUpperCase(),d=0;d<f.length;d++){var h=f[d].toUpperCase();c===h&&b[1]<=a&&k(b)}}catch(l){c="";for(d=0;d<b.length;d++)c+="ARG "+d+": ",c+=b[d].toString(),c+=", ";k(["DEBUG ERROR",1,0,"Invalid Debug Statement:",c])}},debugMsg:function(){}}}();debugLib.initialize();
var KindleReaderUI=function(){function e(a){var b=h();KindleModuleManager.getModule(KindleModuleManager.DB_CLIENT).done(function(c){c.getAppDb().updateMaxPosition(Q.getAsin(),b,a)})}function k(a){if(!da)return!1;KindleReaderSelectionRenderer.clearSelection();KindleReaderContextMenu.hide();a.newValue!==null&&KindleReaderSelectionRenderer.setSelection(a.newValue)}function d(a){ta(function(){var b=KindleListUtilities.first(Ca.getBounds(a.selection.end)),c=KindleListUtilities.last(Ca.getBounds(a.selection.start)),
g=$("#kindleReader_content").offset(),f=KindleHostDeviceDetector.isiOS()?25:0,d=KindleHostDeviceDetector.isiOS()?35:0,h;h=b.left+g.left;b=b.bottom+g.top+f;if(document.height-b>80)return[h,b];h=c.left+g.left-d;b=c.top+g.top-80-d;return b>0?[h,b]:"center"}())}function c(){$("#bookmark_overlay_div").addClass("immersive_mode");$("#kindleReader_header").addClass("immersive_mode");$("#kindleReader_footer").addClass("immersive_mode");$("#kindleReader_pageTurnAreaLeft").addClass("immersive_mode");$("#kindleReader_pageTurnAreaRight").addClass("immersive_mode");
$("#immersive_exit").fadeIn("fast")}function b(){KindleReaderImmersiveModeExit.initialize(function(a){$("#kindleReader_book_container").append(a)},l)}function l(){$("#bookmark_overlay_div").removeClass("immersive_mode");$("#kindleReader_header").removeClass("immersive_mode");$("#kindleReader_footer").removeClass("immersive_mode");$("#kindleReader_pageTurnAreaLeft").removeClass("immersive_mode");$("#kindleReader_pageTurnAreaRight").removeClass("immersive_mode");$("#immersive_exit").hide()}function j(){o();
F()}function o(){Z.setSelection(null);KindleReaderPageArrow.setArrowEnabled(KindleRenderer.hasPreviousScreen(),KindleRenderer.hasNextScreen()||!da);da&&(D(),KindleReaderLPRManager.onPageChange(v()),Ua&&Ua())}function f(){if(Da.length>0){var a=v(),b=Da.pop();m(a,b);KindleReaderMetrics.reportBackButtonUsage()}Da.length===0&&KindleReaderHeaderBar.setButtonEnabled(KindleReaderHeaderBar.BUTTON_BACK,!1)}function a(a){n(na.positionFromLocation(a))}function n(a){if(!da&&a>=h())q();else{var b=v();Da.push(b);
Da=Da.slice(-8);KindleReaderHeaderBar.setButtonEnabled(KindleReaderHeaderBar.BUTTON_BACK,!0);m(b,a)}}function m(a,b){KindleReaderMetrics.startGoToMetrics();KindleReaderArrhythmicHeartBeatHandler.cancelCurrentHeartBeat();ua=oa.none;try{KindleRenderer.gotoPosition(b)}catch(c){}o()}function h(){var a=0;try{a=KindleRenderer.getMaximumPosition()}catch(b){a=-1}return a}function p(){var a=h();return a<0?1:na.locationFromPosition(a)}function g(){KindleModuleManager.getModuleSync(KindleModuleManager.DB_CLIENT).getAppDb().getBookExtras(Q.getAsin(),
r)}function r(a){a=a[0];a===void 0?KindleMessageDialog.showError(Kindle.ERROR.BOOKEXTRAS_OPEN_FAILED):KindleHostDeviceDetector.isOnline()?a.isAvailable&&(a.isAvailable===Kindle.BOOKEXTRAS.BEX_CACHED||a.isAvailable===Kindle.BOOKEXTRAS.BEX_ISAVAILABLE)&&pa.openBookExtras(a.asin):a.isAvailable&&a.isAvailable===Kindle.BOOKEXTRAS.BEX_CACHED?pa.openBookExtras(a.asin):KindleMessageDialog.showError(Kindle.ERROR.BOOKEXTRAS_NO_CACHE_ERROR)}function q(){KindleReaderSampleEnd.open(function(a){a==="buy"&&Va()})}
function t(){KindleHostDeviceDetector.isiOS()&&S(!0);if(!Ea)KindleReaderMetrics.startPageTurnTimer(KindleReaderMetrics.NEXT_PAGE),KindleRenderer.hasNextScreen()?KindleReaderArrhythmicHeartBeatHandler.cancelCurrentHeartBeat():da||q(),KindleRenderer.nextScreen()?(setTimeout(KindleReaderMetrics.endPageTurnTimer,0),o(),F(),ua=oa.none):ua=oa.forward}function s(){KindleHostDeviceDetector.isiOS()&&S(!0);if(!Ea)KindleReaderMetrics.startPageTurnTimer(KindleReaderMetrics.PREV_PAGE),KindleRenderer.hasPreviousScreen()&&
KindleReaderArrhythmicHeartBeatHandler.cancelCurrentHeartBeat(),KindleRenderer.previousScreen()?(setTimeout(KindleReaderMetrics.endPageTurnTimer,0),o(),F(),ua=oa.none):ua=oa.back}function v(){return KindleRenderer.getPagePositionRange().currentTopOfPage}function x(){function a(){b.resolve(0)}var b=new jQuery.Deferred;KindleModuleManager.getModuleList([L.BOOK_CONTEXT,L.BOOK_METADATA]).then(function(c){var g=c[L.BOOK_CONTEXT],f=g.srl||c[L.BOOK_METADATA].positions.srl;g.isSample?b.resolve(f):KindleModuleManager.getModule(L.LPR_MANAGER).then(function(a){a=
a.getStartReadingPosition();a.lastTimeRead!==KindleReaderLPRManager.NEVER?(f=a.lastPositionRead,b.resolve(f)):Ma.done(function(){if(Q.getFurthestPositionReadData().position!==Q.UNKNOWN_FPR)f=Q.getFurthestPositionReadData().position;b.resolve(f)})},a)},a);return b.promise()}function O(){KindleSpinner.hide();switch(ua){case oa.back:KindleRenderer.previousScreen();break;case oa.forward:KindleRenderer.nextScreen()}ua=oa.none;o();F();Ea=!1}function z(a){a.indexOf(fb)>=0&&KindleHostDeviceDetector.isiPad1()?
W(a):G(a)}function C(a){a=a[0];if(a===void 0||!a.isAvailable){var b=KindleModuleManager.getModuleSync(KindleModuleManager.DB_CLIENT).getAppDb();$.ajax({url:Kindle.BOOKEXTRAS.BEX_URL+Q.getAsin()+"/Check",type:"GET",dataType:"json",success:function(a){a.isAvailable===!0&&(KindleReaderGoToMenu.updateGoToMenu({4:KindlePopupMenu.ITEM_ENABLED}),b.updateBookExtras(Q.getAsin(),Kindle.BOOKEXTRAS.BEX_ISAVAILABLE,function(){}))}})}else(a.isAvailable===Kindle.BOOKEXTRAS.BEX_ISAVAILABLE||a.isAvailable===Kindle.BOOKEXTRAS.BEX_CACHED)&&
KindleReaderGoToMenu.updateGoToMenu({4:KindlePopupMenu.ITEM_ENABLED})}function G(b){var c=KindleModuleManager.getModuleSync(L.BOOK_METADATA);na=KindleUserLocationConverter.getLocationConverter(b);KindleModuleManager.registerModule(L.LOCATION_CONVERTER,na);KindleReaderMetrics.setBookType(b);var f=na.locationFromPosition(KindleRenderer.getMinimumPosition()),d=na.locationFromPosition(KindleRenderer.getMaximumPosition());KindleReaderLocationBar.setMinMaxLocation(f,d);KindleReaderGoToMenu.bookIsReady({gotoUserLocation:a,
gotoPosition:n,getMaxUserLocation:p,openBookExtras:g},Q);KindleModuleManager.getModuleSync(KindleModuleManager.DB_CLIENT).getAppDb().getBookExtras(Q.getAsin(),C);KindleReaderHeaderBar.setButtonEnabled(KindleReaderHeaderBar.BUTTON_GOTO,!0);KindleReaderHeaderBar.setButtonEnabled(KindleReaderHeaderBar.BUTTON_CONTROL_PANEL,!0);if(da){KindleModuleManager.getModule(L.ANNOTATION_MANAGER).done(va);KindleReaderHeaderBar.setButtonEnabled(KindleReaderHeaderBar.BUTTON_SYNC,!0);e(function(){});D();var h=KindleModuleManager.getModuleSync(L.LPR_MANAGER);
Ma.done(function(){h.onReadingStart(Q.getFurthestPositionReadData(),v(),na,ja);Ua=KindleReaderArrhythmicHeartBeatHandler.onReadingStart(Q.getAsin(),c.guid,Q.getKindleSessionId(),h.getLastPositionRead)})}O();pa.onRendererLoaded(b,!da)}function X(){try{var a={version:"2.0",containerId:"kindleReader_content",bookInfo:Q,startingPositionDfd:x()},b=A();$.extend(b,K());$.extend(b,y());KindleRenderer.initialize(a,b,{statusCallback:P,pageChangeCallback:j,annotationEventCallback:La})}catch(c){}}function T(){Wa?
Xa=!0:(Xa=!1,KindleRenderer.onWindowResize(),D())}function P(a){a.status===KindleRenderer.STATUS_LOADING||a.status===KindleRenderer.STATUS_PAGINATING?(Ea=!0,Z.setSelection(null),KindleSpinner.show(),KindleReaderMetrics.startSpinnerTimer()):a.status===KindleRenderer.STATUS_DONE?ra?(KindleReaderMetrics.endGoToMetrics(),KindleReaderMetrics.endSpinnerTimer(),setTimeout(KindleReaderMetrics.endPageTurnTimer,0),O()):(Q.getBookType().done(z),ra=!0,Ya.resolve(),D()):a.status===KindleRenderer.STATUS_ERROR&&
(a.errorCode===KindleRenderer.ERROR_LOAD_FAILURE?ia(Kindle.ERROR.LOAD_FAILURE):(KindleSpinner.hide(),Ea=!1,KindleReaderMetrics.endGoToMetrics(),KindleReaderMetrics.endSpinnerTimer(),setTimeout(KindleReaderMetrics.endPageTurnTimer,0),F(),KindleMessageDialog.open(ResourceBundle.getLocalizedString("k4w_reader_pageLoadError_Title"),ResourceBundle.getLocalizedString("k4w_reader_pageLoadError_Text")),a.errorCode===KindleRenderer.ERROR_TIMEOUT_WHILE_LOADING_BOOK_CONTENT?KindleReaderMetrics.reportTimeOutMetrics():
KindleReaderMetrics.reportContentNotAvailableMetrics()))}function B(){if(!KindleHostDeviceDetector.isiOS()){var a=gb-M.getMargin();$(".kindleReader_pageTurnArea").css("width",a+"%");$("#kindleReader_pageTurnAreaRight").css("left",100-a+"%");$("#kindleReader_center").css("left",a+"%");$("#kindleReader_center").css("right",a+"%")}}function H(){$("#kindleReader_pageTurnAreaLeft").css("backgroundColor",M.getBodyColor());$("#kindleReader_pageTurnAreaRight").css("backgroundColor",M.getBodyColor());$("#kindleReader_center").css("backgroundColor",
M.getBGColor());$("#kindleReader_title").css("color",M.getTitleColor());$("#kindleReader_book_container").css("backgroundColor",M.getBGColor());$("#kindleReader_book_container").css("color",M.getFGColor());var a=M.getColorMode()===KINDLE_READER_SETTINGS_COLOR_MODE.BLACK;KindleReaderLocationBar.setLocationBarBlack(a);KindleReaderPageArrow.setArrowColor(M.getColorMode())}function F(){if(!(h()<0)){var a=KindleRenderer.getPagePositionRange().currentTopOfPage;a<0&&(a=0);a=na.locationFromPosition(a);KindleReaderLocationBar.updateLocation(a)}}
function I(a){if(bb){switch(a.which){case 32:a.shiftKey?s():t();break;case 37:case 38:case 33:s();break;case 39:case 40:case 34:t()}KindleReaderLocationBar.hidePopup()}}function u(){KindleReaderPageArrow.initialize(function(a){$("#kindleReader_book_container").append(a);B()},s,t)}function A(){var a={},b=M.getFontSize();a.fontSizes=[b*0.5,b*0.75,b,b*1.2,b*1.4,b*1.6,b*1.8];a.fontSizeUnits="px";a.glyphScale=M.getGlyphScale();a.lineHeight=M.getLineHeight();return a}function K(){var a={};a.margin=M.getMargin();
return a}function y(){var a={};a.backgroundColor=M.getBGColor();a.fontColor=M.getFGColor();a.highlightColor=M.getHighlightColor();a.selectionColor=M.getSelectionColor();a.insertBgColor=M.getInsertBGColor();return a}function R(a){var b={},c=M.getFontSize()!==a.getFontSize(),g=M.getMargin()!==a.getMargin(),f=M.getColorMode()!==a.getColorMode();M.copy(a);c&&$.extend(b,A());g&&($.extend(b,K()),B());f&&($.extend(b,y()),H());KindleRenderer.updateSettings(b);M.save(KindleLocalStorage.localStorageObject)}
function W(a){var b=ba.startMetrics("Reader::UnoptimizedBookOpen");KindleUnoptimizedFormatDialog.open(function(c){c?(ba.increaseSubCounter(b,"Continue",1),ba.endMetrics(b),G(a)):(ba.increaseSubCounter(b,"Cancel",1),ba.endMetrics(b),Ga())})}function ja(b){KindleReaderSyncPositionDialog.open(b,function(c){c&&a(b.fprLocation)})}function sa(){function a(b){var b=b.lastPageReadData,c=na.locationFromPosition(v()),g=na.locationFromPosition(b.position);g>c?(ja({currentLocation:c,fprLocation:g,fprDevice:b.deviceName,
fprDateTime:b.syncTime}),KindleReaderLPRManager.updateFprSyncTime(b)):KindleMessageDialog.open(ResourceBundle.getLocalizedString("k4w_reader_syncPosition_title"),ResourceBundle.getLocalizedString("k4w_reader_syncPosition_alreadyFurthest_Text"))}function b(){KindleMessageDialog.showError(Kindle.ERROR.SYNC_FAILED)}if(ra&&Na){var c=KindleModuleManager.getModuleSync(L.BOOK_METADATA);Na.getLPR(Q.getAsin(),c.guid).then(a,b)}}function ca(){KindleReaderBookmarkOverlay.initialize(function(a){$("#kindleReader_book_container").append(a)},
la)}function D(){if(ra&&KindleModuleManager.isModuleInitialized(L.ANNOTATION_MANAGER)){var a=KindleModuleManager.getModuleSync(L.ANNOTATION_MANAGER);za=!1;for(var b=KindleRenderer.getPagePositionRange(),b=a.getAnnotationsInRange(b.currentTopOfPage,b.currentBottomOfPage),c=0;c<b.length;c+=1)if(b[c].type===a.BOOKMARK){za=!0;break}ka()}}function la(){function a(){}if(ra&&KindleModuleManager.isModuleInitialized(L.ANNOTATION_MANAGER)){var b=KindleModuleManager.getModuleSync(L.ANNOTATION_MANAGER),c=KindleRenderer.getPagePositionRange();
if(za)for(var c=b.getAnnotationsInRange(c.currentTopOfPage,c.currentBottomOfPage),g=0;g<c.length;g+=1)c[g].type===KindleReaderAnnotationManager.BOOKMARK&&b.deleteAnnotations([c[g]]).done(a);else b.createBookmark(c.currentTopOfPage).done(a);za=!za;ka()}}function ka(){za?$("#kindleReader_bookmark").addClass("hasBookmark"):$("#kindleReader_bookmark").removeClass("hasBookmark");KindleReaderBookmarkOverlay.setIsBookmarked(za)}function qa(){ra&&KindleModuleManager.isModuleInitialized(L.ANNOTATION_MANAGER)&&
(S(!1),KindleReaderAnnotationsPane.open(),Ka(),KindleReaderAnnotationsPane.scrollToPosition(v()))}function S(a){KindleHostDeviceDetector.isiOS()&&Za!==a&&((Za=a)?($("#kindleReader_book_container").addClass("immersive_mode"),KindleReaderBookmarkOverlay.setImmersiveMode(!0),KindleReaderLocationBar.setImmersiveMode(!0)):($("#kindleReader_book_container").removeClass("immersive_mode"),KindleReaderBookmarkOverlay.setImmersiveMode(!1),KindleReaderLocationBar.setImmersiveMode(!1)))}function V(){Ea||(S(!1),
KindleReaderSettingsDialog.open(M,R))}function U(){KindleReaderMouseLayer.initialize(function(a){$("#kindleReader_book_container").append(a);$(a).click(J);$(a).keyup(I);var b=document,c=document.getElementById("kindleReader_book_container");KindleSelectionEventsMouse.initialize(function(){var a=$("#kindleReader_content");return function(b,c){return Ca.getBookPositionAt(b-a.offset().left,c-a.offset().top)}}(),Z,b,a,c)})}function ta(a){function b(){Z.setSelection(null);KindleRenderer.reloadAnnotations()}
function c(){KindleReaderAnnotationManager.deleteAnnotations(l).done(b)}function g(){KindleReaderAnnotationManager.createHighlight(h.start,h.end,v()).done(b)}function f(){KindleReaderEditNoteDialog.open(null,function(a){a&&KindleReaderAnnotationManager.createNote(h.end,v(),a).done(b)})}function d(){window.alert("Edit Note")}var h=Z.getSelection(),l=KindleReaderAnnotationManager.getAnnotationsInRange(h.start,h.end,KindleReaderAnnotationManager.HIGHLIGHT);(function(){var b=KindlePopupMenu,e=l.length===
1&&l[0].start<=h.start&&l[0].end>=h.end,j=h&&!e?b.ITEM_ENABLED:b.ITEM_HIDDEN,e=e?b.ITEM_ENABLED:b.ITEM_HIDDEN,m=h?b.ITEM_ENABLED:b.ITEM_DISABLED,n=[],o=[];o[KindleReaderContextMenu.CREATE_HIGHLIGHT]=g;o[KindleReaderContextMenu.CREATE_NOTE]=f;o[KindleReaderContextMenu.EDIT_NOTE]=d;o[KindleReaderContextMenu.DELETE_HIGHLIGHT]=c;n[KindleReaderContextMenu.CREATE_HIGHLIGHT]=j;n[KindleReaderContextMenu.CREATE_NOTE]=m;n[KindleReaderContextMenu.EDIT_NOTE]=b.ITEM_HIDDEN;n[KindleReaderContextMenu.DELETE_HIGHLIGHT]=
e;KindleReaderContextMenu.show(n,a,o)})();KindleHostDeviceDetector.isiOS()?$("#kindleReader_book_container").bind("touchstart.contextMenu",function(){KindleReaderContextMenu.hide();$("#kindleReader_book_container").unbind("touchstart.contextMenu")}):$("#kindleReader_book_container").bind("mousedown.contextMenu",function(){KindleReaderContextMenu.hide();$("#kindleReader_book_container").unbind("mousedown.contextMenu")})}function ga(a){function b(){KindleReaderAnnotationManager.deleteAnnotations([c]).done(KindleRenderer.reloadAnnotations);
g.resolve("Delete")}var c=KindleReaderAnnotationManager.getAnnotation(KindleReaderAnnotationManager.NOTE,a),g=new jQuery.Deferred;KindleReaderEditNoteDialog.open(c.note,function(a){a?(KindleReaderAnnotationManager.modifyNote(c.start,v(),a),g.resolve("Save")):b()},b,function(){g.resolve("Cancel")});return g.promise()}function ya(){var a={};a[KindleReaderTouchLayer.EVENT_SWIPE_LEFT]=ma;a[KindleReaderTouchLayer.EVENT_SWIPE_RIGHT]=ea;a[KindleReaderTouchLayer.EVENT_TAP]=Ba;a[KindleReaderTouchLayer.EVENT_TOUCHSTART]=
Y;a[KindleReaderTouchLayer.EVENT_TAP_HOLD]=function(){};KindleReaderTouchLayer.initialize(function(a){$("#kindleReader_book_container").append(a);KindleSelectionEventsTouch.initialize(function(){var a=$("#kindleReader_content");return function(b,c){return Ca.getBookPositionAt(b-a.offset().left,c-a.offset().top)}}(),Z,a,KindleReaderSelectionRenderer.getGrabHandleBegin(),KindleReaderSelectionRenderer.getGrabHandleEnd())},a)}function ma(){Z.getSelection()||t()}function ea(){Z.getSelection()||s()}function J(a){var b=
a.pageX-$("#kindleReader_content").offset().left,a=a.pageY-$("#kindleReader_content").offset().top;ra&&b>0&&a>0&&KindleRenderer.handleClick(b,a)}function Y(a){var b=a.originalEvent.touches[0].pageX-$("#kindleReader_content").offset().left,a=a.originalEvent.touches[0].pageY-$("#kindleReader_content").offset().top;ra&&b>0&&a>0&&KindleRenderer.handleClick(b,a)}function Ba(){var a=this.x-$("#kindleReader_content").offset().left,b=this.y-$("#kindleReader_content").offset().top;if((!ra||!(a>0&&b>0)||!KindleRenderer.handleClick(a,
b))&&!Z.getSelection())b=$("#kindleReader_content").width(),a<b/4?s():a>b-b/4?t():S(!Za)}function Pa(){S(!1);ua=oa.none;KindleReaderGoToMenu.show()}function Ga(){da?Ja():(Va(),$a=!0)}function Ha(){var a=KindleReaderHeaderBar,b={};b[a.BUTTON_CLOSE]=Ga;b[a.BUTTON_GOTO]=Pa;b[a.BUTTON_CONTROL_PANEL]=V;b[a.BUTTON_BOOKMARK]=la;b[a.BUTTON_SYNC]=sa;b[a.BUTTON_NOTE]=qa;b[a.BUTTON_IMMERSIVE]=c;b[a.BUTTON_BACK]=f;a.initialize(function(a){$("#kindleReader_book_container").append(a)},b)}function Qa(){KindleReaderLocationBar.initialize(function(a){$("#kindleReader_center").append(a)},
a)}function Ta(){$(document).keyup(I);KindleUXComponentManager.registerKeyEventsEnabledCallback(function(a){bb=a})}function fa(){function a(){clearTimeout(b);b=setTimeout(T,200);$("#kindleReader_annotations_pane").height($("body",top.document).height()-212);$("#kindleReader_annotations_pane_scrollWrapper").height($("body",top.document).height()-212)}var b;KindleHostDeviceDetector.isiOS()&&"onorientationchange"in window?$("body",top.document).bind("orientationchange",a):window.onresize=a}function Ka(){function a(b){n(b.start)}
function b(a){KindleReaderAnnotationManager.deleteAnnotations([a]).done(function(){D();KindleRenderer.reloadAnnotations()})}function c(a,b){a?KindleReaderAnnotationManager.modifyNote(b.start,b.position,a):KindleReaderAnnotationManager.deleteAnnotations([b]).done(function(){KindleRenderer.reloadAnnotations()})}KindleModuleManager.isModuleInitialized(L.ANNOTATION_MANAGER)&&KindleModuleManager.getModuleList([L.ANNOTATION_MANAGER,L.LOCATION_CONVERTER]).done(function(g){var f=g[L.LOCATION_CONVERTER],g=
g[L.ANNOTATION_MANAGER].getAllAnnotations();KindleReaderAnnotationsPane.loadAnnotations(g,f,a,b,c)})}function La(a,b){KindleHostDeviceDetector.isiOS()&&S(!1);a===KindleReaderAnnotationManager.NOTE&&ga(b).then(function(a){ba.addEvent("Reader::Icon::"+a)})}function Ia(){Ja()}function Ja(){KindleRenderer.shutdown();ba&&(cb=ba.startMetrics("App::CloseReader"),ba.uploadMetrics());if(da){KindleReaderArrhythmicHeartBeatHandler.onReadingEnd();if(KindleModuleManager.isModuleInitialized(L.LPR_MANAGER)&&KindleModuleManager.isModuleInitialized(KindleModuleManager.SERVICE_CLIENT)){var a=
KindleModuleManager.getModuleSync(L.LPR_MANAGER).getLastPositionRead();Na.doneReading({asin:Q.getAsin(),kindleSessionId:Q.getKindleSessionId(),position:a,localTimeOffset:KindleLocale.getLocalTimeOffset(),countryCode:KindleLocale.getCountryCode(),guid:KindleModuleManager.getModuleSync(L.BOOK_METADATA).guid})}Q.doneReading()}pa.closeReader(cb);KindleTouchEventsToggler.isRequired()&&KindleTouchEventsToggler.disallowTouchEvents()}function Aa(){B();ca();b();Ha();Qa();KindleHostDeviceDetector.isiOS()?ya():
(u(),U());H();Ta();fa();window.oncontextmenu=function(){return!1};KindleHostDeviceDetector.isiOS()||$(window).focus(function(){Na.checkTokenConsistency()})}function aa(){Q.getDownloadComplete(function(a,b){KindleReaderLocationBar.updateDownloadProgress(KindleReaderLocationBar.DOWNLOAD_IN_PROGRESS,Math.round(100*Math.min(a,b)/Math.max(1,b)))}).then(function(){KindleReaderLocationBar.updateDownloadProgress(KindleReaderLocationBar.DOWNLOAD_COMPLETED)},function(a){if(a)switch(a){case Kindle.ERROR.OUT_OF_SPACE:case Kindle.ERROR.UNKNOWN_DB_ERROR:KindleReaderLocationBar.updateDownloadProgress(KindleReaderLocationBar.DOWNLOAD_DISK_ERROR);
break;case Kindle.ERROR.NETWORK:case Kindle.ERROR.TIMEOUT:KindleReaderLocationBar.updateDownloadProgress(KindleReaderLocationBar.DOWNLOAD_NETWORK_ERROR)}})}function Sa(a){if(a&&a.asin)Oa=a.metricsId,db=a.standAlone,a.isSample&&KindleHostDeviceDetector.isiOS()&&KindleReaderHeaderBar.setCloseButtonEnabled(ResourceBundle.getLocalizedString("k4w_reader_toolbar_iOS_sample_close_button")),Fa&&KindleSpinner.show(),Q=KindleReaderBookInfoProvider.BookInfo(a,KindleModuleManager),Oa?ba.endSubTimer(Oa,"initialize"):
Oa=ba.startMetrics("Reader:Open"),Ma=Q.startReading(Oa,ia),Ma.done(function(){Q.isBookDownloaded()||aa()}),ha(a.asin),Ma.done(Ra).fail(ia),KindleModuleManager.getModule(L.BOOK_METADATA).done(wa),X(),window.focus(),Ya.done(function(){KindleNotificationDialog.showIfAppropriate({bookIsOwned:da,targetElement:$("#kindleReader_button_note")})}),KindleTouchEventsToggler.isRequired()&&ab.done(function(){KindleTouchEventsToggler.allowTouchEvents()})}function ha(a){KindleModuleManager.getModule(L.BOOK_CONTEXT).done(function(b){var jb;
jb=(da=!b.isSample)?ResourceBundle.getLocalizedString("k4w_reader_toolbar_library_button"):ResourceBundle.getLocalizedString("k4w_reader_toolbar_iOS_sample_close_button"),b=jb;KindleReaderHeaderBar.setCloseButtonEnabled(b);da&&(KindleModuleManager.registerModuleWithDeferred(KindleModuleManager.JOURNAL_MANAGER,KindlJournalManager.initialize()),KindleModuleManager.registerModuleWithDeferred(L.ANNOTATION_MANAGER,KindleReaderAnnotationManager.deferredInitialize(a)),KindleModuleManager.registerModuleWithDeferred(L.LPR_MANAGER,
KindleReaderLPRManager.initialize(a)))})}function Ra(a){pa.onStartReadingStatus(!0,null,a)}function ia(a){if(!eb&&a!==KindleModuleManager.ERROR_CODE_CANCEL){eb=!0;var b=xa(a);db?KindleMessageDialog.showError(a,b):b()}}function xa(a){return function(){pa.onStartReadingStatus(!1,a)}}function wa(a){a.title&&$("#kindleReader_title").text(a.title)}function va(){KindleReaderHeaderBar.setButtonEnabled(KindleReaderHeaderBar.BUTTON_BOOKMARK,!0);KindleReaderHeaderBar.setButtonEnabled(KindleReaderHeaderBar.BUTTON_NOTE,
!0);D();KindleRenderer.reloadAnnotations()}function w(){}function E(){Wa=!0}function N(){Wa=!1;Xa&&T()}function hb(a){KindleSpinner.hide();a===Kindle.STORE.GENERIC_ERROR?$a?KindleMessageDialog.showError(Kindle.ERROR.STORE_OPEN_FAILED,Ia):KindleMessageDialog.showError(Kindle.ERROR.STORE_OPEN_FAILED):a===Kindle.STORE.OFFLINE_ERROR&&($a?KindleMessageDialog.showError(Kindle.ERROR.STORE_OPEN_OFFLINE_FAILED,Ia):KindleMessageDialog.showError(Kindle.ERROR.STORE_OPEN_OFFLINE_FAILED))}function ib(a){KindleSpinner.hide();
a===Kindle.BOOKEXTRAS.GENERIC_ERROR&&KindleMessageDialog.showError(Kindle.ERROR.BOOKEXTRAS_OPEN_FAILED)}function Va(){KindleSpinner.show();pa.openStore(Q.getAsin())}var gb=30,fb="topaz",M,ab,Q,Ma,da,za=null,na,ra=!1,Ya,oa={none:0,back:-1,forward:1},ua=oa.none,Za=!1,bb=!0,Oa,cb,Fa,pa,ba,Na,Ea=!0,$a=!1,db=!1,eb=!1,Wa=!1,Xa=!1,Da=[],Z=null,Ca=null,Ua,L={ANNOTATION_MANAGER:"annotation_manager",LPR_MANAGER:"lpr_manager",BOOK_METADATA:"book_metaData",BOOK_CONTEXT:"book_context",LOCATION_CONVERTER:"locationConverter"};
return{initialize:function(){ab=new jQuery.Deferred;Fa=window.parent.KindleApp;Ya=new jQuery.Deferred;KindleTouchEventsToggler.isRequired()&&KindleTouchEventsToggler.initialize();Fa&&(M=new KindleReaderSettings,M.reset(),M.load(KindleLocalStorage.localStorageObject),Z=KindleSelectionStateManagerFactory(),Z.addEventListener(Z.SELECTION_CHANGED_EVENT,k),Z.addEventListener(Z.PROCESS_SELECTION_EVENT,d),Ca=KindleSelectionHelper(KindleRenderer.getPageSelectableItemBoundaries),KindleReaderSelectionRenderer.initialize(Ca),
$("body").bind("touchmove.elastic",KindleIOSScrollStopper.stopScroll),pa=Fa.getAppInterfaceForReader(),KindleInterfaces.assertImplements(pa,KindleInterfaces.IKindleAppForReader),Fa.getSharedModules().done(function(a){Kindle=a[KindleModuleManager.CONSTANTS];KindleModuleManager.registerModuleList(a);ba=a[KindleModuleManager.METRICS_MANAGER];Na=a[KindleModuleManager.SERVICE_CLIENT];Fa.setReaderInterface({openBook:Sa,unloadReader:w,onStoreOpenStatus:hb,onBookExtrasOpenStatus:ib,pauseReader:E,resumeReader:N});
pa.onReaderReady();a=KindleRenderer.PAGE_LOAD_INCOMPLETE_FLAG_NAME;KindleLocalStorage.localStorageObject.getItem(a)&&(ba.addEvent("Reader::PageLoadIncomplete"),KindleLocalStorage.localStorageObject.removeItem(a))}),Aa(),KindleTouchEventsToggler.isRequired()&&KindleTouchEventsToggler.disallowTouchEvents());ab.resolve()},gotoPosition:n,openStoreDP:Va,leaveDesktopImmersiveMode:l}}(),KindleLibraryBookCover=function(){function e(){o||(o=KindleHostDeviceDetector.isiPad()?b:c);return o}function k(b){j||
(j=d,j=j.replace("{width}",e().width),j=j.replace("{height}",e().height));var a=j;return a=a.replace("{asin}",b)}var d="/cover/{asin}.01._SX{width}_SY{height}_SCLZZZZZZZ_.jpg",c={width:255,height:255},b={width:255,height:255},l=null,j=null,o=null;return{getBookCoverUrl:function(b){l||(l="https://images-na.ssl-images-amazon.com/images/P/{asin}.01._SX{width}_SY{height}_SCLZZZZZZZ_.jpg",l=l.replace("{width}",e().width),l=l.replace("{height}",e().height));var a=l;return a=a.replace("{asin}",b)},getOfflineCover:function(b){var a=
new jQuery.Deferred,b=k(b);$.ajax({url:b,beforeSend:function(a){a.overrideMimeType("text/plain; charset=x-user-defined")},success:function(b){b="data:image/jpeg;base64,"+KindleO_Aaa.o_aaa(b);a.resolve(b)},error:a.reject});return a.promise()}}}(),KindleReaderAnnotationManager=function(){function e(a,b){return a.start-b.start}function k(a){var b=new jQuery.Deferred;b.then(function(){for(var b=0;b<a.length;b++)P.addEvent(l(a[b]))},function(){for(var b=0;b<a.length;b++)P.addEvent(l(a[b],"Fail"))});f(a);
for(var c=0;c<a.length;c++)if(a[c].asin===void 0||a[c].guid===void 0||a[c].start===void 0||a[c].type===void 0)return P.addEvent(l(a[c],"Invalid")),KindleDebug.error("Tried to delete an invalid annotation."),b.reject().promise();T.saveToJournal(a).then(function(){d(a).then(b.resolve,b.reject)},b.reject);return b.promise()}function d(a){function b(){for(var f,d=!1,h,l=0;l<a.length;l++)h=a[l],f=c(h.type,h.start),h.action===r?f===-1&&(C.push(h),d=!0):h.action===q?f!==-1&&(C.splice(f,1),C.push(h),d=!0):
h.action===t&&f!==-1&&C.splice(f,1);d&&C.sort(e);g.resolve();m()}var g=new jQuery.Deferred;n().then(b,b);return g.promise()}function c(a,b){for(var c in C){var g=C[c];if(g.type===a&&g.start===b)return c}return-1}function b(a,b){return C[c(a,Number(b))]||null}function l(a,b){var c="Reader::"+v[a.action]+v[a.type];b&&(c+=b);return c}function j(a){for(var b=(new Date).getTime(),c=0;c<a.length;c++)a[c].asin=x,a[c].guid=O,a[c].action=r,a[c].modifiedTimestamp=b;return a}function o(a){for(var b=0;b<a.length;b++)a[b].action=
t;return a}function f(a){for(var b=0;b<a.length;b++)a[b].positionType=z;return a}function a(a){j(a);return k(a)}function n(){function a(c){c[0]&&(C=c[0].annotationsData);b.resolve()}var b=new jQuery.Deferred;G?G.getRecord(s,{asin:x},{annotationsData:!0}).then(a,b.reject):b.reject();return b.promise()}function m(){var a=new jQuery.Deferred;G?G.insertRecord(s,{asin:x,annotationsData:C}).then(a.resolve,a.reject):a.reject();return a.promise()}function h(){function a(){c.resolve()}function b(){c.resolve()}
var c=new jQuery.Deferred;X.getAnnotations(x,O).then(function(c){C=c.annotations;m().then(a,b)},c.reject);return c.promise()}function p(){function a(){n().then(c.reject,c.reject)}function b(){h().then(c.resolve,a)}var c=new jQuery.Deferred;T.uploadJournal().then(b,b);return c.promise()}function g(a){function b(){c.resolve(g);KindleReaderMetrics.notifyAnnotationsReady()}var c=new jQuery.Deferred,g=this;C=[];x=a;KindleModuleManager.getModuleList([KindleModuleManager.BOOK_METADATA,KindleModuleManager.BOOK_FRAGMAP,
KindleModuleManager.SERVICE_CLIENT,KindleModuleManager.DB_CLIENT,KindleModuleManager.JOURNAL_MANAGER,KindleModuleManager.METRICS_MANAGER]).then(function(a){O=a[KindleModuleManager.BOOK_METADATA].guid;z=a[KindleModuleManager.BOOK_FRAGMAP].fragmentMetadata.bookType;X=a[KindleModuleManager.SERVICE_CLIENT];G=a[KindleModuleManager.DB_CLIENT].getBookDb();T=a[KindleModuleManager.JOURNAL_MANAGER];P=a[KindleModuleManager.METRICS_MANAGER];p().then(b,b)},c.reject);return c.promise()}var r="create",q="modify",
t="delete",s="annotationsCache",v={"kindle.bookmark":"Bookmark","kindle.note":"Note","kindle.highlight":"Highlight"};v[r]="Create";v[q]="Modify";v[t]="Delete";var x=null,O=null,z=null,C=null,G=null,X=null,T=null,P;return{BOOKMARK:"kindle.bookmark",NOTE:"kindle.note",HIGHLIGHT:"kindle.highlight",initialize:function(a){return g(a)},deferredInitialize:g,clear:function(){},getAnnotation:b,getAllAnnotations:function(){return C.slice()},getAnnotationsInRange:function(a,b,c){var g=[],f;for(f in C){var d=
C[f];(d.start<=b&&d.end>=a||d.start>=a&&d.start<=b)&&(!c||c===d.type)&&g.push(d)}return g},createBookmark:function(b){b={type:"kindle.bookmark",start:b,position:b,end:b,context:KindleRenderer.getDisplayedText(b,b+100)};return a([b])},createNote:function(b,c,g){return a([{type:"kindle.note",start:b,position:c,end:b,note:g}])},modifyNote:function(a,c,g){var f=new jQuery.Deferred;if(a=b("kindle.note",a)){a.note=g;a.position=c;c=[a];g=(new Date).getTime();for(a=0;a<c.length;a++)c[a].action=q,c[a].modifiedTimestamp=
g;k(c).then(f.resolve,f.reject)}else f.reject();return f.promise()},createHighlight:function(a,b,c){var g=KindleReaderAnnotationManager.getAnnotationsInRange(a,b,"kindle.highlight"),f=g.length,c={type:"kindle.highlight",start:a,position:c,end:b},d=[];if(g.length===1&&a>=g[0].start&&b<=g[0].end)return(new jQuery.Deferred).resolve([g[0]]);if(f>0)c.start=Math.min(a,g[0].start),c.end=Math.max(b,g[f-1].end),d.push.apply(d,o(g));c.context=KindleRenderer.getDisplayedText(c.start,c.end);d.push.apply(d,j([c]));
return k(d)},deleteAnnotations:function(a){o(a);return k(a)}}}(),KindleReaderArrhythmicHeartBeatHandler=function(){function e(){return h!==void 0}function k(){}function d(){}function c(){b();navigator.onLine&&(m=setTimeout(l,f))}function b(){clearTimeout(m);clearTimeout(h)}function l(){var b=n();(p?p:KindleModuleManager.getModuleSync(KindleModuleManager.SERVICE_CLIENT)).stillReading({asin:g,position:b,localTimeOffset:s,countryCode:t,guid:r,kindleSessionId:q}).then(k,d);m=void 0;navigator.onLine&&
(h=setTimeout(j,a))}function j(){h=void 0}function o(){clearTimeout(m);m=void 0;clearTimeout(h);r=g=h=void 0}var f=5E3,a=6E5,n,m,h,p,g,r,q,t="US",s=-(new Date).getTimezoneOffset();return{onReadingStart:function(a,b,f,d){if(a!==g)return e()&&o(),g=a,r=b,q=f,n=d,l(),c},onReadingEnd:o,isStillReading:e,setNetworkModule:function(a){p=a},handleHeartBeat:c,cancelCurrentHeartBeat:b}}(),KindleReaderLPRManager=function(){function e(b){c.getAppDb().updateLastReadTime(k,(new Date).getTime(),b,function(){})}var k,
d,c;return{NEVER:-1,initialize:function(b){var l=new jQuery.Deferred,e=this;k=b;KindleModuleManager.getModule(KindleModuleManager.DB_CLIENT).done(function(b){c=b;c.getAppDb().getBook(k,function(b){d={lastPositionRead:b.lastPositionRead,lastTimeRead:b.lastTimeRead?b.lastTimeRead:-1,lastSyncTime:b.lastFPRSyncTime};l.resolve(e)})});return l.promise()},clear:function(){d=k=void 0},getLastPositionRead:function(){return d.lastPositionRead},onReadingStart:function(b,c,j,o){c=j.locationFromPosition(c);j=
j.locationFromPosition(b.position);j>c&&d.lastTimeRead!==-1&&b.syncTime!==d.lastSyncTime&&o({currentLocation:c,fprLocation:j,fprDevice:b.deviceName,fprDateTime:b.syncTime});e(b.syncTime)},onPageChange:function(b){d.lastPositionRead=b;d.lastTimeRead=(new Date).getTime();c.getAppDb().updateLastPositionRead(k,d.lastPositionRead,d.lastTimeRead,function(b){b&&(b.code===Kindle.DB.DATABASE_ERR||b.code===Kindle.DB.SYNTAX_ERR)&&b.message.indexOf("no such table")>=0&&KindleModuleManager.getModuleSync(KindleModuleManager.APP_REGISTRATION).deregister()})},
onReadingEnd:function(){k=null;d=void 0},getStartReadingPosition:function(){return d},updateFprSyncTime:function(b){b.syncTime!==d.lastSyncTime&&c.getAppDb().updateLastFPRSyncTime(k,b.syncTime,function(){})}}}(),KindleReaderMetrics=function(){function e(){m||(m=KindleModuleManager.getModuleSync(KindleModuleManager.METRICS_MANAGER));return m}var k,d=!1,c,b={NEXT_PAGE:"Reader::NextPageSpinner::",PREV_PAGE:"Reader::PrevPageSpinner::"},l={NEXT_PAGE:"Reader::NextPage::",PREV_PAGE:"Reader::PrevPage::"},
j,o,f,a,n="",m,h=null;return{NEXT_PAGE:0,PREV_PAGE:1,setBookType:function(a){n=a},startGoToMetrics:function(){k=e().startMetrics("Reader::GoToPosition::"+n)},endGoToMetrics:function(){k&&(e().endMetrics(k,!1),k=null)},startPageTurnTimer:function(a){d||(d=!0,a===0&&!j?(j=e().startMetrics(l.NEXT_PAGE+n),c=a):a===1&&!o&&(o=e().startMetrics(l.PREV_PAGE+n),c=a))},endPageTurnTimer:function(){d&&(c===0&&j?(e().endMetrics(j,!1),e().addEvent("Reader::NextPage:Version",[e().VERSION]),j=null):c===1&&o&&(e().endMetrics(o,
!1),o=null),d=!1)},startSpinnerTimer:function(){d&&(c===0&&!f?f=e().startMetrics(b.NEXT_PAGE+n):c===1&&!a&&(a=e().startMetrics(b.PREV_PAGE+n)))},endSpinnerTimer:function(){d&&(c===0&&f?(e().endMetrics(f,!1),f=null):c===1&&a&&(e().endMetrics(a,!1),a=null))},reportContentNotAvailableMetrics:function(){e().addEvent("Reader::ContentNotAvailableOffline")},reportTimeOutMetrics:function(){e().addEvent("Reader::PageTurnTimeOut::"+n)},reportBackButtonUsage:function(){e().addEvent("Reader::BackButton",!1)},
notifyAnnotationsReady:function(){h&&e().cancelMetrics(h);h=e().startMetrics("Reader::OpenAnnotationsPane::Time")},reportAnnotationsPaneOpened:function(){e().addEvent("Reader::OpenAnnotationsPane");h&&(e().endMetrics(h),h=null)}}}(),KindleReaderSelectionRenderer=function(){var e=null,k=null,d=null,c=KindleHostDeviceDetector.isiOS();return{initialize:function(b){d=b;c&&(e=document.createElement("DIV"),$(e).addClass("amazon-grabHandleBegin"),$(e).hide(),$("body").append(e),k=document.createElement("DIV"),
$(k).addClass("amazon-grabHandleEnd"),$(k).hide(),$("body").append(k))},getGrabHandleBegin:function(){return e},getGrabHandleEnd:function(){return k},setSelection:function(b){KindleRenderer.setSelection(b);if(c){var l=KindleListUtilities.first(d.getBounds(b.start)),b=KindleListUtilities.last(d.getBounds(b.end)),j=$("#kindleReader_content");e.style.top=l.top+j.offset().top+"px";e.style.left=l.left+j.offset().left+"px";k.style.top=b.bottom+j.offset().top+"px";k.style.left=b.right+j.offset().left+"px";
$(e).show();$(k).show()}},clearSelection:function(){KindleRenderer.clearSelection();c&&($(e).hide(),$(k).hide())}}}(),KINDLE_READER_SETTINGS_COLOR_MODE={WHITE:{id:"#kindleReader_controlPanel_colorWhite",persistedValue:0},SEPIA:{id:"#kindleReader_controlPanel_colorSepia",persistedValue:1},BLACK:{id:"#kindleReader_controlPanel_colorBlack",persistedValue:2}},KINDLE_READER_SETTINGS_FONT_SIZE={XSMALL:{id:"#kindleReader_controlPanel_xSmallFont",size:14},SMALL:{id:"#kindleReader_controlPanel_smallFont",
size:16},MEDIUM:{id:"#kindleReader_controlPanel_mediumFont",size:20},LARGE:{id:"#kindleReader_controlPanel_largeFont",size:28},XLARGE:{id:"#kindleReader_controlPanel_xLargeFont",size:44}},KINDLE_READER_SETTINGS_GLYPH_SCALE={14:1,16:1.25,20:1.5,28:2,44:3},KINDLE_READER_SETTINGS_MARGIN={XSMALL:{id:"#kindleReader_controlPanel_xSmallMargin",size:0},SMALL:{id:"#kindleReader_controlPanel_smallMargin",size:10},MEDIUM:{id:"#kindleReader_controlPanel_mediumMargin",size:18},LARGE:{id:"#kindleReader_controlPanel_largeMargin",
size:20},XLARGE:{id:"#kindleReader_controlPanel_xLargeMargin",size:22}},KINDLE_READER_SETTINGS_PAGE_MODE={ONE_PAGE:{id:"#kindleReader_controlPanel_onePage",persistedValue:0},TWO_PAGE:{id:"#kindleReader_controlPanel_twoPage",persistedValue:1}},KindleReaderSettings=function(){var e=KINDLE_READER_SETTINGS_FONT_SIZE.MEDIUM.size,k=KINDLE_READER_SETTINGS_MARGIN.MEDIUM.size,d=KINDLE_READER_SETTINGS_COLOR_MODE.WHITE,c=KINDLE_READER_SETTINGS_PAGE_MODE.ONE_PAGE;return function(){var b,l,j,o,f,a,n,m,h,p;this.copy=
function(a){b=a.getFontSize();l=a.getMargin();h=a.getPageDisplayMode();this.setColorMode(a.getColorMode())};this.reset=function(){b=e;l=k;h=c;this.setColorMode(d)};this.getFontSize=function(){return b};this.getGlyphScale=function(){return KINDLE_READER_SETTINGS_GLYPH_SCALE[b]};this.setFontSize=function(a){b=a};this.getMargin=function(){return l};this.setMargin=function(a){l=a};this.getLineHeight=function(){return 1.4};this.setPageDisplayMode=function(a){h=a};this.getPageDisplayMode=function(){return h};
this.getBGColor=function(){return o};this.getFGColor=function(){return f};this.getBodyColor=function(){return a};this.getTitleColor=function(){return n};this.getHighlightColor=function(){return m};this.getSelectionColor=function(){return selectionColor};this.getColorMode=function(){return j};this.getInsertBGColor=function(){return p};this.setColorMode=function(b){b===KINDLE_READER_SETTINGS_COLOR_MODE.WHITE?(o="#ffffff",f="#111111",a="#ffffff",n="#999999",m="#fff5ad",selectionColor="#cdd0d4",p="#cccccc"):
b===KINDLE_READER_SETTINGS_COLOR_MODE.SEPIA?(o="#FBF0D9",f="#5F4B32",a="#FBF0D9",n="#84725B",m="#fff5ad",selectionColor="#d7d0c0",p="#d8c69f"):b===KINDLE_READER_SETTINGS_COLOR_MODE.BLACK&&(o="#000000",f="#FFFFFF",a="#000000",n="#999999",m="#0061a7",selectionColor="#6d6d6d",p="#333333");j=b};this.save=function(a){if(a)try{a.setItem("KindleReaderSettings.fontSize",b),a.setItem("KindleReaderSettings.margin",l),a.setItem("KindleReaderSettings.pageDisplayMode",h.persistedValue),a.setItem("KindleReaderSettings.colorMode",
j.persistedValue)}catch(c){}};this.load=function(a){if(a){a.getItem("KindleReaderSettings.fontSize")!==null&&(b=parseInt(a.getItem("KindleReaderSettings.fontSize"),10));a.getItem("KindleReaderSettings.margin")!==null&&(l=parseInt(a.getItem("KindleReaderSettings.margin"),10));if(a.getItem("KindleReaderSettings.pageDisplayMode")!==null){var c=parseInt(a.getItem("KindleReaderSettings.pageDisplayMode"),10),f;for(f in KINDLE_READER_SETTINGS_PAGE_MODE)KINDLE_READER_SETTINGS_PAGE_MODE[f].persistedValue===
c&&this.setPageDisplayMode(KINDLE_READER_SETTINGS_PAGE_MODE[f])}if(a.getItem("KindleReaderSettings.colorMode")!==null){var a=parseInt(a.getItem("KindleReaderSettings.colorMode"),10),d;for(d in KINDLE_READER_SETTINGS_COLOR_MODE)KINDLE_READER_SETTINGS_COLOR_MODE[d].persistedValue===a&&this.setColorMode(KINDLE_READER_SETTINGS_COLOR_MODE[d])}}}}}(),KindleSelectionEventsMouse=function(){function e(b){l=!0;f=o=!1;j=a(b.pageX,b.pageY);n.setSelection(null);b.preventDefault()}function k(b){if(l){l=!1;if(o&&
n.getSelection()){var c=a(b.pageX,b.pageY);n.setSelection({start:Math.min(j,c),end:Math.max(j,c)});n.processSelection()}b.stopPropagation()}o=!1}function d(b){o=!0;if(l){var c=a(b.pageX,b.pageY);n.setSelection({start:Math.min(j,c),end:Math.max(j,c)});f=!0}else f=!1;b.stopPropagation()}function c(b){var c=a(b.pageX,b.pageY);n.setSelection({start:c,end:c});n.processSelection();b.stopPropagation()}function b(){f||n.setSelection(null)}var l=!1,j,o=!1,f=!1,a,n;return{initialize:function(f,h,l,g,j){a=f;
n=h;$(g).dblclick(c);$(g).mousedown(e);$(l).mousemove(d);$(l).mouseup(k);$(j).click(b)}}}(),KindleSelectionEventsTouch=function(){function e(){j=!0;o=!1;n=a.getSelection().end;return!1}function k(){j=!1;o=!0;n=a.getSelection().start;return!1}function d(){!j&&!o&&a.setSelection(null)}function c(){a.getSelection()&&(a.processSelection(),o=j=!1,n=null)}function b(b){setTimeout(function(){if(n&&(j||o)){var c=a.getSelection(),d=f(b.originalEvent.touches[0].pageX,b.originalEvent.touches[0].pageY);j?a.setSelection({start:Math.min(n,
d),end:c.end}):o&&a.setSelection({start:c.start,end:Math.max(n,d)})}},10)}function l(b){b=f(b.startX,b.startY);a.setSelection({start:b,end:b});a.processSelection()}var j=!1,o=!1,f,a,n=null;return{initialize:function(j,h,n,g,o){f=j;a=h;$(g).bind("touchstart",e);$(g).bind("touchmove",b);$(g).bind("touchend",c);$(o).bind("touchstart",k);$(o).bind("touchmove",b);$(o).bind("touchend",c);n.bind("touchstart",d);n.tapHold(l)}}}();
KindleSelectionHelper=function(e){return{getBookPositionAt:function(k,d){var c=e(),b=Infinity,l=null,j;for(j in c)for(var o=c[j],f=0;f<o.length;f++){var a;a=o[f];var n=void 0,m=void 0,n=k<a.left?a.left-k:k<a.right?0:k-a.right,m=d<a.top?a.top-d:d<a.bottom?0:d-a.bottom;a=n*n+m*m;if(a<b&&(b=a,l=j,a<=0))break}return+l},getBounds:function(k){return e()[k]||null}}};
var KindleSelectionStateManagerFactory=function(){function e(){return d?{start:d.start,end:d.end}:null}var k=ListenerManager(),d=null;k.setEventProperties("selectionChanged",{vetoable:!0});return{SELECTION_CHANGED_EVENT:"selectionChanged",PROCESS_SELECTION_EVENT:"processSelection",addEventListener:k.addEventListener,setSelection:function(c){if(c&&(!c.start||!c.end))KindleDebug.error("KindleSelectionStateManager - setSelection() received a parameter with null start or end");else{if(c&&(c.start=Number(c.start),
c.end=Number(c.end),c.start>c.end)){var b=c.start;c.start=c.end;c.end=b}c===null&&d===null||c!==null&&d!==null&&c.start===d.start&&c.end===d.end||(b=e(),k.callEventListeners("selectionChanged",{type:"selectionChanged",oldValue:b,newValue:c})&&(d=c))}},processSelection:function(){d&&k.callEventListeners("processSelection",{type:"processSelection",selection:e()})},getSelection:e}},KindleUserLocationConverter;
KindleUserLocationConverter=function(){function e(){return{locationFromPosition:function(b){return Math.floor(b*2/300+1)},positionFromLocation:function(b){b*=100;b<100&&(b=100);return Math.floor((b-100)*3/2)},flavor:function(){return d}}}function k(){return{locationFromPosition:function(c){return Math.floor((c*b+100)/100)},positionFromLocation:function(c){c*=100;c<100&&(ASSERT(0),c=100);return Math.floor((c-100)/b)},flavor:function(){return c}}}var d="mobi",c="topaz",b=3;return{MOBI_FLAVOR:d,TOPAZ_FLAVOR:c,
mobiLocationConverter:e,topazLocationConverter:k,getLocationConverter:function(b){return b==="topaz"?k():e()}}}();
var KindleGlyphRenderer=function(){function e(a,b,c,f,d,h,e,j){b=b[f.imgSrc];if(c.getContext&&b!==void 0){var l=new Image,m=f.o;m||(m=[0,0]);l.onload=function(){if(a===g){var b=m,f=c,l=f.getContext("2d"),n=b[0]*d/1440,b=b[1]*d/1440,o={x:n,y:b,w:this.width*h,h:this.height*h};e[f.id]||(e[f.id]=[]);f=e[f.id];f[f.length]=o;l.translate(n,b);l.scale(h,h);l.drawImage(this,0,0);l.scale(1/h,1/h);l.translate(-n,-b);c=null}setTimeout(j,25)};l.src=b;f=b=b=null}else setTimeout(j,10)}function k(a,b,c,f){if(b.getContext){var g=
c.o;g||(g=[0,0]);var h=b.getContext("2d");h.translate(g[0]*f/1440,g[1]*f/1440);h.fillStyle=d(b);for(var e,l,j,m,n,o=c.l.length,k=0;k<o;k++){a:{e=c.l[k][0];j=void 0;for(n=0;n<a.length;n+=1)if(j=a[n].glyphFragmentMetadata,e>=j.startingGlyph&&e<=j.endingGlyph){j=e-j.startingGlyph;e=a[n].glyphData[j];break a}e=null}if(e!==null){j=c.l[k][1]+c.p[0];m=c.l[k][2]+c.p[1];n=f/e.dpi;j=(j-c.p[0])*f/1440;m=(m-c.p[1])*f/1440;h.translate(j,m);h.scale(n,n);h.beginPath();for(var p=e.c.length,r=0;r<p;r++){var q=e.c[r];
h.moveTo(q[0],q[1]);l=q.length-6;for(var t=2;t<l;t+=6)h.bezierCurveTo(q[t],q[t+1],q[t+2],q[t+3],q[t+4],q[t+5]);l=q.length;h.bezierCurveTo(q[l-4],q[l-3],q[l-2],q[l-1],q[0],q[1])}h.closePath();h.fill();h.scale(1/n,1/n);h.translate(-j,-m)}}h.translate(-(g[0]*f/1440),-(g[1]*f/1440));if(b.parentNode.tagName==="A")h.strokeStyle=d(b),h.lineWidth=s.lineWidth,h.beginPath(),h.moveTo(0,b.height-1),h.lineTo(b.width,b.height-1),h.stroke(),h.closePath()}}function d(a){a=a.parentNode;return a.tagName==="A"?s.linkColor:
(a=a.getAttribute("class"))&&a.indexOf("fixedOverlap")>=0?h:s.textColor}function c(a){for(var a=a.getElementsByTagName("CANVAS"),b={},c=0;c<a.length;c+=1)b[a[c].id]=a[c];return b}function b(a,b,c,f,g,d){for(var h={},e=0;e<a.length;e+=1){var j=b[a[e].id];if(j)for(var l=0;l<j.length;l++){var m=g[j[l].id];if(m){var n=f,o=m.parentNode.getAttribute("class");if(o&&o.indexOf("fixed")>=0){var n=c,o=m,k=d;if(k[o.id])n=k[o.id];else{var p=$(o).attr("height"),r=$(o).attr("width"),q=0,t=0,s=1;if(p&&!(p<=0||!r||
r<=0))p>n.height&&(q=n.height/p),r>n.width&&(t=n.width/r),q>0&&t>0?s=q<t?q:t:q>0?s=q:t>0&&(s=t),k[o.id]=s;n=s}}if(n!==1&&!h[m.id])h[m.id]=1,m.width=Math.round(n*m.width),m.height=Math.round(n*m.height)}}}}function l(a,b,c,f,d,h,j,m,n,o,k){function p(){a===g?l(a,b,c+1,f,d,h,j,m,n,o,k):setTimeout(k,10)}for(var r=f.length;b<r;){var t=d[f[b].id];if(t)for(var s=t.length;c<s;){var K=t[c];if(K.imgSrc!==void 0){var y=m[K.id];if(y){r=n[y.id];r=r!==void 0?r:h;e(a,j,y,K,r*q,r,o,p);return}}c+=1}b+=1;c=0}setTimeout(k,
10)}function j(a,b,c,f,g,d,h,e,j){l(a,0,0,b,c,f,g,d,h,e,j)}function o(a,b,c,f,d,h,e,j,l,m,n){function p(){a===g?o(a,b,c+1,f,d,h,e,j,l,m,n):setTimeout(n,m.time)}for(var r=0,t=f.length;b<t;){var s=d[f[b].id];if(s)for(var K=s.length;c<K;){var y=s[c];if(y.l!==void 0&&y.l.length>0){var R=j[y.id];if(R){var W=l[R.id];k(e,R,y,(W!==void 0?W:h)*q);r+=1;if(r>m.frequency){setTimeout(p,m.time);return}}}c+=1}b+=1;c=0}setTimeout(n,m.time)}function f(a,b,c,f,g,d,h,e,j){o(a,0,0,b,c,f,g,d,h,e,j)}function a(a,d,h,e,
l,m){var n={height:$(a).parent().height()*0.85,width:$(a).parent().width()*0.85},o=c(a.contentDocument),k=[],p=a.contentDocument.getElementsByTagName("html")[0],r=a.contentDocument.getElementsByTagName("body")[0],r=p.removeChild(r),q=$(r).find("p"),I={},u=l.createSubTimer("resizing-canvases");b(q,h.paraData,n,s.glyphScale,o,I);u.endTimer();u=l.createSubTimer("rendering-all-images");j(d.requestId,q,h.paraData,s.glyphScale,h.imageData,o,I,k,function(){u.endTimer();if(!(g!==d.requestId||a.processingRequestId!==
d.requestId)){u=l.createSubTimer("rendering-all-glyphs");var b={frequency:KindleRendererDeviceSpecific.drawYieldGlyphRendereringFrequency(),time:KindleRendererDeviceSpecific.drawYieldUpdateTime()};f(d.requestId,q,h.paraData,s.glyphScale,e,o,I,b,function(){u.endTimer();g!==d.requestId||a.processingRequestId!==d.requestId||(p.appendChild(r),t[a.id]=k,o=I=null,setTimeout(m,b.time))})}})}function n(b,c,f,d){if(!(g!==null&&c.requestId<g)){p=c.type;g=c.requestId;var h=c.metrics.createSubTimer("glyph-rendering");
a(b,c,f,d,h,function(){g!==c.requestId||b.processingRequestId!==c.requestId||(g=p=null,h.endTimer(),r(b,c))})}}function m(a){var b={r:parseInt(s.textColor.substring(1,3),16),g:parseInt(s.textColor.substring(3,5),16),b:parseInt(s.textColor.substring(5,7),16)},c=t[a.id];$(a.contentDocument).find("canvas").each(function(){var a=this.parentNode;if(a.tagName!=="A"&&(a=a.getAttribute("class"),!a||a.indexOf("fixedOverlap")<0)){a=this.getContext("2d");try{var f=a.getImageData(0,0,this.width,this.height),
g=this.width*this.height*4,d=c[this.id];if(d){for(var h=this.width,e=0,j=d.length,l=[];e<j;e+=1)for(var m=Math.floor(d[e].x),n=Math.floor(d[e].y),o=Math.ceil(d[e].w),k=Math.ceil(d[e].h),p=0;p<k;p+=1)for(var r=(h*(n+p)+m)*4,q=r+o*4;r<=q;r+=4)l[r]=1;for(var t=f.data,s=b.r,v=b.g,ca=b.b,d=0;d<g;d+=4)t[d+3]>0&&!l[d]&&(t[d]=s,t[d+1]=v,t[d+2]=ca)}else{l=f.data;e=b.r;p=b.g;r=b.b;for(t=0;t<g;t+=4)l[t+3]>0&&(l[t]=e,l[t+1]=p,l[t+2]=r)}a.putImageData(f,0,0)}catch(D){}}})}var h="#000000",p,g,r,q=100,t=[],s={glyphScale:1,
textColor:h,linkColor:"#0000ff",lineWidth:1};return{initialize:function(a){r=a},renderAllContent:function(a,b,c,f){n(a,b,c,f)},getCurrentlyRenderingType:function(){return p},updateTextColor:function(a){m(a)},updateSettings:function(a){s.glyphScale=a.glyphScale;if(s.glyphScale<0.75||s.glyphScale>3)s.glyphScale=Math.max(0.75,Math.min(3,s.glyphScale));s.textColor=a.fontColor},clearIframeData:function(a){t[a.id]=void 0},cleanup:function(){t=null}}}(),KindlePaginator=function(){function e(d,c){if(c!==
null)d.currentTopOfScreen=c.topOfScreen,d.currentBottomOfScreen=c.bottomOfScreen,k(d)}function k(d){var c=KindleHostDeviceDetector.isiOS_5x();c&&($(d).removeClass("pageTurnEnd"),$(d).addClass("pageTurnStart"));d.height=d.currentBottomOfScreen-d.currentTopOfScreen;$(d.contentWindow).scrollTop(d.currentTopOfScreen);c&&($(d).removeClass("pageTurnStart"),$(d).addClass("pageTurnEnd"))}return{initialize:function(){},scrollToPosition:function(d,c){var b=d.screenManager.getTopOfNodeAtPosition(d.contentDocument,
c),b=d.screenManager.getFirstEmptySpaceBeforeHeight(b),b=d.screenManager.findNextScreen(b);e(d,b)},getPositionOffsetFromTop:function(d,c){return getPositionOffsetFromTop(d,c)},matchFrames:function(d,c){var b=d.screenManager.getFirstPositionAtHeight(d.currentTopOfScreen),e=d.screenManager.getTopOfNodeAtPosition(d.contentDocument,b)-d.currentTopOfScreen,j=d.currentBottomOfScreen-d.currentTopOfScreen,b=c.screenManager.getTopOfNodeAtPosition(c.contentDocument,b);c.currentTopOfScreen=b-e;c.currentBottomOfScreen=
c.currentTopOfScreen+j;k(c)},getApproximateNumPreviousScreens:function(d){var c=$(d).parent().height();return(d.currentTopOfScreen-d.screenManager.minDocTop)/c},getApproximateNumNextScreens:function(d){var c=$(d).parent().height();return(d.screenManager.maxDocTop-d.currentBottomOfScreen)/c},getContentCoordinates:function(d,c,b){return{x:c,y:b+d.currentTopOfScreen}},getNodeIdAtPosition:function(d,c){return d.screenManager.getNodeIdAtPosition(d.contentDocument,c)},getCurrentPagePositionRange:function(d){var c=
d.screenManager.getFirstPositionAtHeight(d.currentTopOfScreen),d=d.screenManager.getFirstPositionAtHeight(d.currentBottomOfScreen)-1;return{currentTopOfPage:c,currentBottomOfPage:d}},hasPreviousScreen:function(d){return d.screenManager.hasPreviousScreen(d.currentTopOfScreen)},hasNextScreen:function(d){return d.screenManager.hasNextScreen(d.currentBottomOfScreen)},isPreviousFullScreen:function(d){var c=d.screenManager.findPreviousScreen(d.currentTopOfScreen,d.currentBottomOfScreen);return c!==null?
d.screenManager.hasPreviousScreen(c.topOfScreen):!1},isNextFullScreen:function(d){var c=d.screenManager.findNextScreen(d.currentBottomOfScreen);return c!==null?d.screenManager.hasNextScreen(c.bottomOfScreen):!1},nextScreen:function(d,c){var b=d.screenManager.findNextScreen(d.currentBottomOfScreen);return b!==null&&(!c||d.screenManager.hasNextScreen(b.bottomOfScreen))?(e(d,b),!0):!1},previousScreen:function(d,c){var b=d.screenManager.findPreviousScreen(d.currentTopOfScreen,d.currentBottomOfScreen);
if(b!==null&&(!c||d.screenManager.hasPreviousScreen(b.topOfScreen))){if(b!==null)d.currentTopOfScreen=b.topOfScreen,d.currentBottomOfScreen=b.bottomOfScreen,k(d);return!0}return!1},getWordMap:function(d){return d.screenManager.wordMap},getSelectableItemBoundariesForCurrentPage:function(d){for(var c=KindlePaginator.getCurrentPagePositionRange(d),b=d.screenManager.wordMap,e=c.currentBottomOfPage,d=d.currentTopOfScreen,j={},c=c.currentTopOfPage;c<=e;++c){var o=b[c];if(o){for(var f=[],a=0;a<o.length;a++){var n=
o[a];f.push({left:n.left-0,top:n.top-d,right:n.right-0,bottom:n.bottom-d})}j[c]=f}}return j},sanityCheckPass:function(d){var c;if(d.screenManager===void 0)c=!0;else{var b=d.screenManager.getFirstPositionAtHeight(d.currentTopOfScreen);c=d.screenManager.getTopOfNodeAtPosition(d.contentDocument,b);d=d.contentDocument.getElementById(b);d=Math.floor($(d).offset().top);c=c===d}return c}}}(),KindlePaginatorContentFragmentation=function(){function e(a){for(var c=Math.max(b[0].cPos,a.start),a=Math.min(b[b.length-
1].ePos,a.end),f=[],d=-1,e=-1,g=!1,j=0;j<b.length;j+=1){var l=b[j].cPos,o=j+1===b.length?b[j].ePos:b[j+1].cPos-1;if(c>=l&&a<=o){f.push(j);d=l;e=o;break}if(c>=l&&c<=o)f.push(j),d=l,g=!0;else{if(a>=l&&a<=o){f.push(j);e=o;break}g&&f.push(j)}}return{fragmentList:f,startPosition:d,endPosition:e}}function k(a){function b(c){var f=a;f===null||f.glyphData===null?(c.glyphData=null,c.glyphFragmentMetadata=null):(f.glyphChunkLoadCnt+=1,f.glyphData.push(c),f.glyphChunkLoadCnt<f.glyphChunksToDownload.length||
(f.glyphLoadMetrics.addCount("Success",1),f.glyphLoadMetrics.endTimer(),d(f)))}function e(){var b=a;if(b!==null&&b.glyphData!==null){var c=b.requestData;b.glyphLoadMetrics.addCount("Failure",1);b.glyphLoadMetrics.endTimer();b.glyphData=null;o("Error trying to download glyph chunks.",c)}}if(a!==null){for(var h,j=[],g=[],k=0;k<a.fragmentsNeeded.length;k+=1)if(h=c(a.fragmentsNeeded[k]),h.gCks)for(var q=0;q<h.gCks.length;q+=1)$.inArray(h.gCks[q],g)===-1&&g.push(h.gCks[q]);h=[];for(k=0;k<g.length;k+=1)q=
g[k],f[q]===void 0?h.push(q):j.push(f[q]);a.glyphData=j;h.length>0?(j=a.overallLoadMetrics.createSubTimer("glyph-loading"),j.addCount("NumGlyphCunks",h.length),a.glyphChunkLoadCnt=0,a.glyphChunksToDownload=h,a.glyphLoadMetrics=j,l.getGlyphFragments(b,e,h,a)):d(a)}}function d(a){if(!(a===null||a.loadedFragments===null)){for(var b,f=0;f<a.fragmentsNeeded.length;f+=1)b=c(a.fragmentsNeeded[f]),a.loadedFragments[a.fragmentsNeeded[f]].linkId=b.lId,a.loadedFragments[a.fragmentsNeeded[f]].linkType=b.lt,a.loadedFragments[a.fragmentsNeeded[f]].linkOffset=
b.off;b=null;var d=a.requestData,e={};e.glyphData=a.glyphData;e.contentRange={startPosition:a.fragmentsStartPosition,endPosition:a.fragmentsEndPosition};e.fragmentIndecies=a.fragmentsNeeded;e.fragmentData=a.loadedFragments;a.overallLoadMetrics.endTimer();a.glyphData=null;var a=a.loadedFragments=null,g=d.metrics.createSubTimer("waiting-to-callback");setTimeout(function(){g.endTimer();j(d,e);e=d=null},KindleRendererDeviceSpecific.drawYieldUpdateTime())}}function c(a){for(var c=0;c<b.length;c++)if(b[c].fId===
a)return b[c];return null}var b=null,l=null,j=null,o=null,f=[];return{initialize:function(a,c,f,d,e){l=a;j=c;o=f;l.getFragmentMap(function(a){b=a.fragmentArray;d(a)},e)},loadNextFragmentGroup:function(a,b){function c(a){var b=s;b===null||b.loadedFragments===null?(a.fragmentData=null,a.fragmentMetadata=null,a.paraData=null):(b.numFragmentsLoaded+=1,b.loadedFragments[a.fragmentMetadata.id]=a,b.numFragmentsLoaded<b.fragmentsToLoad.length||(b.fragmentLoadMetrics.addCount("Success",1),b.fragmentLoadMetrics.endTimer(),
k(b)))}function f(){var a=s;if(a!==null&&a.loadedFragments!==null){var b=a.requestData;a.fragmentLoadMetrics.addCount("Failure",1);a.fragmentLoadMetrics.endTimer();a.loadedFragments=null;a.glyphData=null;o("Error trying to download file fragments.",b)}}function d(){v.endTimer();l.getBookFragments(c,f,t)}if(isNaN(a.start)||isNaN(a.end))a.start=0,a.end=1E4;var g=b.metrics.createSubTimer("fragment-glyph-loading"),j=g.createSubTimer("fragment-loading"),q=e(a),t=q.fragmentList.slice();j.addCount("NumFragments",
q.fragmentList.length);var s={fragmentsNeeded:q.fragmentList,fragmentsStartPosition:q.startPosition,fragmentsEndPosition:q.endPosition,overallLoadMetrics:g,fragmentLoadMetrics:j,loadedFragments:[],fragmentsToLoad:t,numFragmentsLoaded:0,requestData:b},v=j.createSubTimer("waiting-to-begin");t.length===0?k(s):setTimeout(d,KindleRendererDeviceSpecific.drawYieldUpdateTime())}}}(),KindlePaginatorDefaultParser=function(){function e(b,c,d,f){if(b.minDocTop===void 0||c<b.minDocTop)b.minDocTop=c;if(b.maxDocTop===
void 0||c>b.maxDocTop)b.maxDocTop=c;b.screenNodeArray[f]=c;var a=parseInt(f,10);if(a>b.maxPosition)b.maxPosition=a;a=c+1;c=Math.floor(c+d);if(b.nodeHeightRanges[a]===void 0||b.nodeHeightRanges[a]!==b.nodeHeightRanges[c-1])for(d=a;d<c;d+=1)b.nodeHeightRanges[d]===void 0&&(b.nodeHeightRanges[d]=f)}function k(b,c,d,f,a,n){function m(){h!==null&&h.endTimer();k(b,c+1,d,f,a,n)}for(var h=null,p=0;c<b.length;){var g=b[c],r=g.getBoundingClientRect();(r.top>0||r.bottom>0)&&e(a,Math.floor(r.top),r.bottom-r.top+
f,g.id);p+=1;if(p>d.interval){h=a.creationTimer.createSubTimer("wait-timer");setTimeout(m,d.time);return}c+=1}setTimeout(n,d.time)}function d(b,c,d,f){var a={interval:KindleRendererDeviceSpecific.drawYieldScreenManagerFrequency(),time:KindleRendererDeviceSpecific.drawYieldUpdateTime()};k(b,0,a,c,d,f)}function c(b,c,d){for(var f in b)for(var a=b[f],n=0;n<a.length;n++){var m=a[n];(m.top>0||m.bottom>0)&&e(c,Math.floor(m.top),m.bottom-m.top,f)}setTimeout(d,10)}function b(b,e,o,f,a){var n=null,m=function(){n=
null;var c=b.getElementsByTagName("CANVAS");d(c,0,e,function(){c=null;var m=b.getElementsByTagName("IMG");d(m,0,e,function(){m=null;for(var c=b.getElementsByClassName("page-break"),d=0;d<c.length;d+=1){var e=c[d].getBoundingClientRect();f.push(Math.floor(e.top))}a()})})};o?c(o,e,m):(n=b.getElementsByClassName("k4w"),d(n,1,e,m))}return{createHeightMap:function(c,d,e){var f={nodeHeightRanges:[],screenNodeArray:{},maxPosition:0};f.creationTimer=KindleMetricsProfiler("creation-timer");f.wordMap=d;var a=
[];b(c,f,f.wordMap,a,function(){for(var b=a,c=0;c<b.length;c++){var d=b[c],j=d;if(f.nodeHeightRanges[d]!==void 0){if(f.nodeHeightRanges[d]===-162)continue;for(var g=0;g<d;g+=1)if(f.nodeHeightRanges[d-g]===void 0){j=d-g;break}}f.nodeHeightRanges[j]=-162}a=null;f.creationTimer.endTimer();f.creationTimer.log();e(f)})}}}(),KindlePaginatorScreenFragmentation=function(e,k,d,c){function b(b){b.hasNextScreen=function(b){return this.maxDocTop>=b};b.hasPreviousScreen=function(b){return b>this.minDocTop};b.getFirstPositionAtHeight=
function(b){for(var c=b;c<this.nodeHeightRanges.length;c+=1)if(b=this.nodeHeightRanges[c],b!==void 0&&b!==l)return parseInt(b,10);return this.maxPosition};b.getFirstEmptySpaceBeforeHeight=function(b){for(var c,a=b;a>=0;a-=1)if(c=this.nodeHeightRanges[a],c===void 0||c===l)return a;return b};b.getTopOfNodeAtPosition=function(b,c){for(;c<=this.maxPosition;){if(this.screenNodeArray[c]!==void 0)return this.screenNodeArray[c];c+=1}return 0};b.findNextScreen=function(b){if(!this.hasNextScreen(b))return null;
for(var c=0,a=0,e=0,j=this.nodeHeightRanges.length,h,e=b;e<=j;e+=1)if(a+=1,h=this.nodeHeightRanges[e],h===void 0&&(c=e),h===l&&e>b){a=e-b;break}else if(a>=d){a=c-b;a<=0&&(a=d-1);break}c={topOfScreen:b,bottomOfScreen:0};c.bottomOfScreen=e<j?b+a:e;return c};b.findPreviousScreen=function(b){if(!this.hasPreviousScreen(b))return null;for(var c=0,a=0,e=0,j,e=b;e>=0;e-=1)if(a+=1,j=this.nodeHeightRanges[e],j===void 0&&(c=e),j===l&&e<b)return this.findNextScreen(e);else if(a>=d){a=b-c;a===0&&(a=d-1,c=b-a);
break}e<0&&(c=0,a-=1);return{topOfScreen:c,bottomOfScreen:c+a}}}var l=-162;KindlePaginatorDefaultParser.createHeightMap(e,k,function(d){b(d);c(d)})},KindleRenderer=function(){function e(){Sa+=1;return Sa}function k(a,b,c){a={status:a};if(b!==void 0)a.errorCode=b;if(c!==void 0)a.errorMsg=c;Ka!==void 0&&Ka(a)}function d(a,b){k(la,a,b?b:"no msg")}function c(){wa||(wa=!0,k(qa))}function b(a,b){fa?wa&&(d(a,b),wa=!1):d(V,"Unable to get book content")}function l(a,b){var c=a.metrics.createSubTimer("fragment-post-load"),
d=w[N],f=d.contentDocument;d.screenManager=null;C(f);KindleGlyphRenderer.clearIframeData(d);d.setAttribute("width",$(d).parent().width()+"px");f.open();f.write(Aa);f.close();f=f.getElementsByTagName("head")[0];KindleRendererDefaults.addCSSRules(f,ia);KindleRendererContentScripts.addInterfaceScripts(f);x(d);d=w[N];d.processingRequestId=a.requestId;f=c.createSubTimer("settings-insertion");KindleRendererSettings.addCSSRules(d.contentDocument.getElementsByTagName("head")[0],aa);f.endTimer();for(var f=
c.createSubTimer("fragment-insertion"),g=[],e,h={},j=!1,l={},m={},n=!1,k=null,p=null,r=null,q=null,t=null,s=0;s<b.fragmentIndecies.length;s+=1){e=b.fragmentData[b.fragmentIndecies[s]];k=g;p=e.linkId;r=e.linkType;q=void 0;t=d.contentDocument.getElementById(p);q=k[p];if(q===void 0||q.typeArray[r]===void 0)q===void 0&&(q={typeArray:[]},k[p]=q),q.linkNode=t,r===0?q.typeArray[0]=t.firstChild:q.typeArray[1]=t.nextSibling;p=q;e.linkType===0?(r=p.linkNode.parentNode,q=p.linkNode):(r=p.linkNode.parentNode.parentNode,
q=p.linkNode.parentNode);t=q.nextSibling;q=r.removeChild(q);k=d.contentDocument.createElement(q.tagName);k.innerHTML=e.fragmentData;var v=e.imageData;if(v!==void 0&&v!==null)for(var y=$(k).find("img"),W=0;W<y.length;W+=1){var u=y[W].getAttribute("dataUrl");if(u===void 0||u===null)u=y[W].getAttribute("src");if(v[u])y[W].src=v[u]}for(v=e.linkOffset;k.hasChildNodes();){y=k.removeChild(k.firstChild);if(y.nodeType===Node.TEXT_NODE)y.ownChildIndex=v;q.insertBefore(y,p.typeArray[e.linkType]);v+=1}r.insertBefore(q,
t);if(e.posMap!==void 0){var j=!0,z;for(z in e.posMap)h[z]=e.posMap[z]}if(e.paraIds!==void 0&&e.paraIds!==null){n=!0;for(k=0;k<e.paraIds.length;k+=1)l[e.paraIds[k]]=e.paraData[k];for(var O in e.imageData)m[O]=e.imageData[O]}e.fragmentData=null;e.imageData=null;e.paraData=null}z={};if(j)z.positionData=h;if(n)z.glyphData={paraData:l,imageData:m};f.endTimer();ia==="topaz"&&(O=c.createSubTimer("canvas-insertion"),KindleRendererCanvasInsertion.changeSpanToCanvas(d.id,d.contentDocument,b.contentRange,a.type===
Y),O.endTimer());c.endTimer();b.fragmentData=null;a.positionData=z.positionData;d.contentRange=b.contentRange;d.hasGlyphs=z.glyphData!==void 0&&b.glyphData!==void 0;d.hasGlyphs?KindleGlyphRenderer.renderAllContent(d,a,z.glyphData,b.glyphData):(z.glyphData=null,o(d,a))}function j(a,c){c.metrics.addCount("Failure",1);c.metrics.endTimer();b(ta,a)}function o(a,b){KindleRendererContentReflow.reflow(a,b)}function f(a){a.metrics.addCount("Failure",1);a.metrics.endTimer();t();b(ga,"glyph rendering took too long")}
function a(a,b){if(a.processingRequestId===a.requestId)a.processingRequestId=null;a.loadedType=b.type;sa(a);ja(a);if(b.initialPosition!==void 0){KindlePaginator.scrollToPosition(a,b.initialPosition);if(!KindlePaginator.hasNextScreen(a)&&a.contentRange.endPosition!==KindleRendererFragmentLoader.getMaximumPosition()){var c=KindlePaginator.getCurrentPagePositionRange(a);xa=Math.max(xa,c.currentBottomOfPage-c.currentTopOfPage);setTimeout(function(){var a=b.initialPosition,c=b.metrics,d=T(a),a={type:ea,
requestId:e(),metrics:c,initialPosition:a};q();KindleRendererFragmentLoader.loadFragments(d,a)},0);return}a===w[N]&&(z(),u())}b.metrics.addCount("Success",1);b.metrics.endTimer();ha!==null&&(ha.endTimer(),ha=null);fa=!0;t();wa&&(wa=!1,k(S))}function n(a){a.metrics.addCount("Failure",1);a.metrics.endTimer();t();b(ga,"reflow took too long")}function m(b,c,e){ha===null&&(ha=KindleMetricsProfiler("Renderer-Load"));aa=c;Ka=e.statusCallback;La=e.annotationEventCallback;if(b)if(b.bookInfo&&b.containerId)if(c=
$("#"+b.containerId),c.length===0)d(U,"Container not found");else{Qa=c.get(0);xa=0;Ja=b.startingPositionDfd;Ia=b;KindleRendererDeviceSpecific.initialize();KindleGlyphRenderer.initialize(o,f);KindleRendererContentReflow.initialize(a,n);KindleGlyphRenderer.updateSettings(aa);var h=ha.createSubTimer("fragment-map-loading");KindleRendererFragmentLoader.initialize(b.bookInfo,l,j,function(a){h.endTimer();ia=a.fragmentMetadata.bookType;a=Qa;fa=!1;k(ka);for(var b=0;b<2;b+=1){w[b]!==null&&w[b]!==void 0&&a.removeChild(w[b]);
var c=w,d=b,f=$(a).width(),e=b,j=document.createElement("iframe");j.setAttribute("height","100%");j.setAttribute("width",f+"px");j.setAttribute("frameBorder","0");j.setAttribute("id","bookIFRAME_id_"+e);j.setAttribute("name","bookIFRAME");j.setAttribute("scrolling","no");$(j).css("position","absolute");$(j).css("top","0px");$(j).css("left","0px");$(j).css("visibility","hidden");j.loadedType=ma;c[d]=j;a.appendChild(w[b])}$(w[E]).css("visibility","visible");Ra=ha.createSubTimer("load-skeleton");Ia.bookInfo.getBookSkeleton(p,
g);KindlePaginator.initialize()},function(a){d(V,"Load Failure: "+a)})}else throw{name:"initializationError",message:"required parameters not present"};}function h(){if(!fa)throw{name:"initializationError",message:"Please call KindleRenderer.initialize function first"};}function p(a){Ra.endTimer();Aa=a.skeletonData;if(Aa.search("html.*/html")>0){var a=w[N].contentDocument,b=a.getElementsByTagName("html")[0];b!==void 0&&a.removeChild(b);a.write(Aa);a.close();a=a.getElementsByTagName("head")[0];KindleRendererDefaults.addCSSRules(a,
ia);KindleRendererContentScripts.addInterfaceScripts(a);Ja.done(function(a){a=Math.min(Math.max(a,0),KindleRendererFragmentLoader.getMaximumPosition());x(w[N],a)})}else d(V,"Load Failure")}function g(){d(V,"Load Failure")}function r(){window.focus()}function q(){KindleLocalStorage.localStorageObject!==void 0&&KindleLocalStorage.localStorageObject.setItem(Ha,"true")}function t(){KindleLocalStorage.localStorageObject!==void 0&&KindleLocalStorage.localStorageObject.removeItem(Ha)}function s(a){switch(a.which){case 219:case 221:a.shiftKey||
a.preventDefault();break;case 37:case 38:case 33:case 39:case 40:case 34:case 32:case 8:a.preventDefault()}}function v(a,b){var c=window.document.createEvent("KeyboardEvent");c.initKeyEvent(a,b.bubbles,b.cancelable,window,b.ctrlKey,b.altKey,b.shiftKey,b.metaKey,b.keyCode,b.charCode);window.document.dispatchEvent(c)}function x(a,b){try{document.onmousewheel=function(){return!1};var f=a.contentDocument.getElementsByTagName("body")[0];f.oncontextmenu=function(){return!1};f.onselectstart=function(){return!1};
a.contentWindow.onkeydown=function(a){s(a);v("keydown",a)};a.contentWindow.onkeyup=function(a){s(a);v("keyup",a)};a.contentWindow.onkeypress=function(a){s(a);v("keypress",a)};a.contentWindow.onfocus=r;a.contentWindow.onclick=r;if(b!==void 0){c();var g=T(b),h={type:ea,requestId:e(),metrics:ha.createSubTimer("renderer-iframe-load"),initialPosition:b};q();KindleRendererFragmentLoader.loadFragments(g,h)}}catch(j){d(ya,j.message)}}function O(a){if(La!==void 0){var b=a.currentTarget.parentNode,a=b.getAttribute("annotationType"),
b=b.getAttribute("annotationStart");La(a,b)}}function z(){w[E].loadedType=w[N].loadedType===J?Y:w[N].loadedType===Y?J:ma;w[N].loadedType=ma;var a=E;E=N;N=a;$(w[E]).css("visibility","visible");$(w[N]).css("visibility","hidden");H()}function C(a){if(a=a.getElementsByTagName("body")[0])for(;a.hasChildNodes();)a.removeChild(a.lastChild)}function G(){var a=w[E],b=$(a).parent().height(),a=$(a).parent().width();if(ia==="topaz")a/=25*aa.glyphScale,b/=25*aa.glyphScale;else{var c=aa.fontSizes[Ba];a/=c*0.4;
b/=c*aa.lineHeight}return Math.max(Math.round(a*b),xa)}function X(a){var b=H(),c=KindleRendererDeviceSpecific.fragmentBufferCapacityForPageFlip(ia==="topaz");c*=G();var d=Math.max(c,b.currentBottomOfPage-b.currentTopOfPage),c=Math.ceil(d*0.25),d=Math.ceil(d*0.75),c=Math.min(Math.max(KindleRendererFragmentLoader.getMinimumPosition(),a-c),b.currentTopOfPage),a=Math.max(Math.min(KindleRendererFragmentLoader.getMaximumPosition(),a+d),b.currentBottomOfPage+1);return{start:c,end:a}}function T(a){var b=
G()*KindleRendererDeviceSpecific.fragmentBufferCapacityForGoTo(),c=Math.ceil(b*0.1),b=Math.ceil(b),c=Math.max(KindleRendererFragmentLoader.getMinimumPosition(),a-c),a=Math.min(KindleRendererFragmentLoader.getMaximumPosition(),a+b);return{start:c,end:a}}function P(a){va=null;c();var b={type:ea,requestId:e(),metrics:KindleMetricsProfiler("renderer-iframe-load"),initialPosition:a};W(w[E]);q();a=T(a);KindleRendererFragmentLoader.loadFragments(a,b)}function B(a,b){var c=a.contentDocument.getElementsByTagName("html")[0];
KindleRendererSettings.addCSSRules(c,b)}function H(){var a=KindlePaginator.getCurrentPagePositionRange(w[E]);xa=Math.max(xa,a.currentBottomOfPage-a.currentTopOfPage);return a}function F(){var a=KindleRendererFragmentLoader.getCurrentlyLoadingType(),b=KindleGlyphRenderer.getCurrentlyRenderingType(),c=KindleRendererContentReflow.getCurrentlyReflowingType();if(w[N].loadedType!==J&&a!==J&&b!==J&&c!==J)a={type:J,requestId:e(),metrics:KindleMetricsProfiler("renderer-iframe-load")},b=w[E].contentRange,q(),
b=X(b.endPosition),KindleRendererFragmentLoader.loadFragments(b,a)}function I(){var a=KindleRendererFragmentLoader.getCurrentlyLoadingType(),b=KindleGlyphRenderer.getCurrentlyRenderingType(),c=KindleRendererContentReflow.getCurrentlyReflowingType();if(w[N].loadedType!==Y&&a!==Y&&b!==Y&&c!==Y)a={type:Y,requestId:e(),metrics:KindleMetricsProfiler("renderer-iframe-load")},b=w[E].contentRange,q(),b=X(b.startPosition),KindleRendererFragmentLoader.loadFragments(b,a)}function u(){var a=KindlePaginator.getApproximateNumNextScreens(w[E]),
b=KindlePaginator.getApproximateNumPreviousScreens(w[E]);a<3&&K()?F():b<2&&y()&&I()}function A(){if(w[N].loadedType!==ma){var a=H(),b=w[N].contentRange;if(a.currentTopOfPage>=b.startPosition&&a.currentBottomOfPage<b.endPosition)if(KindlePaginator.matchFrames(w[E],w[N]),b=KindlePaginator.getCurrentPagePositionRange(w[N]),b.currentTopOfPage===a.currentTopOfPage&&b.currentBottomOfPage===a.currentBottomOfPage)return z(),!0;else if(!KindlePaginator.isNextFullScreen(w[E])&&K()||!KindlePaginator.isPreviousFullScreen(w[E])&&
y())KindleModuleManager.getModuleSync(KindleModuleManager.METRICS_MANAGER).addEvent("Renderer::PageFailureReload"),P(H().currentTopOfPage)}return!1}function K(){return w[E].contentRange.endPosition!==KindleRendererFragmentLoader.getMaximumPosition()}function y(){return w[E].contentRange.startPosition!==KindleRendererFragmentLoader.getMinimumPosition()}function R(){var a=w[E].contentDocument.getElementsByTagName("html")[0],b=w[E].contentDocument.getElementsByTagName("body")[0];a.removeChild(b);a.appendChild(b)}
function W(a){a=a.contentDocument.getElementById(Pa);a!==null&&a.parentNode.removeChild(a)}function ja(a){W(a);var b=KindleReaderAnnotationManager.getAnnotationsInRange(a.contentRange.startPosition,a.contentRange.endPosition);if(b!==null&&b.length>0){var c=a.contentDocument.getElementsByTagName("body")[0];if(c!==null){var d=KindlePaginator.getWordMap(a),f=a.contentDocument.createDocumentFragment();KindleRendererAnnotationRenderer.createAnnotationElements(a.contentDocument,d,b,f);a=a.contentDocument.createElement("DIV");
a.id=Pa;a.appendChild(f);c.appendChild(a);c=$(a).find("."+KindleRendererAnnotationRenderer.NOTE_CLASS);$(c).click(O)}}}function sa(a){a=a.contentDocument.getElementById(Ga);a!==null&&a.parentNode.removeChild(a)}function ca(a,b){function c(a){for(;a.firstChild;)a=a.firstChild;return a}var d=w[E].contentDocument.getElementById(a);if(!d)return null;for(var f="",d=c(d);d;d=d.nextSibling?c(d.nextSibling):d.parentNode)if(d.nodeType===Node.TEXT_NODE)f+=d.data;else if(d.nodeType===Node.ELEMENT_NODE&&Number(d.id)>=
b)break;return f}var D=0,la=D++,ka=D++,qa=D++,S=D++,V=D++,U=D++,ta=D++,ga=D++,ya=D++,ma=D++,ea=D++,J=D++,Y=D++,Ba=2,Pa="annotation-section",Ga="selection-section",Ha="PageLoadIncomplete",Qa=null,Ta=/^-?\d+(?:\.\d*)?(?:e[+\-]?\d+)?/i,fa=!1,Ka=void 0,La=void 0,Ia,Ja,Aa,aa={},Sa=0,ha=null,Ra=null,ia,xa,wa=!1,va=null,w=[],E=1,N=0;return{STATUS_ERROR:la,STATUS_LOADING:ka,STATUS_PAGINATING:qa,STATUS_DONE:S,ERROR_LOAD_FAILURE:V,ERROR_CONTAINER_NOT_FOUND:U,ERROR_UNABLE_TO_GET_BOOK_CONTENT:ta,ERROR_TIMEOUT_WHILE_LOADING_BOOK_CONTENT:ga,
ERROR_UNKNOWN:ya,PAGE_LOAD_INCOMPLETE_FLAG_NAME:Ha,initialize:function(a,b,c){m(a,b,c)},shutdown:function(){fa=!1;C(w[E].contentDocument);C(w[N].contentDocument);KindleGlyphRenderer.cleanup();KindleRendererCanvasInsertion.cleanup()},updateSettings:function(a){h();var b=a.fontSizes!==void 0||a.fontSizeUnits!==void 0||a.fontFamily!==void 0||a.lineHeight!==void 0||a.margin!==void 0,c;for(c in a)aa[c]=a[c];KindleGlyphRenderer.updateSettings(aa);B(w[E],aa);B(w[N],aa);b?P(H().currentTopOfPage):a.fontColor!==
void 0&&(w[E].hasGlyphs&&KindleGlyphRenderer.updateTextColor(w[E]),w[N].loadedType!==ma&&w[N].hasGlyphs&&KindleGlyphRenderer.updateTextColor(w[N]))},nextScreen:function(){h();try{var a;va=null;w[N].loadedType===J&&A();var b=K(),d=KindlePaginator.nextScreen(w[E],b);!d&&b?(F(),c(),a=!1):(u(),KindleRendererDeviceSpecific.needsReflowOnPageFlip()&&setTimeout(R,KindleRendererDeviceSpecific.drawYieldUpdateTime()),a=d);return a}catch(f){return!1}},previousScreen:function(){h();try{var a;va=null;w[N].loadedType===
Y&&A();var b=y(),d=KindlePaginator.previousScreen(w[E],b);!d&&b?(I(),c(),a=!1):(u(),KindleRendererDeviceSpecific.needsReflowOnPageFlip()&&setTimeout(R,KindleRendererDeviceSpecific.drawYieldUpdateTime()),a=d);return a}catch(f){return!1}},hasNextScreen:function(){h();try{return KindlePaginator.hasNextScreen(w[E])||K()}catch(a){return!1}},hasPreviousScreen:function(){h();try{return KindlePaginator.hasPreviousScreen(w[E])||y()}catch(a){return!1}},getMinimumPosition:function(){h();return KindleRendererFragmentLoader.getMinimumPosition()},
getMaximumPosition:function(){h();return KindleRendererFragmentLoader.getMaximumPosition()},gotoPosition:function(a){h();try{if(a===null)a=0;else{var b=Ta.exec(a);if(b===null)a=0;else var c=parseFloat(b),a=isNaN(c)?0:c}a=Math.min(Math.max(a,0),KindleRendererFragmentLoader.getMaximumPosition());P(a)}catch(d){}},getPagePositionRange:function(){h();try{return H()}catch(a){return{start:0,end:0}}},setSelection:function(a){h();try{var b=w[E],c=b.contentDocument.getElementsByTagName("body")[0];if(c!==null){var d=
KindlePaginator.getWordMap(b),f=b.contentDocument.createDocumentFragment();KindleRendererSelectionRenderer.createSelectionElements(b.contentDocument,f,d,[a]);var g=b.contentDocument.createElement("DIV");g.id=Ga;g.appendChild(f);c.appendChild(g)}}catch(e){}},clearSelection:function(){fa&&sa(w[E])},getPageSelectableItemBoundaries:function(){h();try{if(!va){var a=w[E];a.contentDocument.getElementsByTagName("body")[0]!==null&&(va=KindlePaginator.getSelectableItemBoundariesForCurrentPage(a))}return va}catch(b){}},
onWindowResize:function(){fa&&P(H().currentTopOfPage)},handleClick:function(a,b){var c=w[E].contentDocument.elementFromPoint(a,b),d=KindlePaginator.getContentCoordinates(w[E],a,b);return KindleRendererEventHandler.handleClick(w[E].contentDocument,c,d)},reloadAnnotations:function(){if(fa){ja(w[E]);var a=w[N];a!==void 0&&a.loadedType!==void 0&&a.loadedType!==ma&&ja(a)}},getDisplayedText:function(a,b){h();return ca(Number(a),Number(b))},getMaximumMobiPosition:function(){return KindleRenderer.getMaximumPosition()},
getMinimumMobiPosition:function(){return KindleRenderer.getMinimumPosition()},gotoMobiPosition:function(a){KindleRenderer.gotoPosition(a)}}}(),KindleRendererAnnotationRenderer=function(){function e(b,c){return b.top<c.top?-1:b.top>c.top?1:b.left-c.left}function k(b,d,j,k){var f,a;j.sort(e);for(var n=0;n<j.length;n+=1)a=b.createElement("DIV"),$(a).addClass(k),a.style.top=j[n].top+c,a.style.height=j[n].height+c,n===0||j[n-1].top!==j[n].top?(a.style.left=j[n].left+c,a.style.width=j[n].width+c):(f=j[n-
1].left+j[n-1].width,a.style.left=f+c,a.style.width=j[n].left-f+j[n].width+c),d.appendChild(a)}function d(b,d,e,k){b=b.createElement("DIV");$(b).addClass(k);b.style.top=e.top+c;b.style.left=e.left+e.width+c;d.appendChild(b)}var c="px";return{NOTE_CLASS:"amazon-note",createAnnotationElements:function(b,c,e,o){if(e!==null){var f;if(c!==null)for(f=0;f<e.length;f+=1)if(e[f].type===KindleReaderAnnotationManager.HIGHLIGHT){var a=b,n=o,m=c,h=e[f],p=a.createElement("DIV");p.setAttribute("annotationType",
h.type);p.setAttribute("annotationStart",h.start);for(var g=[],r=h.start;r<=h.end;r+=1){var q=m[r];if(q!==void 0)for(var t=0;t<q.length;t++)g.push(q[t])}k(a,p,g,"amazon-highlight");n.appendChild(p)}else{if(e[f].type===KindleReaderAnnotationManager.NOTE){a=b;n=o;m=e[f];h=c[m.start];for(p=-1;h===void 0&&p<100;)h=c[m.start+p],p+=1;h!==void 0&&(h=h[h.length-1],p=a.createElement("DIV"),p.setAttribute("annotationType",m.type),p.setAttribute("annotationStart",m.start),d(a,p,h,"amazon-note"),n.appendChild(p))}}else{c=
[];c=c.concat(Array.prototype.slice.call(b.getElementsByTagName("CANVAS")));c=c.concat(Array.prototype.slice.call(b.getElementsByClassName("k4w")));for(f=0;f<e.length;f+=1)if(e[f].type===KindleReaderAnnotationManager.HIGHLIGHT){a=b;n=o;m=c;g=e[f];h=a.createElement("DIV");h.setAttribute("annotationType",g.type);h.setAttribute("annotationStart",g.start);p=g.start;g=g.end;r=[];for(q=0;q<m.length;q+=1)m[q].id>=p&&m[q].id<=g&&(t=$(m[q]).offset(),r.push({top:t.top,left:t.left,width:$(m[q]).width(),height:$(m[q]).height()}));
k(a,h,r,"amazon-highlight");n.appendChild(h)}else if(e[f].type===KindleReaderAnnotationManager.NOTE){a=b;n=o;m=e[f];h=c;p=null;for(q=r=g=0;q<h.length;q+=1)if(r=Math.abs(m.start-h[q].id),p===null||r<g)g=r,p=q;p!==null?(g=$(h[p]).offset(),h={top:g.top,left:g.left,width:$(h[p]).width(),height:$(h[p]).height()}):h=null;h!==null&&(p=a.createElement("DIV"),p.setAttribute("annotationType",m.type),p.setAttribute("annotationStart",m.start),d(a,p,h,"amazon-note"),n.appendChild(p))}}}}}}(),KindleRendererCanvasInsertion=
function(){function e(c,d){l[c]++;var a=l[c],e=b[c],m=null;a>e.length?(m=d.createElement("CANVAS"),j+=1,e[a-1]=m):m=e[a-1];return m}function k(b,c){c.id=b.id;c.setAttribute("height",b.getAttribute("height"));c.setAttribute("width",b.getAttribute("width"));c.innerHTML=b.innerHTML}function d(b,c){for(var a=b;a<c.length;a++){c[a].innerHTML="";c[a].width=0;for(var d=c[a].attributes.length;--d>=0;)c[a].removeAttribute(c[a].attributes[d].nodeName)}}function c(c,f,a,j){var m=f.getElementsByTagName("html")[0],
h=f.getElementsByTagName("body")[0],p=h.getElementsByClassName("k4wc");if(p.length>0){m.removeChild(h);p.length===0&&(p=h.getElementsByClassName("k4wc"));var g=p.length,r=KindleRendererDeviceSpecific.maximumCanvases();l[c]=0;var q=null;b[c]||(b[c]=[]);for(var t=0;t<g;t++){var s=p[j?p.length-1:0];if(l[c]>=r)if(s.parentNode.removeChild(s),s=parseInt(s.id,10),j){if(q===null||s>q)q=s}else{if(q===null||s<q)q=s}else{var v=e(c,f);k(s,v);s.parentNode.replaceChild(v,s)}}if(q!==null){f=KindleMetricsProfiler("remove-extra-canvases");
if(j){if($(h).find("*").filter(function(){return parseInt($(this).attr("id"),10)<q}).remove(),a.startPosition<=q)a.startPosition=q+1}else if($(h).find("*").filter(function(){return parseInt($(this).attr("id"),10)>q}).remove(),a.endPosition>=q)a.endPosition=q-1;f.endTimer();f.log()}d(l[c],b[c]);m.appendChild(h)}p=null}var b=[],l=[],j=0;return{changeSpanToCanvas:function(b,d,a,e){c(b,d,a,e)},cleanup:function(){for(var c in b)for(var d=b[c],a=d.length,e=0;e<a;e+=1){var j=d[e],h=j.parentNode;h!==null&&
h!==void 0&&h.removeChild(j)}b=null}}}(),KindleRendererContentReflow=function(){function e(a,b,c){KindleRendererWordMapGenerator.createWordMap(a.contentDocument,b,function(b){KindlePaginatorScreenFragmentation(a.contentDocument,b,$(a).parent().height(),c)})}function k(b,c){if(!(a!==c.requestId||b.processingRequestId!==c.requestId)){b.setAttribute("height","100%");$(b.contentWindow).scrollTop(0);for(var f={height:$(b).parent().height(),width:$(b).parent().width()},e=b.contentDocument.getElementsByTagName("body")[0],
g=e.getElementsByClassName("k4w-margin"),j=0;j<g.length;j+=1){var l=parseInt(g[j].getAttribute("vertical"),10);if(l>0)g[j].style.marginTop=Math.round(l*0.01*f.height)+"px"}var k=c.reflowMetrics.createSubTimer("image-reflow");KindleRendererElementFitting.fitToViewport(e,f,function(){c.requestId!==a||b.processingRequestId!==c.requestId?(c.reflowMetrics.addCount("Cancelled",1),c.reflowMetrics.endTimer()):(k.endTimer(),d(b,c))})}}function d(b,c){var d=c.reflowMetrics.createSubTimer("screen-splitting");
e(b,c.positionData,function(e){d.endTimer();d.log();c.requestId!==a||b.processingRequestId!==c.requestId?(c.reflowMetrics.addCount("Cancelled",1),c.reflowMetrics.endTimer()):(b.screenManager=e,o!==null&&clearTimeout(o),a=f=null,c.reflowMetrics.addCount("Success",1),c.reflowMetrics.endTimer(),l(b,c))})}function c(b){o!==null&&clearTimeout(o);var c=KindleRendererDeviceSpecific.reflowTimeout();c>0&&(o=setTimeout(function(){a===b.requestId&&(a=f=null,b.reflowMetrics.addCount("Timeout",1),b.reflowMetrics.endTimer(),
j(b))},c))}function b(b,d){if(!(a!==null&&d.requestId<a)){c(d);f=d.type;a=d.requestId;d.reflowMetrics=d.metrics.createSubTimer("frame-reflow");var e=d.reflowMetrics.createSubTimer("waiting-to-begin");setTimeout(function(){e.endTimer();k(b,d)},KindleRendererDeviceSpecific.drawYieldUpdateTime())}}var l=null,j=null,o=null,f=null,a=null;return{initialize:function(a,b){l=a;j=b},reflow:function(a,c){b(a,c)},getCurrentlyReflowingType:function(){return f},toggleDrawWordMap:function(){}}}(),KindleRendererContentScripts=
function(){return{addInterfaceScripts:function(e){var k=document.createElement("script");k.language="Javascript";k.type="text/javascript";k.id="kindleContentInterface";if(!(/MSIE ((5\.5)|6|(7\.0))/.test(navigator.userAgent)&&navigator.platform==="Win32"))try{e.appendChild(k),e="var KindleContentInterface = function() { return { ",e+=" gotoPosition : function(frm, pos) {parent.KindleReaderUI.gotoPosition(pos); return false;}, ",e+=" buyNow : function() {parent.KindleReaderUI.openStoreDP();return false;}, ",
e+=" showDetails : function() {parent.KindleReaderUI.openStoreDP();  return false;} ",e+=" };}();",k.text=e}catch(d){}}}}(),KindleRendererDefaults=function(){function e(e,d,c){e.styleSheet&&e.styleSheet.addRule?e.styleSheet.addRule(d,c):e.sheet&&e.sheet.insertRule&&e.sheet.insertRule(d+"{"+c+"}",0)}return{addCSSRules:function(k,d){var c=document.createElement("style");c.type="text/css";c.id="kindleReaderStylesheet";if(!(/MSIE ((5\.5)|6|(7\.0))/.test(navigator.userAgent)&&navigator.platform==="Win32"))try{k.appendChild(c),
d==="mobi7"&&(e(c,"body","font-family: Georgia, serif; word-wrap: break-word;"),e(c,"p","margin-top: 0px; margin-bottom: 0px; text-indent:2em"),e(c,".was-a-p","margin-top: 0px; margin-bottom: 0px; text-indent:2em;"),e(c,"hr","margin-top: 15px; margin-bottom: 15px;"),e(c,"center,dd,div,dl,dt,li,ol,pre,table,ul,hr,h1,h2,h3,h4,h5,h6","margin-top: 0px; margin-bottom: 0px;"),e(c,"blockquote","text-indent: 0px; margin-top: 0px; margin-bottom: 0px;"),e(c,"ul","list-style-type: disc;"),e(c,"ol, ul, li .was-a-p",
"text-indent: 0;"),e(c,"table.amazon-table-style-0","border-collapse:collapse;"),e(c,"table.amazon-table-style-0 tr td","border:none; padding:1px;"),e(c,"table.amazon-table-style-0 tr th","border:none; padding:1px; text-align:justify"),e(c,"table.amazon-table-style-1","border-collapse:collapse;"),e(c,"table.amazon-table-style-1 tr td","border:1px solid black; padding:1px;"),e(c,"table.amazon-table-style-1 tr th","border:1px solid black; padding:1px; text-align:justify")),e(c,"svg img","display: none;"),
e(c,".page-break","display:block;"),e(c,"div.amazon-highlight","position: absolute; z-index: -10;"),e(c,"div.amazon-selection","position: absolute; z-index: -9;"),e(c,"div.amazon-note",'position: absolute; width: 10px; height: 10px; background-image: url("./images/override/NotesPane/note-selected.png"); cursor: pointer; margin-top: 0px; margin-left:-2px;'),e(c,".defaultHighlight","background-color:#ffff9b"),e(c,".noDisplay","display:none"),e(c,"body","-webkit-user-select:none; -moz-user-select:none; unselectable: on; cursor: default;")}catch(b){}}}}(),
KindleRendererDeviceSpecific=function(){var e={};return{initialize:function(){KindleHostDeviceDetector.getDevicePlatform()==="desktop"?(e.fragmentBufferCapacityForGoTo=2,e.fragmentBufferCapacityForPageFlip=10,e.fragmentBufferCapacityForPageFlipGlyphs=3,e.drawYieldUpdateTime=25,e.drawYieldScreenManagerFrequency=5E3,e.drawYieldGlyphRendereringFrequency=1E3,e.reflowTimeout=-1,e.maximumCanvases=4900):(e.fragmentBufferCapacityForGoTo=1.2,e.fragmentBufferCapacityForPageFlip=7,e.fragmentBufferCapacityForPageFlipGlyphs=
2,e.drawYieldUpdateTime=50,e.drawYieldScreenManagerFrequency=250,e.drawYieldGlyphRendereringFrequency=200,e.reflowTimeout=1E4,e.maximumCanvases=1750);e.needsReflowOnPageFlip=KindleHostDeviceDetector.isiOS()&&!KindleHostDeviceDetector.isiOS_5x()},fragmentBufferCapacityForGoTo:function(){return e.fragmentBufferCapacityForGoTo},fragmentBufferCapacityForPageFlip:function(k){return k?e.fragmentBufferCapacityForPageFlipGlyphs:e.fragmentBufferCapacityForPageFlip},drawYieldUpdateTime:function(){return e.drawYieldUpdateTime},
drawYieldScreenManagerFrequency:function(){return e.drawYieldScreenManagerFrequency},drawYieldGlyphRendereringFrequency:function(){return e.drawYieldGlyphRendereringFrequency},needsReflowOnPageFlip:function(){return e.needsReflowOnPageFlip},reflowTimeout:function(){return e.reflowTimeout},maximumCanvases:function(){return e.maximumCanvases}}}(),KindleRendererElementFitting=function(){function e(b){b.getAttribute("nativeHeight")||b.setAttribute("nativeHeight",b.height);b.getAttribute("nativeWidth")||
b.setAttribute("nativeWidth",b.width)}function k(b,c){for(var d={neededCount:0,downloadedCount:0},k=function(a){e(a.target);d.downloadedCount+=1;d.downloadedCount===d.neededCount&&setTimeout(c,KindleRendererDeviceSpecific.drawYieldUpdateTime())},f=0;f<b.length;f+=1)if(b[f].src!=="")b[f].complete&&b[f].complete===!1||b[f].height===0?(d.neededCount+=1,b[f].onerror=k,b[f].onload=k,b[f].onabort=k):e(b[f]);d.neededCount===0&&setTimeout(c,KindleRendererDeviceSpecific.drawYieldUpdateTime())}function d(b,
d,e){var o=b.getElementsByTagName("IMG");o.length>0?k(o,function(){for(var b=0;b<o.length;b+=1){var a=o[b],k=d,m=0,h=m=0,p=a.getAttribute("nativeHeight"),g=a.getAttribute("nativeWidth");p>k.height*c&&(m=k.height*c/p);g>k.width*c&&(h=k.width*c/g);m=m>0&&h>0?m<h?m:h:m>0?m:h;if(m!==0)a.style.height=m*p+"px",a.style.width=m*g+"px"}e()}):setTimeout(e,10)}var c=0.95;return{fitToViewport:function(b,c,e){d(b,c,e)}}}(),KindleRendererEventHandler=function(){function e(e,d,c){for(var b=e.length,l=0;l<b;l+=1){var j=
e[l],o=$(j).offset();if(o.top-c<d.y&&d.y<o.top+$(j).height()+c&&o.left-c<d.x&&d.x<o.left+$(j).width()+c)return j}return null}return{handleClick:function(k,d,c){k.getElementsByTagName("body");var b;b:{for(b=d;b!==null;){if(b.getAttribute!==void 0){var l=b.getAttribute("onclick")||b.getAttribute("href");if(l!==null&&l.length>0){b=!0;break b}}b=b.parentNode}b=!1}d=b?d:null;d===null&&(k=k.getElementsByClassName(KindleRendererAnnotationRenderer.NOTE_CLASS),e(k,c,10)&&(d=e(k,c,10)));d!==null?(c=document.createEvent("MouseEvents"),
c.initEvent("click",!0,!0),d.dispatchEvent(c),c=!0):c=!1;return c}}}(),KindleRendererFragmentLoader=function(){function e(b,a){o===b.requestId&&(j=null,c(b,a))}function k(c,a){o===a.requestId&&(j=null,b(c,a))}function d(d,a,j,m,h){c=a;b=j;KindlePaginatorContentFragmentation.initialize(d,e,k,function(a){l=a.fragmentArray;m(a)},h)}var c=null,b=null,l=null,j=null,o=null;return{initialize:function(b,a,c,e,h){d(b,a,c,e,h)},loadFragments:function(b,a){j=a.type;o=a.requestId;KindlePaginatorContentFragmentation.loadNextFragmentGroup(b,
a)},getCurrentlyLoadingType:function(){return j},getMaximumPosition:function(){return l[l.length-1].ePos},getMinimumPosition:function(){return l[0].cPos}}}(),KindleRendererSelectionRenderer=function(){function e(b,c){return b.top<c.top?-1:b.top>c.top?1:b.left-c.left}function k(b,d,j,k){var f,a;j.sort(e);for(var n=0;n<j.length;n+=1)a=b.createElement("DIV"),$(a).addClass(k),a.style.top=j[n].top+c,a.style.height=j[n].height+c,n===0||j[n-1].top!==j[n].top?(a.style.left=j[n].left+c,a.style.width=j[n].width+
c):(f=j[n-1].left+j[n-1].width,a.style.left=f+c,a.style.width=j[n].left-f+j[n].width+c),d.appendChild(a)}function d(b,c){var d=b.createElement("DIV");d.setAttribute("selectionStart",c.start);return d}var c="px";return{createSelectionElements:function(b,c,e,o){var f;if(e!==null)for(f=0;f<o.length;++f){for(var a=b,n=c,m=e,h=o[f],p=d(a,h),g=[],r=h.start;r<=h.end;r+=1){var q=m[r];if(q!==void 0)for(var t=0;t<q.length;t++)g.push(q[t])}k(a,p,g,"amazon-selection");n.appendChild(p)}else{e=[];e=e.concat(Array.prototype.slice.call(b.getElementsByTagName("CANVAS")));
e=e.concat(Array.prototype.slice.call(b.getElementsByClassName("k4w")));for(f=0;f<o.length;++f){a=b;n=c;h=e;g=o[f];m=d(a,g);p=g.start;g=g.end;r=[];for(q=0;q<h.length;q+=1)h[q].id>=p&&h[q].id<=g&&(t=$(h[q]).offset(),r.push({top:t.top,left:t.left,width:$(h[q]).width(),height:$(h[q]).height()}));k(a,m,r,"amazon-selection");n.appendChild(m)}}}}}(),KindleRendererSettings=function(){function e(e,d,c){e.styleSheet&&e.styleSheet.addRule?e.styleSheet.addRule(d,c):e.sheet&&e.sheet.insertRule&&e.sheet.insertRule(d+
"{"+c+"}",0)}return{addCSSRules:function(k,d){var c=document.getElementById("kindleRendererOptionsStylesheet");c!==void 0&&c!==null&&c.parentNode.removeChild(c);c=document.createElement("style");c.type="text/css";c.id="kindleRendererOptionsStylesheet";if(!(/MSIE ((5\.5)|6|(7\.0))/.test(navigator.userAgent)&&navigator.platform==="Win32"))try{k.appendChild(c);var b;if(d.fontSizes!==void 0){e(c,"body","font-size : "+d.fontSizes[2]+d.fontSizeUnits);for(b=0;b<d.fontSizes.length;b+=1)e(c,".font-size-"+
(b+1),"font-size : "+d.fontSizes[b]+d.fontSizeUnits)}d.fontColor!==void 0&&e(c,"body","color : "+d.fontColor);d.fontFamily!==void 0&&e(c,"body","font-family : "+d.fontFamily);d.lineHeight!==void 0&&e(c,"body","line-height : "+d.lineHeight);d.backgroundColor!==void 0&&e(c,"body","background-color : "+d.backgroundColor);d.highlightColor!==void 0&&e(c,"div.amazon-highlight","background-color : "+d.highlightColor);d.selectionColor!==void 0&&e(c,"div.amazon-selection","background-color : "+d.selectionColor);
d.insertBgColor!==void 0&&e(c,".insert","background-color : "+d.insertBgColor);if(d.additionalRules!==void 0&&d.additionalRules.length!==void 0)for(b=0;b<d.additionalRules.length;b+=1)e(c,d.additionalRules[b].selector,d.additionalRules[b].style)}catch(l){}}}}(),KindleRendererWordMapGenerator=function(){function e(b,c,d,f,a){function k(){m!==null&&m.endTimer();e(b,c+1,d,f,a)}for(var m=null,h=0;c<b.length;){var p=b[c],g=p.getClientRects();f[p.id]=g;h+=1;if(h>d.interval){m=f.creationTimer.createSubTimer("wait-timer");
setTimeout(k,d.time);return}c+=1}setTimeout(a,d.time)}function k(b,c,d){var f=[],f=f.concat(Array.prototype.slice.call(b.getElementsByTagName("IMG"))),f=f.concat(Array.prototype.slice.call(b.getElementsByTagName("CANVAS"))),f=f.concat(Array.prototype.slice.call(b.getElementsByClassName("k4w"))),b={interval:KindleRendererDeviceSpecific.drawYieldScreenManagerFrequency(),time:KindleRendererDeviceSpecific.drawYieldUpdateTime()};e(f,0,b,c,d)}function d(b,c,d,f,a){var e=c.nodeValue;if(e)for(var k=0,h=0,
p=0,g=e.length,r=0;r<=g;r++){var q=e.charCodeAt(r);k+=q<128?1:q<2048?2:q<65536?3:4;if(r===g||q===32||q===45||q===8212){a:{var q=c,t=r;if(t>h){var s=d.createRange();s.setStart(q,h);s.setEnd(q,t);if(s.getBoundingClientRect&&(q=s.getBoundingClientRect()))break a}q=null}if(q!==null){a:if(h=f[b.parentId+"_"+b.index],h===void 0||h.length===0)p=0;else{for(t=1;t<h.length;t+=1)if(h[t][0]>p){p=h[t-1][1]+(p-h[t-1][0]);break a}p=h[0][1]+(p-h[0][0])}a[p]=[q]}h=r+1;p=k}}}function c(b,c,e,f){for(var a=b.iterateNext();a;){if(a.parentNode.tagName!==
"SCRIPT"){var k=a.parentNode,m=k.id,h=0;if(a.ownChildIndex===void 0)for(;k.childNodes[h]!==a;)h+=1;else h=a.ownChildIndex;d({parentId:m,index:h},a,c,e,f)}a=b.iterateNext()}}function b(c,e,k,f,a){if(e.nodeType===Node.TEXT_NODE)d(c,e,k,f,a);else for(var c=e.childNodes,n=c.length,e={parentId:e.id},m=0;m<n;m+=1)e.index=m,b(e,c[m],k,f,a)}return{createWordMap:function(d,e,o){function f(){a.creationTimer.endTimer();a.creationTimer.log();delete a.creationTimer;o(a)}var a={};a.creationTimer=KindleMetricsProfiler("creating-word-map");
if(e===void 0)k(d,a,f);else if(e!==null){if(window.ActiveXObject&&window.XMLHttpRequest){var n=d.getElementsByTagName("body")[0];b(null,n,d,e,a)}else n=(new XPathEvaluator).evaluate("//*/text()",d,null,XPathResult.UNORDERED_NODE_ITERATOR_TYPE,null),c(n,d,e,a);f()}}}}(),KindleDialogOverlay=function(){return{showOverlay:function(e){$("body").append("<div class='ui-widget-overlay ui-widget-overlay-kcr-ios-hack'></div>");$(".ui-widget-overlay-kcr-ios-hack").attr("style","z-index: 1000;").width(window.outerWidth).height(window.outerHeight);
(function(){var k=e.component.dialog("option","position");$("body",top.document).bind("orientationchange.dialog",function(){e.dialogSettings.k4w_transparent_modal_overlay&&$(".ui-widget-overlay-kcr-ios-hack").css({width:0,height:0});$(".ui-widget-overlay-kcr-ios-hack").css({width:window.outerWidth+"px",height:window.outerHeight+"px"});e.component.dialog("option","position",k)})})();(function(){e.callbacks.onOverlayClicked&&$(".ui-widget-overlay-kcr-ios-hack").tap(function(e){e.preventDefault()})})()},
removeOverlay:function(){$(".ui-widget-overlay-kcr-ios-hack").remove();$("body",top.document).unbind("orientationchange.dialog")}}}(),KindleEnableOfflineDialog=function(){function e(){KindleUXComponentManager.closeDialog(k)}var k="KindleEnableOfflineDialog",d={BUTTON_TEXT:"kindle_dialog_enableOffline_button_text",OFFLINE_TITLE:"kindle_dialog_enable_offline_title",FIREFOX_MSG:"kindle_dialog_enable_offline_firefox_msg"},c={DIALOG:"kindle_dialog_enableOffline",CONTENT:"kindle_dialog_enableOffline_content",
BUTTON:"kindle_dialog_enableOffline_button"},b={TITLE:"enable_offline_title",TOP_MSG:"enable_offline_top_msg"},l,j={getDialogSettings:function(){return{autoOpen:!1,width:626,modal:!0,draggable:!1,resizable:!1,dialogClass:"enableOfflineDialog"}},beforeDialogOpen:function(j){l=j;var f,a;KindleHostDeviceDetector.isFirefox()&&(f=ResourceBundle.getLocalizedString(d.OFFLINE_TITLE),a=ResourceBundle.getLocalizedString(d.FIREFOX_MSG));j={title:f,topInstruction:a,topInstructionClass:void 0};l.find("#"+b.TITLE).html(j.title);
l.find("#"+b.TOP_MSG).html(j.topInstruction);j.topInstructionClass&&l.find("#"+b.TOP_MSG).addClass(j.topInstructionClass);j=l.find("#"+c.BUTTON);j.html(ResourceBundle.getLocalizedString(d.BUTTON_TEXT));j.one("click",e)},onDialogOpen:function(){var b=$("#"+c.DIALOG);b.parents(".ui-dialog:first").removeClass("ui-widget ui-widget-content ui-corner-all");b.removeClass("ui-dialog-content ui-widget-content")}};return{open:function(){KindleUXComponentManager.openDialog(k,j)},close:function(){KindleUXComponentManager.closeDialog(k)}}}(),
KindleFirstRunDialog=function(){function e(){KindleUXComponentManager.closeDialog(d);o()}function k(){var a,b,d,e,f;KindleHostDeviceDetector.isChromeApp()?(b=ResourceBundle.getLocalizedString(c.CHROME_APP_TITLE),d=ResourceBundle.getLocalizedString(c.CHROME_APP_MSG)):KindleHostDeviceDetector.isChrome()?(e="continue",b=ResourceBundle.getLocalizedString(c.OFFLINE_TITLE),d=ResourceBundle.getLocalizedString(c.CHROME_MSG)):KindleHostDeviceDetector.isiOS()?(a="ipad_prompt",b=ResourceBundle.getLocalizedString(c.OFFLINE_TITLE),
d=ResourceBundle.getLocalizedString(c.IOS_PROMPT_MSG)):KindleHostDeviceDetector.isFirefox()?(a="ff_prompt",b=ResourceBundle.getLocalizedString(c.OFFLINE_TITLE),d=ResourceBundle.getLocalizedString(c.FIREFOX_MSG),f="ff-db-msg"):(a="safari_prompt",b=ResourceBundle.getLocalizedString(c.OFFLINE_TITLE),d=ResourceBundle.getLocalizedString(c.SAFARI_PROMPT_MSG));return{topImgClass:a,title:b,topInstruction:d,bottomImgClass:e,topInstructionClass:f}}var d="KindleFirstRunDialog",c={BUTTON_TEXT:"kindle_dialog_firstRun_button_text",
BUTTON_TEXT_CHROME:"kindle_dialog_firstRun_button_text_chrome",CRX_BUTTON_TEXT:"kindle_dialog_firstRun_button_crx_text",INSTALLING_BUTTON_TEXT:"kindle_dialog_firstRun_button_installing_text",INSTALLED_BUTTON_TEXT:"kindle_dialog_firstRun_button_installed_text",CONTINUE_BUTTON_TEXT:"kindle_dialog_firstRun_button_text_chrome_done",OFFLINE_TITLE:"kindle_dialog_firstRun_offline_title",CHROME_APP_TITLE:"kindle_dialog_firstRun_chrome_app_title",CHROME_APP_MSG:"kindle_dialog_firstRun_chrome_app_msg",CHROME_MSG:"kindle_dialog_firstRun_chrome_msg",
FIREFOX_MSG:"kindle_dialog_firstRun_firefox_msg",IOS_PROMPT_MSG:"kindle_dialog_firstRun_ios_prompt_msg",SAFARI_PROMPT_MSG:"kindle_dialog_firstRun_safari_prompt_msg"},b={DIALOG:"kindle_dialog_firstRun",CONTENT:"kindle_dialog_firstRun_content",BUTTON:"kindle_dialog_firstRun_button",CRX_BUTTON:"kindle_dialog_firstRun_button_crx"},l={TITLE:"first_run_title",TOP_MSG:"first_run_top_msg",TOP_IMG:"first_run_top_img",BOTTOM_IMG:"first_run_bottom_img"},j="/static/crx/001/kcr-chrome.crx",o,f,a,n={getDialogSettings:function(){return{autoOpen:!1,
width:626,modal:!0,draggable:!1,resizable:!1,dialogClass:"firstRunDialog"}},beforeDialogOpen:function(d){function h(){r.addClass("disabled");r.html(ResourceBundle.getLocalizedString(c.INSTALLING_BUTTON_TEXT));a=window.setInterval(n,500);window.location.replace(j)}function n(){KindleHostDeviceDetector.isChromeApp()&&(window.clearInterval(a),g.addClass("main").html(ResourceBundle.getLocalizedString(c.CONTINUE_BUTTON_TEXT)),r.html(ResourceBundle.getLocalizedString(c.INSTALLED_BUTTON_TEXT)))}f=d;d=k();
f.find("#"+l.TITLE).html(d.title);f.find("#"+l.TOP_MSG).html(d.topInstruction);d.topImgClass&&f.find("#"+l.TOP_IMG).addClass(d.topImgClass);d.bottomImgClass&&f.find("#"+l.BOTTOM_IMG).addClass(d.bottomImgClass);d.topInstructionClass&&f.find("#"+l.TOP_MSG).addClass(d.topInstructionClass);var g=f.find("#"+b.BUTTON);g.html(ResourceBundle.getLocalizedString(c.BUTTON_TEXT));g.one("click",e);if(KindleHostDeviceDetector.isChrome()&&!KindleHostDeviceDetector.isChromeApp()){g.removeClass("primary_btn").addClass("chrome_btn").html(ResourceBundle.getLocalizedString(c.BUTTON_TEXT_CHROME));
var r=f.find("#"+b.CRX_BUTTON);r.removeClass("disabled").html(ResourceBundle.getLocalizedString(c.CRX_BUTTON_TEXT));r.one("click",h);r.show()}},onDialogOpen:function(){var a=$("#"+b.DIALOG);a.parents(".ui-dialog:first").removeClass("ui-widget ui-widget-content ui-corner-all");a.removeClass("ui-dialog-content ui-widget-content")},onDialogClose:function(){a&&window.clearInterval(a)}};return{open:function(a){o=a;KindleUXComponentManager.openDialog(d,n)},close:function(){KindleUXComponentManager.closeDialog(d)}}}(),
KindleMessageDialog=function(){var e={TITLE_ID:"kindle_dialog_message_title_text",TEXT_ID:"kindle_dialog_message_text"},k,d={dismiss:"k4w_dialog_message_dismissButton_text"},c,b,l,j,o=function(){KindleUXComponentManager.closeDialog("KindleMessageDialog")},f={getDialogSettings:function(){return{autoOpen:!1,modal:!0,draggable:!1,resizable:!1,k4w_transparent_modal_overlay:!0}},beforeDialogOpen:function(a){var c={};j?c[j]=o:c[ResourceBundle.getLocalizedString(d.dismiss)]=o;if(_additionalButtons)for(var f=
0;f<_additionalButtons.length;f++){var k=_additionalButtons[f];c[k.buttonText]=k.callback}a.dialog("option","buttons",c);a.find("#"+e.TITLE_ID).empty().append(l);a.find("#"+e.TEXT_ID).empty().append(b)},onDialogClose:function(){c&&c()}},a=function(a,e,h,k,g){c=h;l=a;b=e;_additionalButtons=g;j=k?k:ResourceBundle.getLocalizedString(d.dismiss);KindleUXComponentManager.openDialog("KindleMessageDialog",f)};return{open:a,close:o,showError:function(b,c,d,e){k||(k={},k[Kindle.ERROR.OUT_OF_SPACE]="k4w_library_saveBookOutOfSpace",
k[Kindle.ERROR.TIMEOUT]="k4w_library_openBookTimeoutError",k[Kindle.ERROR.LOAD_FAILURE]="k4w_library_openBookLoadFailure",k[Kindle.ERROR.REMOVE_FAILURE]="k4w_library_removeBookError",k[Kindle.ERROR.REMOVE_NETWORK_FAILURE]="k4w_library_removeBookNetworkError",k[Kindle.ERROR.BOOKEXTRAS_OPEN_FAILED]="k4w_bookextras_open_failed_Error",k[Kindle.ERROR.BOOKEXTRAS_NO_CACHE_ERROR]="k4w_bookextras_offline_cache_failed_Error",k[Kindle.ERROR.CONTENT_LOANED]="k4w_library_openBookContentLoanedError",k[Kindle.ERROR.CONTENT_LOAN_ENDED]=
"k4w_library_openBookContentLoanEndedError",k[Kindle.ERROR.CONTENT_LICENSE_EXCEEDED]="k4w_library_openBookContentLicenseExceededError",k[Kindle.ERROR.CONTENT_UNSUPPORTED]="k4w_library_openBookContentUnsupportedError",k[Kindle.ERROR.CONTENT_RENTAL_EXPIRED]="k4w_library_openBookContentRentalExpiredError",k[Kindle.ERROR.SESSION_LIMIT_EXCEEDED]="k4w_library_openBookSessionLimitExceededError",k[Kindle.ERROR.BOOK_NOT_AVAILABLE]="k4w_library_bookNotAvailable",k[Kindle.ERROR.STORE_NOT_AVAILABLE]="k4w_library_storeNotAvailable",
k[Kindle.ERROR.STORE_OPEN_FAILED]="k4w_store_open_failed_Error",k[Kindle.ERROR.STORE_OPEN_OFFLINE_FAILED]="k4w_store_open_failed_offline_Error",k[Kindle.ERROR.SYNC_FAILED]="k4w_library_syncFailedError",k[Kindle.ERROR.SYNC_FAILED_OFFLINE]="k4w_library_syncFailedOfflineError",k[Kindle.ERROR.NOT_IMPLEMENTED]="k4w_library_unimplementedFeature_Error",k[Kindle.ERROR.LIBRARY_LOAD_FAILED]="k4w_library_loadFailedError",k[Kindle.ERROR.NETWORK]="k4w_library_openBookNetworkError",k[Kindle.ERROR.UNKNOWN_ERR]=
"k4w_library_unknownError");(b=k[b])||(b=k[Kindle.ERROR.UNKNOWN_ERR]);a(ResourceBundle.getLocalizedString(b+"_Title"),ResourceBundle.getLocalizedString(b+"_Text"),c,d,e)}}}(),KindlePopupMenu=function(){function e(b){var e=KindleUXComponentManager.renderTemplate(c),h=e.find("#kindle_menu_border"),j=m[b].menuItems,l=!0,s,v;for(v in j)s=$(document.createElement("div")).addClass(o).addClass(f).text(v),l&&(s.addClass(a),l=!1),s.tap(k(s,j[v])),h.append(s);s.addClass(n);KindleHostDeviceDetector.isiOS()&&
"onorientationchange"in window&&$("body",top.document).bind("orientationchange",function(){KindleUXComponentManager.hideMenu(b)});m[b].doneCallback(e,d(b))}function k(a,b){return function(){a.hasClass(f)&&b()}}function d(a){return{getDialogSettings:function(){var c=b,d=m[a];d.buttonID&&(c+=" "+(d.position==="down"?l:j));return{autoOpen:!1,draggable:!1,resizable:!1,modal:!0,minHeight:0,width:"auto",dialogClass:c,k4w_transparent_modal_overlay:!0}},beforeDialogOpen:function(b){var c=m[a].buttonID,d=
m[a].position,e=[];c?(c=$("#"+c),d==="down"?(e[0]=c.offset().left,e[1]=c.offset().top+c.outerHeight()):(e[0]="right",e[1]="bottom")):e=d;b.dialog("option","position",e)},onDialogOpen:function(){h=!0},onDialogClose:function(){h=!1},onOverlayClicked:function(){h&&KindleUXComponentManager.hideMenu(a)}}}var c="KindlePopupMenu",b="kindle_menu",l="down_menu",j="up_menu",o="kindle_menu_button",f="button_enabled",a="ui-corner-top",n="ui-corner-bottom",m={},h=!1;return{ITEM_ENABLED:0,ITEM_DISABLED:1,ITEM_HIDDEN:2,
initialize:function(a,b,d,f,h){m[a]={menuItems:d,doneCallback:h,buttonID:b,position:f};KindleUXComponentManager.hasTemplate(c)?e(a):KindleUXComponentManager.initializeTemplate(c,function(){e(a)})},updateMenu:function(b,c){for(var d,e,h=0;h<c.length;h++)c[h]!==2&&(d===void 0&&(d=h),e=h);b.find("."+o).each(function(b){$(this).removeClass().addClass(o);switch(c[b]){case 0:$(this).addClass(f);break;case 1:$(this).addClass("button_disabled");break;case 2:$(this).addClass("button_hidden")}b===d&&$(this).addClass(a);
b===e&&$(this).addClass(n)})},updatePosition:function(a,b){m[a].position=b}}}(),KindlePromptDialog=function(){var e={TEXT_LABEL_STRING_ID:"k4w_reader_syncPosition_labelText",OK_BUTTON_STRING_ID:"k4w_common_confirm_button",CANCEL_BUTTON_STRING_ID:"k4w_common_cancel_button"},k={TEXT_LABEL_ID:"kindle_dialog_prompt_label"},d,c,b,l=function(){b="ok";KindleUXComponentManager.closeDialog("KindlePromptDialog")},j=function(){b="cancel";KindleUXComponentManager.closeDialog("KindlePromptDialog")},o={getDialogSettings:function(){var b=
{};b[ResourceBundle.getLocalizedString(e.CANCEL_BUTTON_STRING_ID)]=j;b[ResourceBundle.getLocalizedString(e.OK_BUTTON_STRING_ID)]=l;return{autoOpen:!1,modal:!0,draggable:!1,resizable:!1,buttons:b,k4w_transparent_modal_overlay:!0}},beforeDialogOpen:function(b){var a=ResourceBundle.getLocalizedString(c);b.find("#"+k.TEXT_LABEL_ID).empty().append(a)},onDialogClose:function(){d(b)}};return{open:function(e,a){d=a;b=!1;c=e;KindleUXComponentManager.openDialog("KindlePromptDialog",o)}}}(),KindleSigningOutDialog=
function(){var e={getDialogSettings:function(){return{autoOpen:!1,modal:!0,draggable:!1,resizable:!1,width:"450px"}}};return{show:function(){KindleUXComponentManager.openDialog("KindleSigningOutDialog",e)},hide:function(){KindleUXComponentManager.closeDialog("KindleSigningOutDialog")}}}(),KindleSpinner=function(){function e(){l||(l=new jQuery.Deferred,KindleUXComponentManager.initializeComponent(c,k));return l.promise()}function k(c){b=c;$("body").append(b);l.resolve()}function d(){var c=window.innerWidth>
1?window.innerWidth:window.outerWidth,d=parseInt(b.css("width"),10),e=window.outerHeight,a=parseInt(b.css("height"),10);b.css("top",(e-a)/2+"px").css("left",(c-d)/2+"px").show()}var c="KindleSpinner",b,l;return{overlay:function(){var b=e();$.when(b).then(function(){d()})},show:function(){var b=e();$.when(b).then(function(){d()})},hide:function(){var c=e();$.when(c).then(function(){b.hide()})}}}(),KindleUnoptimizedFormatDialog=function(){var e={TEXT_LABEL_STRING_ID:"k4w_reader_dialog_unoptimizedFormat_message",
CLOSE_BUTTON_STRING_ID:"k4w_reader_dialog_unoptimizedFormat_close",STOP_BUTTON_STRING_ID:"k4w_reader_dialog_unoptimizedFormat_stopSave",CONTINUE_BUTTON_STRING_ID:"k4w_reader_dialog_unoptimizedFormat_continue"},k={TEXT_LABEL_ID:"k4w_reader_dialog_unoptimizedFormat_message_id"},d,c,b,l=function(){KindleUXComponentManager.closeDialog("KindleUnoptimizedFormatDialog")},j=function(){c=!0;KindleUXComponentManager.closeDialog("KindleUnoptimizedFormatDialog")},o={getDialogSettings:function(){var b={};b[ResourceBundle.getLocalizedString(e.CLOSE_BUTTON_STRING_ID)]=
l;b[ResourceBundle.getLocalizedString(e.CONTINUE_BUTTON_STRING_ID)]=j;return{autoOpen:!1,modal:!0,draggable:!1,resizable:!1,buttons:b,k4w_transparent_modal_overlay:!0}},beforeDialogOpen:function(c){var a=ResourceBundle.getLocalizedString(e.TEXT_LABEL_STRING_ID);c.find("#"+k.TEXT_LABEL_ID).empty().append(a);$(c[0].parentNode).find(".ui-button-text").first().text(b)},onDialogClose:function(){d(c)}};return{open:function(f){b=ResourceBundle.getLocalizedString(e.CLOSE_BUTTON_STRING_ID);d=f;c=!1;KindleUXComponentManager.openDialog("KindleUnoptimizedFormatDialog",
o)},openPinning:function(f){b=ResourceBundle.getLocalizedString(e.STOP_BUTTON_STRING_ID);d=f;c=!1;KindleUXComponentManager.openDialog("KindleUnoptimizedFormatDialog",o)}}}(),KindleAnnotationComponentFactory=function(){function e(a,b){return a.replace(".","_")+"_"+b}function k(a,b){a.find("."+g.CONTEXT).tap(function(){b(a)})}function d(a,b){var c=function(c){return function(){var d=b[p[c]];d&&d(a)}},d;for(d in h){var e=a.find("."+h[d]);b[p[d]]||e.remove();e.tap(c(d))}}function c(a,b){b.length>q?a.find("."+
g.CONTEXT).text(b.substring(0,q)+" ..."):a.find("."+g.CONTEXT).text(b)}var b=0,l=b++,j=b++,o=b++,f=b++,a=b++,n=b++,m=b++,h={TRASH_CAN:"kindleReader_annotation_pane_notes_trashcan",EDIT:"kindleReader_annotation_pane_notes_edit",GOTO:"kindleReader_annotation_pane_notes_goto",SAVE:"kindleReader_annotation_pane_notes_save",CANCEL:"kindleReader_annotation_pane_notes_cancel",YES:"kindleReader_annotation_pane_notes_yes",NO:"kindleReader_annotation_pane_notes_no"},p={TRASH_CAN:j,EDIT:l,GOTO:o,SAVE:f,CANCEL:a,
YES:n,NO:m},g={CONTEXT:"kindleReader_annotation_pane_notes_context"},r={TEXT_AREA:"kindleReader_annotation_pane_edit_textArea"},q=430,t=function(){return KindleUserLocationConverter},s=function(){return KindleUXComponentManager},v=function(){return KindleReaderAnnotationManager},x=function(){return ResourceBundle};return{EVENT_EDIT_CLICKED:l,EVENT_DELETE_CLICKED:j,EVENT_GOTO_CLICKED:o,EVENT_SAVE_CLICKED:f,EVENT_CANCEL_CLICKED:a,EVENT_YES_CLICKED:n,EVENT_NO_CLICKED:m,MAX_NOTE_CONTEXT_LENGTH:q,initialize:function(a){var b=
t(),c=s();b.mobiLocationConverter();c.initializeTemplate("KindleAnnotationComponentFactory",a)},createAnnotationComponent:function(b,h,j,o){var p=x(),t=s(),P=v(),B,h={context:b.note||b.context,start:b.start,location:p.getLocalizedString("k4w_reader_sidebar_notes_location",[h.locationFromPosition(b.start)]),id:e(b.type,b.start),maxContextLength:q};switch(b.type){case P.BOOKMARK:h.type=p.getLocalizedString("k4w_reader_sidebar_bookmark_label");B=t.renderTemplate("KindleAnnotationComponentFactory",h);
B.find(".kindleReader_annotation_pane_icon").addClass("kindleReader_annotation_pane_icon_bookmark");o[l]=null;o[f]=null;o[a]=null;o[n]=null;o[m]=null;break;case P.HIGHLIGHT:h.type=p.getLocalizedString("k4w_reader_sidebar_note_highlight");B=t.renderTemplate("KindleAnnotationComponentFactory",h);B.find(".kindleReader_annotation_pane_icon").addClass("kindleReader_annotation_pane_icon_highlight");o[l]=null;o[f]=null;o[a]=null;o[n]=null;o[m]=null;break;case P.NOTE:h.type=p.getLocalizedString("k4w_reader_sidebar_note_label"),
B=t.renderTemplate("KindleAnnotationComponentFactory",h),B.find(".kindleReader_annotation_pane_icon").addClass("kindleReader_annotation_pane_icon_note"),KindleTouchEventsToggler.isRequired()&&(B.find("#"+r.TEXT_AREA).bind("touchstart",function(a){a.stopPropagation()},!1),B.find("#"+r.TEXT_AREA).focus(function(){KindleTouchEventsToggler.off()}),B.find("#"+r.TEXT_AREA).blur(function(){KindleTouchEventsToggler.on()}))}if(h.context){if(c(B,h.context),b.type===P.NOTE)b=B.find("."+g.CONTEXT)[0],b.innerHTML=
b.innerHTML.replace(/\n/g,"<br />")}else B.find("."+g.CONTEXT).remove();k(B,j);d(B,o);return B},setAnnotationContext:c,getAnnotationID:e,setUserLocationConverter:function(a){t=a},setUXComponentManager:function(a){s=a},setAnnotationManager:function(a){v=a},setResourceBundle:function(a){x=a}}}(),KindleNotificationDialog=function(){function e(c){var d=$("<span></span>").addClass(b.TITLE_TEXT_CLASS).text(ResourceBundle.getLocalizedString(l.TITLE_TEXT_ID)),e=$("<span></span>").addClass(b.PRETITLE_TEXT_CLASS).text(ResourceBundle.getLocalizedString(l.PRETITLE_TEXT_ID)),
f=$("<div></div>").addClass(b.BODY_CLASS).text(ResourceBundle.getLocalizedString(l.BODY_ID));c.find("."+b.CONTAINER).append(e);c.find("."+b.CONTAINER).append(d);c.find("."+b.CONTAINER).append(f);d=$("<canvas id='kindleNotificationArrow' width='32' height='32'></canvas>");e=d[0].getContext("2d");e.beginPath();e.moveTo(0,24);e.lineTo(32,24);e.lineTo(16,0);e.closePath();e.fillStyle="#eee";e.fill();e.beginPath();e.moveTo(0,24);e.lineTo(16,0);e.lineTo(32,24);e.strokeStyle="rgba(32,32,32,0.8)";e.stroke();
d.css("top","-24px");d.css("left","50%");d.css("margin-left","-16px");d.css("position","absolute");c.prepend(d);a.resolve(c)}function k(a){function b(){h=!0;$(document).unbind("touchstart mousedown",b);m&&p.increment();a.removeClass(c)}$(document).bind("touchstart mousedown",b);setTimeout(b,o);setTimeout(function(){a.remove()},f)}function d(a){k(a);$("body").append(a);var b=a.outerWidth(),d=$(g.targetElement),b=d&&d.offset().left-b/2;b+=d.outerWidth()/2;b-=2;a.css("left",b+"px");setTimeout(function(){h||
(m=!0,a.addClass(c))},j)}var c="shown",b={BODY_CLASS:"notificationBodyText",TITLE_TEXT_CLASS:"notificationTitleText",CONTAINER:"notificationContainer",PRETITLE_TEXT_CLASS:"notificationPreTitleText"},l={BODY_ID:"k4w_notification_body_text",TITLE_TEXT_ID:"k4w_notification_title_text",PRETITLE_TEXT_ID:"k4w_notification_preTitle_text"},j=1E3,o=2E4,f=3E4,a,n=!1,m=!1,h=!1,p,g={};return{showIfAppropriate:function(b){p=p||LocalStorageCounter("kcrNotifications.0000");a=a||new jQuery.Deferred;if(b)for(var c in b)b.hasOwnProperty(c)&&
(g[c]=b[c]);n||(n=!0,KindleUXComponentManager.initializeComponent("KindleNotificationDialog",e));b=p.getValue()===0;c=g.bookIsOwned;b&&c&&a.done(d)}}}(),KindleReaderAnnotationsPane=function(){function e(){G=C;C=Math.max(G-x,0);d();n("bottom")}function k(){C=G;G=Math.min(C+x,z.length);d();n(0)}function d(){var d=a();d.empty();I.remove();H.add(F).remove();for(var e=C;e<G;++e)b(z[e]).appendTo(d);c();o()}function c(){var b=a();C>0&&H.unbind("click.goPrev").bind("click.goPrev",e).add(F).prependTo(b);G<
z.length&&I.unbind("click.goNext").bind("click.goNext",k).appendTo(b)}function b(d){function e(a){var g;jQuery.each(z,function(a,b){b.start===d.start&&b.end===d.end&&b.type===d.type&&(g=a)});a.remove();g!==-1&&(g<C||G<=g?z.splice(g,1):(z.splice(g,1),a=G-1,a<z.length&&z.length>0&&(I.remove(),H.add(F).remove(),b(z[a]).appendTo(f),c())));z.length===0&&B.find("#"+s.EMPTY_MESSAGE).show();o()}var f=a(),h=K(),k={};k[h.EVENT_DELETE_CLICKED]=function(a){d.type===KindleReaderAnnotationManager.NOTE?(a.find("."+
v.DELETE_ICON).hide(),a.find("."+v.EDIT_ICON).hide(),a.find("."+v.GOTO_ICON).hide(),a.find("."+v.CANCEL_BTN).hide(),a.find("."+v.SAVE_BTN).hide(),a.find("."+v.CONFIRMATION).show(),a.find("."+v.YES_BTN).show(),a.find("."+v.NO_BTN).show()):(e(a),X(d))};k[h.EVENT_EDIT_CLICKED]=function(a){a.find("."+v.CONTEXT).hide();a.find("."+v.EDIT_ICON).hide();a.find("."+v.GOTO_ICON).hide();a.find("."+v.DELETE_ICON).hide();a.find("#"+s.EDIT_NOTE).show();a.find("."+v.CANCEL_BTN).show();a.find("."+v.SAVE_BTN).show();
y().isiOS()||a.find("#"+s.EDIT_NOTE).focus();j()};k[h.EVENT_GOTO_CLICKED]=function(){m();P(d)};k[h.EVENT_SAVE_CLICKED]=function(a){var b=a.find("#"+s.EDIT_NOTE).val().trim();if(b){var c=a.find("."+v.CONTEXT);c.empty();KindleAnnotationComponentFactory.setAnnotationContext(a,b);c=c[0];c.innerHTML=c.innerHTML.replace(/\n/g,"<br />");g(a)}else e(a);T(b,d)};k[h.EVENT_CANCEL_CLICKED]=function(a){a.find("#"+s.EDIT_NOTE).val(d.note);g(a)};k[h.EVENT_NO_CLICKED]=function(a){a.find("."+v.DELETE_ICON).show();
a.find("."+v.EDIT_ICON).show();a.find("."+v.GOTO_ICON).show();a.find("."+v.CONFIRMATION).hide();a.find("."+v.YES_BTN).hide();a.find("."+v.NO_BTN).hide()};k[h.EVENT_YES_CLICKED]=function(a){e(a);X(d)};return h.createAnnotationComponent(d,_locationConverter,function(b){var c=d;if(A){var e=KindleAnnotationComponentFactory.getAnnotationID(A.type,A.start),e=a().find("#"+e);KindleAnnotationComponentFactory.setAnnotationContext(e,A.note||A.context)}A=c;c=c.note||c.context;b.find("."+v.CONTEXT).text(c);b=
b.find("."+v.CONTEXT)[0];b.innerHTML=b.innerHTML.replace(/\n/g,"<br />");j()},k)}function l(a){a.stopPropagation()}function j(){if(y().isiOS())u?u.refresh():u=new iScroll(s.SCROLL_WRAPPER,{vScrollbar:!1});else{var a=f();a.jScrollPane({showArrows:!0,verticalGutter:10});a.removeAttr("tabindex");$(".jspContainer").keypress(l).keyup(l).keydown(l)}}function o(){var a=f(),b=B.height(),c=B.width();y().isiOS()?B.find("#"+s.SCROLL_WRAPPER).height(b):(a.height(b-6),a.width(c));$(a).animate({opacity:1},100);
j()}function f(){return B.find("#"+s.CONTAINER)}function a(){return y().isiOS()?f():f().data("jsp").getContentPane()}function n(a){if(y().isiOS())a==="bottom"&&(a=-9999),u.scrollTo(0,a);else{var b=f().data("jsp");a==="bottom"?b.scrollToBottom():b.scrollToY(0)}}function m(){r();KindleUXComponentManager.closeDialog(q)}function h(a){A=null;B=a;var b;$(window).resize(function(){clearTimeout(b);b=setTimeout(o,50)});y().isiOS()||(f().jScrollPane({showArrows:!0,verticalGutter:10}),$(".jspContainer").keypress(l).keyup(l).keydown(l));
f().hover(function(){document.onmousewheel=function(){return!0}},function(){document.onmousewheel=function(){return!1}})}function p(a){var b=z.length;if(z.length===0)return-1;for(var c=0;c<b;c++)if(z[c].end>=a||z[c].start>=a)break;return c}function g(a){a.find("."+v.CONTEXT).show();a.find("."+v.EDIT_ICON).show();a.find("."+v.GOTO_ICON).show();a.find("."+v.DELETE_ICON).show();a.find("#"+s.EDIT_NOTE).hide();a.find("."+v.CANCEL_BTN).hide();a.find("."+v.SAVE_BTN).hide();j()}function r(){z=A=null;G=C=
0;a().empty();j()}var q="KindleReaderAnnotationsPane",t={CLOSE_BUTTON_STRING_ID:"k4w_common_close_button",CLICK_FOR_PREVIOUS:"k4w_reader_annotation_pane_previous",CLICK_FOR_NEXT:"k4w_reader_annotation_pane_next"},s={PANE:"kindleReader_annotations_pane",HEADER:"kindleReader_annotations_pane_header",CONTAINER:"kindleReader_annotations_pane_container",SCROLL_WRAPPER:"kindleReader_annotations_pane_scrollWrapper",EMPTY_MESSAGE:"kindleReader_annotations_pane_notes_empty",EDIT_NOTE:"kindleReader_annotation_pane_edit_textArea"},
v={SELECTED:"kindleReader_annotation_pane_notes_selected",CONTEXT:"kindleReader_annotation_pane_notes_context",EDIT_ICON:"kindleReader_annotation_pane_notes_edit",GOTO_ICON:"kindleReader_annotation_pane_notes_goto",CANCEL_BTN:"kindleReader_annotation_pane_notes_cancel",SAVE_BTN:"kindleReader_annotation_pane_notes_save",YES_BTN:"kindleReader_annotation_pane_notes_yes",NO_BTN:"kindleReader_annotation_pane_notes_no",CONFIRMATION:"kindleReader_annotation_notes_delete_confirm",DELETE_ICON:"kindleReader_annotation_pane_notes_trashcan"},
x=100,O=1/3,z=[],C,G,X,T,P,B,H,F,I,u,A,K=function(){return KindleAnnotationComponentFactory},y=function(){return KindleHostDeviceDetector},R={getDialogSettings:function(){var a={};a[ResourceBundle.getLocalizedString(t.CLOSE_BUTTON_STRING_ID)]=m;var b={};return b={autoOpen:!1,width:"90%",height:y().isiOS()?$("body",top.document).height()-80:window.outerHeight-150,modal:!0,draggable:!1,resizable:!1,buttons:a}},onInitializationDone:h,onDialogOpen:function(){KindleReaderMetrics.reportAnnotationsPaneOpened();
y().isiOS()&&($("#kindleReader_annotations_pane").height($("body",top.document).height()-212),$("#kindleReader_annotations_pane_scrollWrapper").height($("body",top.document).height()-212))}};return{open:function(){K().initialize(function(){KindleUXComponentManager.openDialog(q,R)})},scrollToPosition:function(a){a=Math.min(p(a),z.length-1);$("#"+s.PANE).offset();B.parent().height();if(a!==-1){C<=a&&a<G||(G=Math.min(Math.max(a-Math.floor(O*x),0)+x,z.length),C=Math.max(0,G-x),d());var b=z[a],a=0,b=KindleAnnotationComponentFactory.getAnnotationID(b.type,
b.start),c=B.find("#"+b),a=a||0;y().isiOS()?u.scrollToElement("#"+b,a):f().data("jsp").scrollToElement(c,!0,!!a)}},loadAnnotations:function(b,c,e,f,g){b.length===0?(r(),B.find("#"+s.EMPTY_MESSAGE).show()):(B.find("#"+s.EMPTY_MESSAGE).hide(),P=e,X=f,T=g,a(),z=b.slice(),_locationConverter=c,A=null,H=$("<div/>",{"class":"kindleReader_annotation_pane_notes_prev",text:ResourceBundle.getLocalizedString(t.CLICK_FOR_PREVIOUS)}),F=$("<div/>",{"class":"kindleReader_annotation_pane_notes_divider_top"}),F=F.add($("<div/>",
{"class":"kindleReader_annotation_pane_notes_divider_bottom"})),I=$("<div/>",{"class":"kindleReader_annotation_pane_notes_next",text:ResourceBundle.getLocalizedString(t.CLICK_FOR_NEXT)}),C=0,G=Math.min(x,z.length),d())},setUXComponentManager:function(){},setAnnotationComponentFactory:function(a){K=a},setHostDeviceDetector:function(a){y=a},onInitializationDone:h}}(),KindleReaderBookmarkOverlay=function(){function e(e){d=e;d.tap(function(){b()});k();c(e)}function k(){l?d.addClass("preBookmark").addClass("hasBookmark").fadeIn(250):
d.removeClass("hasBookmark").removeClass("preBookmark")}var d,c,b,l;return{initialize:function(d,k){c=d;b=k;KindleUXComponentManager.initializeComponent("KindleReaderBookmarkOverlay",e)},setIsBookmarked:function(b){l=b;d&&k()},setImmersiveMode:function(b){b?d.addClass("immersiveBookmark"):d.removeClass("immersiveBookmark")}}}(),KindleReaderContextMenu=function(){function e(){KindleUXComponentManager.isVisible(k)&&($(".ui-widget-overlay").show(),KindleUXComponentManager.closeDialog(k))}var k="KindleReaderContextMenu",
d="kindle_menu_button",c="button_enabled",b={};b[KindlePopupMenu.ITEM_ENABLED]=c;b[KindlePopupMenu.ITEM_DISABLED]="button_disabled";b[KindlePopupMenu.ITEM_HIDDEN]="button_hidden";var l=["k4w_reader_context_createHighlight","k4w_reader_context_deleteHighlight","k4w_reader_context_createNote","k4w_reader_context_editNote"],j=0,o=j++,f=j++,a=j++,j=j++,n,m,h,p={onInitializationDone:function(a){function b(a){var f=ResourceBundle.getLocalizedString(l[a]),g=$("<div></div>").addClass(d).addClass(c).text(f);
g.tap(function(){g.hasClass(c)&&(e(),h[a]())});return g}a=a.find("#kindle_menu_border");a.append(b(0));for(var f=1;f<l.length;f++)a.append($("<div></div>").addClass("kindle_menu_separator")),a.append(b(f))},beforeDialogOpen:function(a){var c=a.find("#kindle_menu_border"),f,h,j;c.find("."+d).each(function(a){var c=$(this);c.removeClass().addClass(d);c.addClass(b[n[a]])});c.children().each(function(){var a=$(this);a.hasClass(d)?a.hasClass("button_hidden")||(f||(f=a),h=a,j=null):a.hasClass("kindle_menu_separator")&&
(!f||j?a.hide():(a.show(),j=a))});f.addClass("ui-corner-left");h.addClass("ui-corner-right");j&&j.hide();a.dialog("option","position",m);$(window).bind("resize",e)},getDialogSettings:function(){return{autoOpen:!1,draggable:!1,modal:!0,resizable:!1,minHeight:0,width:"auto",dialogClass:"kindle_menu",k4w_transparent_modal_overlay:!0}},onDialogClose:function(){$(window).unbind("resize",e)}};return{CREATE_HIGHLIGHT:o,CREATE_NOTE:a,EDIT_NOTE:j,DELETE_HIGHLIGHT:f,show:function(a,b,c){n=a;m=b;h=c;KindleUXComponentManager.openDialog(k,
p);$(".ui-widget-overlay").hide()},hide:e}}(),KindleReaderEditNoteDialog=function(){function e(){return f.find("#kindleReader_dialog_editNote_title")}function k(){return f.find("#kindleReader_dialog_editNote_noteText")}function d(){j();n&&n(a)}function c(){j();m&&m()}function b(){j();h&&h()}function l(){k().val(a);var b;b=ResourceBundle.getLocalizedString("k4w_reader_dialog_editNote_delete");b=f.dialog("widget").find('.ui-button:contains("'+b+'")');m?(e().text(ResourceBundle.getLocalizedString("k4w_reader_dialog_editNote_title_edit")),
b.show()):(e().text(ResourceBundle.getLocalizedString("k4w_reader_dialog_editNote_title_create")),b.hide())}function j(){KindleUXComponentManager.closeDialog(o)}var o="KindleReaderEditNoteDialog",f,a,n,m,h,p,g={getDialogSettings:function(){var a={};a[ResourceBundle.getLocalizedString("k4w_reader_dialog_editNote_cancel")]=b;a[ResourceBundle.getLocalizedString("k4w_reader_dialog_editNote_delete")]=c;a[ResourceBundle.getLocalizedString("k4w_reader_dialog_editNote_save")]=d;p=KindleHostDeviceDetector.isiOS()?
"70%":"40%";return{width:p,autoOpen:!1,buttons:a,draggable:!1,modal:!0,resizable:!1,k4w_transparent_modal_overlay:!0}},beforeDialogOpen:l,onDialogOpen:function(){KindleHostDeviceDetector.isiOS()||k().focus()},onDialogClose:function(){a=$.trim(k().val())},onInitializationDone:function(a){f=a;KindleTouchEventsToggler.isRequired()&&(k().focus(function(){KindleTouchEventsToggler.off()}),k().blur(function(){KindleTouchEventsToggler.on()}));l()}};return{open:function(b,c,d,e){a=b||"";n=c;m=d;h=e;KindleUXComponentManager.openDialog(o,
g)},close:j,isVisible:function(){return KindleUXComponentManager.isVisible(o)}}}(),KindleReaderGoToDialog=function(){function e(a){var b;/(^[0]*\d*$)/.exec(a)&&(b=parseInt(a,10));isNaN(b)&&(b=void 0);return b}var k={DIALOG_TITLE_ID:"k4w_reader_goto_menu_goto_location_title",DIALOG_TEXT_ID:"k4w_reader_goto_menu_goto_message",DIALOG_LOCATION_TEXT_ID:"k4w_reader_goto_menu_goto_location",DIALOG_OK_BTN_ID:"k4w_reader_goto_menu_goto_button",DIALOG_CANCEL_BTN_ID:"k4w_common_cancel_button"},d={TITLE_LABEL_ID:"kindleReader_dialog_gotoTitle",
TEXT_LABEL_ID:"kindleReader_dialog_gotoLabel",LOCATION_LABEL_ID:"kindleReader_dialog_gotoLocation",INPUT_FIELD_ID:"kindleReader_dialog_gotoField",OK_BUTTON_ID:"kindleReader_dialog_gotoGoButton",CANCEL_BUTTON_ID:"kindleReader_dialog_gotoCancelButton"},c,b,l,j,o,f=function(){var a=e(o.find("#"+d.INPUT_FIELD_ID).val());a===void 0||a<b.minLocation||a>b.maxLocation?(o.find("#"+d.INPUT_FIELD_ID).css("background-color","#ff0000"),o.find("#"+d.INPUT_FIELD_ID).val(""),KindleHostDeviceDetector.isiOS()||o.find("#"+
d.INPUT_FIELD_ID).focus(),setTimeout(function(){$("#kindleReader_dialog_gotoField").css("background-color","#ffffff")},2E3)):(l=!0,j=a,KindleUXComponentManager.closeDialog("KindleReaderGoToDialog"))},a=function(){KindleUXComponentManager.closeDialog("KindleReaderGoToDialog")},n=function(a){a.which===13&&f()},m={onInitializationDone:function(a){o=a;KindleTouchEventsToggler.isRequired()&&(o.find("#"+d.INPUT_FIELD_ID).focus(function(){KindleTouchEventsToggler.off()}),o.find("#"+d.INPUT_FIELD_ID).blur(function(){KindleTouchEventsToggler.on()}))},
getDialogSettings:function(){var b={};b[ResourceBundle.getLocalizedString(k.DIALOG_CANCEL_BTN_ID)]=a;b[ResourceBundle.getLocalizedString(k.DIALOG_OK_BTN_ID)]=f;return{autoOpen:!1,modal:!0,draggable:!1,resizable:!1,buttons:b,k4w_transparent_modal_overlay:!0}},beforeDialogOpen:function(){var a=ResourceBundle.getLocalizedString(k.DIALOG_TITLE_ID);o.find("#"+d.TITLE_LABEL_ID).empty().append(a);a=ResourceBundle.getLocalizedString(k.DIALOG_TEXT_ID);o.find("#"+d.TEXT_LABEL_ID).empty().append(a);a=ResourceBundle.getLocalizedString(k.DIALOG_LOCATION_TEXT_ID,
[b.minLocation,b.maxLocation]);o.find("#"+d.LOCATION_LABEL_ID).empty().append(a);o.find("#"+d.INPUT_FIELD_ID).val("");o.find("#"+d.INPUT_FIELD_ID).bind("keyup",n)},onDialogOpen:function(){KindleHostDeviceDetector.isiOS()||o.find("#"+d.INPUT_FIELD_ID).focus()},onDialogClose:function(){o.find("#"+d.INPUT_FIELD_ID).blur();o.find("#"+d.INPUT_FIELD_ID).unbind("keyup",n);c(l,j)}};return{open:function(a,d){c=d;b=a;l=!1;j=-1;KindleUXComponentManager.openDialog("KindleReaderGoToDialog",m)},parseLocationString:e}}(),
KindleReaderGoToMenu=function(){function e(){f();var a={minLocation:1,maxLocation:h.getMaxUserLocation()};KindleReaderGoToDialog.open(a,k)}function k(a,b){a&&h.gotoUserLocation(b)}function d(){h.gotoPosition(m.cover);f()}function c(){h.gotoPosition(m.toc);f()}function b(){h.gotoPosition(m.srp);f()}function l(){h.openBookExtras();f()}function j(){var a={};a[ResourceBundle.getLocalizedString(n.GOTO_COVER_ID)]=d;a[ResourceBundle.getLocalizedString(n.GOTO_TOC_ID)]=c;a[ResourceBundle.getLocalizedString(n.GOTO_SRP_ID)]=
b;a[ResourceBundle.getLocalizedString(n.GOTO_LOCATION_ID)]=e;a[ResourceBundle.getLocalizedString(n.BEX_ID)]=l;return a}function o(b){var c=KindlePopupMenu.ITEM_ENABLED,d=KindlePopupMenu.ITEM_DISABLED;p=[c,d,d,c,KindlePopupMenu.ITEM_HIDDEN];m.cover=0;if(b!==void 0){if(b.cover!==void 0&&b.cover>=0)m.cover=b.cover;if(b.toc!==void 0&&b.toc>=0)m.toc=b.toc,p[1]=c;m.srp=b.srl!==void 0&&b.srl>=0?b.srl:m.cover;p[2]=c}KindleUXComponentManager.updateMenu(a,p)}function f(){KindleUXComponentManager.hideMenu(a)}
var a="KindleReaderGotoMenu",n={GOTO_COVER_ID:"k4w_reader_cover_title",GOTO_TOC_ID:"k4w_reader_table_of_contents_title",GOTO_SRP_ID:"k4w_reader_beginning_title",GOTO_LOCATION_ID:"k4w_reader_goto_location_title",BEX_ID:"k4w_reader_book_extras_title"},m={},h,p;return{show:function(){p&&KindleUXComponentManager.showMenu(a,"kindleReader_button_goto",j(),"down",p)},hide:f,bookIsReady:function(a,b){h=a;b.getBookPositions().done(o)},disable:function(){p=void 0},updateGoToMenu:function(b){for(var c in b)p[c]=
b[c];KindleUXComponentManager.updateMenu(a,p)},extractPositionsFromMetadata:o,interestingPositions:m}}(),KindleReaderHeaderBar=function(){function e(a){return function(){if(g[a]&&t[a])t[a]()}}function k(a){s=a;KindleHostDeviceDetector.isiOS()&&(a.find("#"+p[b]).remove(),a.find("#"+p[h]).remove());var c,f;for(f in p)c=a.find("#"+p[f]),c.tap(e(f)),g[f]||c.addClass(r);v&&(s.find("#"+p[l]).html(v),d(l,!0));q(a)}function d(a,b){g[a]=b;var c;s&&(c=s.find("#"+p[a]),b?c.removeClass(r):c.addClass(r))}var c=
0,b=c++,l=c++,j=c++,o=c++,f=c++,a=c++,n=c++,m=c++,h=c++,p={};p[b]="kindleReader_kindleLogo";p[l]="kindleReader_button_close";p[j]="kindleReader_button_goto";p[o]="kindleReader_button_controlPanel";p[f]="kindleReader_bookmark";p[a]="kindleReader_button_sync";p[n]="kindleReader_button_note";p[m]="kindleReader_button_back";p[h]="kindleReader_button_enter_immersive";var g={},r="disabled",q,t,s,v;return{BUTTON_LOGO:b,BUTTON_CLOSE:l,BUTTON_GOTO:j,BUTTON_CONTROL_PANEL:o,BUTTON_BOOKMARK:f,BUTTON_SYNC:a,BUTTON_NOTE:n,
BUTTON_BACK:m,BUTTON_IMMERSIVE:h,initialize:function(a,b){q=a;t=b;g[h]=!0;KindleUXComponentManager.initializeComponent("KindleReaderHeaderBar",k)},setButtonEnabled:d,setCloseButtonEnabled:function(a){s?(s.find("#"+p[l]).html(a).attr("title",a),d(l,!0)):v=a}}}(),KindleReaderImmersiveModeExit=function(){function e(b){k=b;k.tap(function(){c()});d(b)}var k,d,c;return{initialize:function(b,k){d=b;c=k;KindleUXComponentManager.initializeComponent("KindleReaderImmersiveModeExit",e)}}}(),KindleReaderLocationBar=
function(){function e(a){var b=x.find("#"+q.PROGRESS_BAR_ID),c=x.find("#"+q.POPUP_LABEL_ID),a=(a-O)/(z-O)*b.width(),a=a<0?0:a,d=c.outerWidth(),e=$(window).width(),b=(e-b.width())/2;c.css("left",(d/2+5>b+a?5-b:e-b-a<d/2+5?e-b-d-5:a-d/2)+"px")}function k(a,c){G=!0;b(c.value);e(c.value)}function d(a,b){G=!1;z>0&&v(b.value)}function c(){x&&z>0&&O>=0&&x.find("#"+q.PROGRESS_BAR_ID).slider("option","min",O).slider("option","max",z).slider("option","disabled",!1)}function b(a){var b=ResourceBundle.getLocalizedString("k4w_reader_slider_location_popup",
[a,z]);x.find("#"+q.POPUP_LABEL_ID).text(b);a=ResourceBundle.getLocalizedString("k4w_reader_slider_percentage",[Math.round(a/z*100)])+" \u00b7 "+ResourceBundle.getLocalizedString("k4w_reader_slider_location",[a,z]);B.text(a)}function l(){if(x&&C>=0){var a=C;x.find("#"+q.PROGRESS_BAR_ID).slider("option","value",a);b(C)}}function j(a){G||a<0?clearTimeout(T):T=setTimeout(function(){h()},a)}function o(a){G||a<0?clearTimeout(X):X=setTimeout(function(){h();x.find("."+t.RANGE).removeClass("hover");x.find(".kindleReader_footer_fading").fadeOut(100)},
a)}function f(){P?x.find("#"+q.PROGRESS_BAR_ID).addClass("black"):x.find("#"+q.PROGRESS_BAR_ID).removeClass("black")}function a(a){var a=a.originalEvent,b=a.changedTouches[0],c="";switch(a.type){case "touchstart":c="mousedown";break;case "touchmove":c="mousemove";break;case "touchend":c="mouseup";break;default:return}var d=document.createEvent("MouseEvent");d.initMouseEvent(c,!0,!0,window,1,b.screenX,b.screenY,b.clientX,b.clientY,!1,!1,!1,!1,0,null);b.target.dispatchEvent(d);a.preventDefault()}function n(b){x=
b;B=x.find("#"+q.MESSAGE_LABEL_ID);H=x.find("#"+q.DOWNLOAD_PROGRESS_ID);F=x.find("#"+q.DOWNLOAD_PROGRESS_MESSAGE_ID);var e=b.find("#"+q.PROGRESS_BAR_ID);e.slider({range:"min",value:1,max:100,min:1,step:1,animate:!0,disabled:!0,slide:k,stop:d});e.find("."+t.RANGE).addClass("ui-corner-left");e.find("."+t.HANDLE).removeAttr("href");p();f();c();l();KindleHostDeviceDetector.isiPad()&&(x.bind("touchstart",a,!0),x.bind("touchmove",a,!0),x.bind("touchend",a,!0),x.bind("touchmove",m,!0),x.bind("touchend",
h,!0),x.bind("touchcancel",h,!0));s(b)}function m(){var a=x.find("#"+q.PROGRESS_BAR_ID),b=x.find("#"+q.POPUP_ID);z>0&&(b.show(),e(a.slider("option","value")))}function h(){x&&x.find("#"+q.POPUP_ID).hide()}function p(){if(!KindleHostDeviceDetector.isiOS()){var a=x.find("#"+q.PROGRESS_BAR_ID),b=a.find("."+t.HANDLE);b.hover(function(){z>0&&(j(-1),m())},function(){j(500)});b.addClass("kindleReader_footer_fading");x.hover(function(){z>0&&(o(-1),a.find("."+t.RANGE).addClass("hover"),x.find(".kindleReader_footer_fading").show(),
A&&r())},function(){x.mouseup();o(2E3)});o(2E3)}}function g(a){function b(){x.removeClass("downloading").addClass("download_completed")}a>0&&(a=ResourceBundle.getLocalizedString("k4w_reader_downloaded",[100]),H.addClass("finished"),F.text(a));(KindleHostDeviceDetector.isiOS()?!K:F.is(":visible"))?b():A=b}function r(){setTimeout(function(){A&&(A(),A=null)},1E3)}var q={PROGRESS_BAR_ID:"kindleReader_progressbar_div",MESSAGE_LABEL_ID:"kindleReader_footer_message",POPUP_ID:"kindleReader_locationPopup_div",
POPUP_LABEL_ID:"kindleReader_locationPopup_labelDiv",DOWNLOAD_PROGRESS_ID:"kindleReader_download_progress",DOWNLOAD_PROGRESS_MESSAGE_ID:"kindleReader_download_progress_message"},t={HANDLE:"ui-slider-handle",RANGE:"ui-slider-range"},s,v,x,O=-1,z=-1,C=-1,G=!1,X,T,P,B,H,F,I={IN_PROGRESS:"in_progress",COMPLETED:"completed",DISK_ERROR:"disk_error",NETWORK_ERROR:"network_error"},u=-1,A,K=!1;return{DOWNLOAD_COMPLETED:I.COMPLETED,DOWNLOAD_IN_PROGRESS:I.IN_PROGRESS,DOWNLOAD_DISK_ERROR:I.DISK_ERROR,DOWNLOAD_NETWORK_ERROR:I.NETWORK_ERROR,
initialize:function(a,b){s=a;v=b;KindleUXComponentManager.initializeComponent("KindleReaderLocationBar",n)},setMinMaxLocation:function(a,b){z=b;O=a;c()},updateLocation:function(a){C=a;l()},setLocationBarBlack:function(a){P=a;x&&f()},hidePopup:h,updateDownloadProgress:function(a,b){B.is(":visible")||H.hide();switch(a){case I.COMPLETED:g(u);break;case I.IN_PROGRESS:u=b;if(x&&b>=0&&b<=100){var c=ResourceBundle.getLocalizedString("k4w_reader_downloading",[b]);x.addClass("downloading");F.text(c)}break;
case I.DISK_ERROR:case I.NETWORK_ERROR:c=u>0?u+"% ":"",x.removeClass("downloading").addClass("download_error"),c=a===I.DISK_ERROR?ResourceBundle.getLocalizedString("k4w_reader_download_disk_error",[c]):ResourceBundle.getLocalizedString("k4w_reader_download_network_error",[c]),F.text(c)}},setImmersiveMode:function(a){K=a;!K&&A&&r()}}}(),KindleReaderMouseLayer=function(){return{initialize:function(e){KindleUXComponentManager.initializeComponent("KindleReaderTouchLayer",e)}}}(),KindleReaderPageArrow=
function(){function e(a){f=a;f.find("#"+c.LEFT_AREA_ID).click(l);f.find("#"+c.RIGHT_AREA_ID).click(j);o(f);k();d()}function k(){a?f.find("#"+c.LEFT_AREA_ID).addClass("pageArrow"):f.find("#"+c.LEFT_AREA_ID).removeClass("pageArrow");n?f.find("#"+c.RIGHT_AREA_ID).addClass("pageArrow"):f.find("#"+c.RIGHT_AREA_ID).removeClass("pageArrow")}function d(){switch(m){case KINDLE_READER_SETTINGS_COLOR_MODE.WHITE:f.find("."+b).removeClass("black");f.find("."+b).removeClass("sepia");break;case KINDLE_READER_SETTINGS_COLOR_MODE.BLACK:f.find("."+
b).removeClass("sepia");f.find("."+b).addClass("black");break;case KINDLE_READER_SETTINGS_COLOR_MODE.SEPIA:f.find("."+b).removeClass("black"),f.find("."+b).addClass("sepia")}}var c={LEFT_AREA_ID:"kindleReader_pageTurnAreaLeft",RIGHT_AREA_ID:"kindleReader_pageTurnAreaRight"},b="kindleReader_pageTurnArea",l,j,o,f,a,n,m;return{initialize:function(a,b,c){o=a;l=b;j=c;KindleUXComponentManager.initializeComponent("KindleReaderPageArrow",e)},setArrowEnabled:function(b,c){a=b;n=c;f&&k()},setArrowColor:function(a){m=
a;f&&d()}}}(),KindleReaderSampleEnd=function(){var e={TITLE_LABEL_STRING_ID:"k4w_endOfSample_Title",TEXT_LABEL_STRING_ID:"k4w_endOfSample_Text",BUY_BUTTON_STRING_ID:"k4w_endOfSample_buy_button",CANCEL_BUTTON_STRING_ID:"k4w_endOfSample_cancel_button"},k={TITLE_LABEL_ID:"kindle_sample_end_title_text",TEXT_LABEL_ID:"kindle_sample_end_message_text"},d,c,b=function(){c="buy";KindleUXComponentManager.closeDialog("KindleReaderSampleEnd")},l=function(){c="cancel";KindleUXComponentManager.closeDialog("KindleReaderSampleEnd")},
j={getDialogSettings:function(){var c={};c[ResourceBundle.getLocalizedString(e.CANCEL_BUTTON_STRING_ID)]=l;c[ResourceBundle.getLocalizedString(e.BUY_BUTTON_STRING_ID)]=b;return{autoOpen:!1,modal:!0,draggable:!1,resizable:!1,buttons:c,k4w_transparent_modal_overlay:!1}},beforeDialogOpen:function(b){var c=ResourceBundle.getLocalizedString(e.TITLE_LABEL_STRING_ID),a=ResourceBundle.getLocalizedString(e.TEXT_LABEL_STRING_ID);b.find("#"+k.TITLE_LABEL_ID).empty().append(c);b.find("#"+k.TEXT_LABEL_ID).empty().append(a)},
onDialogClose:function(){d(c)}};return{open:function(b){d=b;c=!1;KindleUXComponentManager.openDialog("KindleReaderSampleEnd",j)}}}(),KindleReaderSettingsDialog=function(){function e(){var b=g.find(q.FONT_SIZE_PANEL_ID).buttonset(),c=function(b){return function(){var c=KINDLE_READER_SETTINGS_FONT_SIZE[b].size;m.getFontSize()!==c&&(m.setFontSize(c),a(),k(),h=!0)}},d;for(d in KINDLE_READER_SETTINGS_FONT_SIZE)b.find(KINDLE_READER_SETTINGS_FONT_SIZE[d].id).tap(c(d))}function k(){var a=m.getFontSize(),
b;for(b in KINDLE_READER_SETTINGS_FONT_SIZE)a===KINDLE_READER_SETTINGS_FONT_SIZE[b].size?g.find(KINDLE_READER_SETTINGS_FONT_SIZE[b].id+"Selected").css("visibility","visible"):g.find(KINDLE_READER_SETTINGS_FONT_SIZE[b].id+"Selected").css("visibility","hidden")}function d(){var a=g.find(q.MARGIN_PANEL_ID).buttonset(),b=function(a){return function(){var b=KINDLE_READER_SETTINGS_MARGIN[a].size;m.getMargin()!==b&&(m.setMargin(b),c(),h=!0)}},d;for(d in KINDLE_READER_SETTINGS_MARGIN)a.find(KINDLE_READER_SETTINGS_MARGIN[d].id).tap(b(d))}
function c(){var a=m.getMargin(),b;for(b in KINDLE_READER_SETTINGS_MARGIN)a===KINDLE_READER_SETTINGS_MARGIN[b].size?g.find(KINDLE_READER_SETTINGS_MARGIN[b].id+"Selected").css("visibility","visible"):g.find(KINDLE_READER_SETTINGS_MARGIN[b].id+"Selected").css("visibility","hidden")}function b(){var a=g.find(q.PAGE_MODE_ID).buttonset(),b=function(){return function(){KindleMessageDialog.open(ResourceBundle.getLocalizedString("k4w_library_unimplementedFeature_Error_Title"),ResourceBundle.getLocalizedString("k4w_library_unimplementedFeature_Error_Text"))}},
c;for(c in KINDLE_READER_SETTINGS_PAGE_MODE)a.find(KINDLE_READER_SETTINGS_PAGE_MODE[c].id).click(b(c))}function l(){var b=g.find(q.COLOR_MODE_PANEL_ID).buttonset(),c=function(b){return function(){var c=KINDLE_READER_SETTINGS_COLOR_MODE[b];m.getColorMode()!==c&&(m.setColorMode(c),a(),j(),h=!0)}},d;for(d in KINDLE_READER_SETTINGS_COLOR_MODE)b.find(KINDLE_READER_SETTINGS_COLOR_MODE[d].id).tap(c(d))}function j(){var a=m.getColorMode(),b;for(b in KINDLE_READER_SETTINGS_COLOR_MODE)a===KINDLE_READER_SETTINGS_COLOR_MODE[b]?
g.find(KINDLE_READER_SETTINGS_COLOR_MODE[b].id+"Selected").css("visibility","visible"):g.find(KINDLE_READER_SETTINGS_COLOR_MODE[b].id+"Selected").css("visibility","hidden");g.find(":not("+a.id+")").removeClass("selected");g.find(a.id).addClass("selected")}function o(){p=!0;KindleUXComponentManager.closeDialog(n)}function f(){KindleUXComponentManager.closeDialog(n)}function a(){var a=g.find(q.PREVIEW_ID);m.getColorMode()===KINDLE_READER_SETTINGS_COLOR_MODE.BLACK?a.css({"box-shadow":"inset 0 0 10px #444444",
"-moz-box-shadow":"inset 0 0 10px #444444","-webkit-box-shadow":"inset 0 0 10px #444444","border-color":"#AAAAAA"}):a.css({"box-shadow":"inset 0 0 10px #666666","-moz-box-shadow":"inset 0 0 10px #666666","-webkit-box-shadow":"inset 0 0 10px #666666","border-color":"#000000"});a.css({color:m.getFGColor(),"font-size":m.getFontSize()+"px",backgroundColor:m.getBGColor()})}var n="KindleReaderSettingsDialog",m,h,p,g,r={SAMPLE_STRING_ID:"k4w_reader_settings_sampleText",CANCEL_BUTTON_STRING_ID:"k4w_common_cancel_button",
APPLY_BUTTON_STRING_ID:"k4w_reader_settings_apply_button"},q={PREVIEW_ID:"#kindleReader_controlPanel_preview",FONT_SIZE_PANEL_ID:"#kindleReader_controlPanel_fontSize",COLOR_MODE_PANEL_ID:"#kindleReader_controlPanel_colorMode",MARGIN_PANEL_ID:"#kindleReader_controlPanel_margin",PAGE_MODE_ID:"#kindleReader_controlPanel_pageview"},t,s={getDialogSettings:function(){var a={};a[ResourceBundle.getLocalizedString(r.CANCEL_BUTTON_STRING_ID)]=f;a[ResourceBundle.getLocalizedString(r.APPLY_BUTTON_STRING_ID)]=
o;return{autoOpen:!1,width:380,modal:!0,draggable:!1,resizable:!1,buttons:a}},onInitializationDone:function(a){g=a;g.find(q.PREVIEW_ID).text(ResourceBundle.getLocalizedString(r.SAMPLE_STRING_ID));e();d();l();b()},beforeDialogOpen:function(b){g=b;a();k();c();j();var b=m.getPageDisplayMode(),d;for(d in KINDLE_READER_SETTINGS_PAGE_MODE)b===KINDLE_READER_SETTINGS_PAGE_MODE[d]?g.find(KINDLE_READER_SETTINGS_PAGE_MODE[d].id+"Selected").css("visibility","visible"):g.find(KINDLE_READER_SETTINGS_PAGE_MODE[d].id+
"Selected").css("visibility","hidden")},onDialogClose:function(){p&&h&&t(m)}};return{open:function(a,b){!/iPod/.test(navigator.userAgent)&&!/iPhone/.test(navigator.userAgent)&&(m=new KindleReaderSettings,m.copy(a),h=!1,t=b,p=h=!1,KindleUXComponentManager.openDialog(n,s))}}}(),KindleReaderSyncPositionDialog=function(){var e={TEXT_LABEL_STRING_ID:"k4w_reader_syncPosition_labelText",TEXT_LABEL_STRING_ID_NO_DEVICE_NAME:"k4w_reader_syncPosition_noDeviceName_labelText",OK_BUTTON__STRING_ID:"k4w_reader_syncPosition_OKText",
CANCEL_BUTTON_STRING_ID:"k4w_reader_syncPosition_cancelText"},k={TEXT_LABEL_ID:"kindleReader_dialog_syncPosition_label",OK_BUTTON_ID:"kindleReader_syncPosition_OK",CANCEL_BUTTON_ID:"kindleReader_syncPosition_cancel"},d,c,b,l=function(){b=!0;KindleUXComponentManager.closeDialog("KindleReaderSyncPositionDialog")},j=function(){KindleUXComponentManager.closeDialog("KindleReaderSyncPositionDialog")},o={getDialogSettings:function(){var b={};b[ResourceBundle.getLocalizedString(e.CANCEL_BUTTON_STRING_ID)]=
j;b[ResourceBundle.getLocalizedString(e.OK_BUTTON__STRING_ID)]=l;return{autoOpen:!1,modal:!0,draggable:!1,resizable:!1,buttons:b,k4w_transparent_modal_overlay:!0}},beforeDialogOpen:function(b){var a;if(c.fprDevice&&c.fprDevice!=="null"){var d=new Date(c.fprDateTime);a=ResourceBundle.getLocalizedTime(d);d=ResourceBundle.getLocalizedDate(d);a=ResourceBundle.getLocalizedString(e.TEXT_LABEL_STRING_ID,[c.currentLocation,c.fprLocation,c.fprDevice,a,d])}else a=ResourceBundle.getLocalizedString(e.TEXT_LABEL_STRING_ID_NO_DEVICE_NAME,
[c.currentLocation,c.fprLocation]);b.find("#"+k.TEXT_LABEL_ID).empty().append(a)},onDialogClose:function(){d(b)}};return{open:function(e,a){d=a;b=!1;c=e;KindleUXComponentManager.openDialog("KindleReaderSyncPositionDialog",o)}}}(),KindleReaderTouchLayer=function(){function e(e){n=e;a[b]&&n.tap(a[b]);a[b]&&n.tapHold(a[l]);a[b]&&n.swipeLeft(a[d]);a[b]&&n.swipeRight(a[c]);a[b]&&n.activate(a[j]);a[b]&&n.bind("touchstart",a[o]);f(n)}var k=0,d=k++,c=k++,b=k++,l=k++,j=k++,o=k++,f,a,n;return{EVENT_SWIPE_LEFT:d,
EVENT_SWIPE_RIGHT:c,EVENT_TAP:b,EVENT_TAP_HOLD:l,EVENT_TOUCHSTART:o,initialize:function(b,c){f=b;a=c;KindleUXComponentManager.initializeComponent("KindleReaderTouchLayer",e)}}}(),KindleIOSScrollStopper={stopScroll:function(e){e.preventDefault()}},KindleListUtilities=function(){return{binarySearch:function(e,k,d){if(!e.length)return 0;for(var c=e.length-1,b=0,l=0,j=null,o=0;b<=c;)if(l=Math.floor((b+c)/2),j=e[l],o=0,d===void 0?j>k?o=1:j<k&&(o=-1):o=d(k,j),o>0)c=l-1;else if(o<0)b=l+1;else return l;return l===
0||o<0?l:l-1},first:function(e){return e[0]},last:function(e){return e[e.length-1]}}}(),KindleOffline=function(){function e(c){var b=new jQuery.Deferred;setTimeout(b.resolve,c);return b.promise()}function k(c,b,e){if(c.indexOf(d)>=0&&KindleHostDeviceDetector.isiPad1()){var j=KindleModuleManager.getModuleSync(KindleModuleManager.METRICS_MANAGER),k=j.startMetrics("Reader::UnoptimizedBookOpen");KindleUnoptimizedFormatDialog.openPinning(function(c){c?(j.increaseSubCounter(k,"Continue",1),j.endMetrics(k),
j=null,b()):(j.increaseSubCounter(k,"Cancel",1),j.endMetrics(k),j=null,e())})}else b()}var d="topaz";return{isFirstTime:function(){return KindleLocalStorage.localStorageObject.getItem("haveRun")?!1:!0},isEnabled:function(){return KindleModuleManager.getModuleSync(KindleModuleManager.DB_CLIENT).bookDbEnabled()},firstRunMessage:function(){var c=new jQuery.Deferred;KindleFirstRunDialog.open(function(){KindleModuleManager.getModuleSync(KindleModuleManager.DB_CLIENT).enableFullDb().then(c.resolve,c.reject);
KindleLocalStorage.localStorageObject.setItem(Kindle.App.HAVE_RUN,"true")});return c.promise()},enableOfflineMessage:function(){var c=new jQuery.Deferred;KindleModuleManager.getModuleSync(KindleModuleManager.DB_CLIENT).enableFullDb().then(c.resolve,c.reject);setTimeout(function(){c.isRejected()&&KindleEnableOfflineDialog.open()},500);return c.promise()},pinBook:function(c,b){function d(){h.cancelDownloading();KindleLibraryProgressDialog.close();a.reject()}function j(){KindleLibraryProgressDialog.updateValue(100);
$.when(n,e(200)).then(function(){KindleLibraryProgressDialog.close();a.resolve()})}function o(c){KindleLibraryProgressDialog.close();c!==Kindle.ERROR.CANCELLED&&b(c);a.reject(c)}function f(){function a(b,c){KindleLibraryProgressDialog.updateValue(Math.round(100*Math.min(b,c)/Math.max(1,c)))}h.getSizeInfo().then(function(b){b.bookSize*1.53>b.quota?o(Kindle.ERROR.OUT_OF_SPACE):h.getBookType().then(function(b){k(b,function(){g.resolve(!0);h.getDownloadComplete(a).then(j,o)},function(){g.reject();d()})})})}
var a,n,m,h,p,g;a=new jQuery.Deferred;if(!KindleModuleManager.getModuleSync(KindleModuleManager.DB_CLIENT).bookDbEnabled())return a.reject(),a.promise();m=KindleModuleManagerFactory();window.parent.KindleApp.getSharedModules().done(function(a){m.registerModuleList(a);p=m.getModuleSync(m.METRICS_MANAGER).startMetrics("Pin");c.isSample=!1;h=KindleReaderBookInfoProvider.BookInfo(c,m);n=e(1500);g=new jQuery.Deferred;KindleLibraryProgressDialog.open(d);h.startDownloading(p,o,g).then(f,o)});return a.promise()},
unpinBook:function(c,b){function d(a){KindleSpinner.hide();n.endMetrics(m);b(a===Kindle.ERROR.NETWORK?Kindle.ERROR.REMOVE_NETWORK_FAILURE:Kindle.ERROR.REMOVE_FAILURE);f.reject(a)}function e(){KindleSpinner.hide();n.endMetrics(m);f.resolve()}function k(a){a.cacheState!==Kindle.BookInfo.CachedState.PINNED?a=!0:KindleHostDeviceDetector.isOnline()?(a={asin:c.asin,kindleSessionId:a.context.kindleSessionId,isOffline:!1},a=KindleModuleManager.getModuleSync(KindleModuleManager.SERVICE_CLIENT).setOfflineStatus(a)):
a=(new $.Deferred).reject(Kindle.ERROR.NETWORK).promise();return a}var f,a,n,m;KindleSpinner.show();f=new jQuery.Deferred;n=KindleModuleManager.getModuleSync(KindleModuleManager.METRICS_MANAGER);m=n.startMetrics("Unpin");a=KindleModuleManager.getModuleSync(KindleModuleManager.DB_CLIENT).getBookDb();a.getRecord("bookinfo",{asin:c.asin},{cacheState:!0,context:!0}).fail(d).done(function(b){b&&b.length>0&&$.when(k(b[0])).fail(d).done(function(){a.deleteBooksData([c.asin]).then(e,d)})});return f.promise()}}}(),
KindleTouchEventsToggler=function(){function e(b){if(c)for(var e=$(":hasTouchEvent"),j=0;j<e.length;j++){var k=e[j];if((!b||!b(k))&&k._listeners)for(var f=0;f<k._listeners.length;f++){var a=k._listeners[f][0];if(a==="touchstart"||a==="touchmove"||a==="touchend")a={element:k,type:a,func:k._listeners[f][1],useCapture:k._listeners[f][2]},d.push(a),k.removeEventListener(a.type,a.func,a.useCapture)}}}function k(){if(c){for(var b=0;b<d.length;b++){var e=d[b];e.element.addEventListener(e.type,e.func,e.useCapture)}d=
[]}}var d=[],c=!0;return{initialize:function(){var b=HTMLElement.prototype.addEventListener;HTMLElement.prototype.addEventListener=function(){if(!this._listeners)this._listeners=[];this._listeners.push(arguments);b.apply(this,arguments)};var c=HTMLElement.prototype.removeEventListener;HTMLElement.prototype.removeEventListener=function(){if(!this._listeners)this._listeners=[];var b=this._listeners.indexOf(arguments);b!==-1&&this._listeners.splice(b,1);c.apply(this,arguments)};$.expr[":"].hasTouchEvent=
function(b){if(b._listeners)for(var c=0;c<b._listeners.length;c++){var d=b._listeners[c][0];if(d==="touchstart"||d==="touchmove"||d==="touchend")return!0}return!1}},on:k,off:e,disallowTouchEvents:function(){c=!0;e();c=!1},allowTouchEvents:function(){c=!0;k()},isRequired:function(){return KindleHostDeviceDetector.isiOS()}}}();
(function(e){var k=["tap","tapHold","swipeLeft","swipeRight","activate"];e.each(k,function(d,c){e.fn[c]=function(b){return c==="tap"?KindleHostDeviceDetector.isiOS()?b?gt(this).on(c,b,{expire:700,moveThreshold:10}):this.trigger(c):b?this.click(b):this.trigger("click"):b?gt(this).on(c,b):this.trigger(c)};e.attrFn[c]=!0});e.each(k,function(d,c){var b="unbind"+c.slice(0,1).toUpperCase()+c.slice(1);e.fn[b]=function(b){return c==="tap"&&!KindleHostDeviceDetector.isiOS()?b?this.unbind("click",b):this.unbind("click"):
gt(this).off(c,b)};e.attrFn[b]=!0})})(jQuery);
var KindleUXComponentManager=function(){function e(a){if(a.callbacks.onDialogOpen)a.callbacks.onDialogOpen(a.component);a.callbacks.onOverlayClicked&&$(".ui-widget-overlay").tap(a.callbacks.onOverlayClicked).bind("contextmenu",function(b){a.callbacks.onOverlayClicked();b.preventDefault()})}function k(b,c,d){j(b,function(){var e;e=$.tmpl(b,ResourceBundle.getBundle(),d);a[b]={component:e};c(e)})}function d(a){a.stopPropagation()}function c(c,f,j,k){var l=a[c];l.callbacks=j;if(j.onInitializationDone)j.onInitializationDone(f);
if(j.getDialogSettings)l.dialogSettings=j.getDialogSettings();if(l.dialogSettings.width===void 0)l.dialogSettings.width=KindleHostDeviceDetector.isiPad()?m:h;l.dialogSettings.modal&&f.keydown(d).keyup(d);if(KindleHostDeviceDetector.isiOS_5x()){c=l.dialogSettings;if(c.modal)c.modal=!1,c.k4w_modal=!0;f=f.dialog(c)}else f=f.dialog(l.dialogSettings);l.component=f;if(!k&&!KindleHostDeviceDetector.isiOS_5x()){var n=f.dialog("option","position");$(window).resize(function(){f.dialog("option","position",n)})}f.bind("dialogopen",
function(){e(l)});f.bind("dialogclose",function(){if(l.callbacks.onDialogClose)l.callbacks.onDialogClose(l.component);l.dialogSettings.k4w_modal&&KindleDialogOverlay.removeOverlay()});f.bind("dialogbeforeclose",function(){$(".ui-widget-overlay").unbindTap();l.dialogSettings.modal&&p&&p(!0);l.callbacks.beforeDialogClose&&l.callbacks.beforeDialogClose(l.component)});b(l)}function b(a){a.component.dialog("isOpen")||(a.dialogSettings.k4w_transparent_modal_overlay?$("body").addClass(n):$("body").removeClass(n),
a.callbacks.beforeDialogOpen&&a.callbacks.beforeDialogOpen(a.component),a.dialogSettings.modal&&p&&p(!1),a.dialogSettings.k4w_modal&&KindleDialogOverlay.showOverlay(a),a.component.dialog("open"))}function l(b){a[b]&&a[b].component.dialog("isOpen")&&a[b].component.dialog("close")}function j(a,b){o(a).then(function(c){f[a]||($.template(a,c),b())},function(){KindleDebug.error("Template "+a+" is missing")})}function o(a){var b=$.Deferred(),a=$("#"+a);a.length!==1?b.reject():b.resolve(a);return b.promise()}
function f(a){return $.template[a]}var a=[],n="transparent_overlay",m=450,h=350,p;return{initializeTemplate:j,hasTemplate:f,renderTemplate:function(a,b){if(!$.template[a])throw{name:"initializationError",message:"Please call KindleUXComponentManager.initializeTemplate function first"};return $.tmpl(a,ResourceBundle.getBundle(),b)},initializeComponent:k,openDialog:function(d,e){var f=a[d];f?b(f):f!==null&&(a[d]=null,k(d,function(a){c(d,a,e)}))},closeDialog:l,isVisible:function(b){return a[b]&&a[b].component.dialog("isOpen")?
!0:!1},showMenu:function(d,e,f,h,j){var k=a[d];k?(e||KindlePopupMenu.updatePosition(d,h),j&&KindlePopupMenu.updateMenu(k.component,j),b(k)):KindlePopupMenu.initialize(d,e,f,h,function(b,e){j&&KindlePopupMenu.updateMenu(b,j);a[d]={component:b};c(d,b,e,!0)})},updateMenu:function(b,c){var d=a[b];d&&KindlePopupMenu.updateMenu(d.component,c)},hideMenu:l,registerKeyEventsEnabledCallback:function(a){p=a}}}(),ResourceBundle=function(){var e={en_US:{k4w_library_toolbar_store_button:"Kindle Store",k4w_library_toolbar_search_button:"Search",
k4w_library_toolbar_sync_button:"Sync",k4w_library_toolbar_manage_button:"Manage",k4w_library_toolbar_grid_button:"Grid View",k4w_library_toolbar_list_button:"List View",k4w_library_toolbar_sort_button:"Sort By",k4w_library_toolbar_cloud_button:"Cloud Content",k4w_library_toolbar_downloaded_button:"Downloaded Content",k4w_library_toolbar_cover_slider:"Cover Size",k4w_library_toolbar_cloud_label:"Cloud",k4w_library_toolbar_downloaded_label:"Downloaded",empty_search_msg:"No results for your search query.",
empty_search_offline:"(Only downloaded books are searchable when offline.)",k4w_reader_syncPosition_title:"Sync to Furthest Page Read",k4w_reader_syncPosition_labelText:'You are currently at location ${0}. The furthest read location is ${1} from "${2}" at ${3} on ${4}. Go to that location?',k4w_reader_syncPosition_noDeviceName_labelText:"You are currently at location ${0}. The furthest read location across all your devices is ${1}. Go to that location?",k4w_reader_syncPosition_OKText:"Sync",k4w_reader_syncPosition_cancelText:"Don't Sync",
k4w_reader_syncPosition_alreadyFurthest_Text:"You are currently at the furthest location across all your devices.",k4w_reader_syncPosition_cantSync_Text:"An error occurred while syncing. Please try again later.",k4w_reader_pageLoadError_Title:"Error Loading Content",k4w_reader_pageLoadError_Text:"An error occurred while loading the next page. Please try again later.",k4w_library_openBookContentLoanedError_Title:"Title Not Available",k4w_library_openBookContentLoanedError_Text:"This title cannot be opened because it is currently on loan.",
k4w_library_openBookContentLoanEndedError_Title:"Title Not Available",k4w_library_openBookContentLoanEndedError_Text:"This book was loaned to you and cannot be opened because the loan has ended.",k4w_library_openBookContentRentalExpiredError_Title:"Rental Expired",k4w_library_openBookContentRentalExpiredError_Text:"This rented book has reached its expiration date. Please select the Extend or Purchase button below if you would like to rent again or purchase this book.",kindle_dialog_rental_expired_extend_button_text:"Extend or Purchase",
kindle_dialog_rental_expired_dismiss_button_text:"Dismiss",k4w_library_openBookContentLicenseExceededError_Title:"License Limit Reached",k4w_library_openBookContentLicenseExceededError_Text:"You have exceeded the limit on the number of devices that can read this item. You may deregister any device no longer in use and delete the content, which will allow you to download this item. You may also purchase another copy from the Kindle Store.",k4w_library_openBookTimeoutError_Title:"Network Connection Error",
k4w_library_openBookTimeoutError_Text:"A connection error occurred. Please try again later.",k4w_library_openBookNetworkError_Title:"Error Opening Content",k4w_library_openBookNetworkError_Text:"An error occurred while opening the selected item. Please try again later.",k4w_library_openBookContentUnsupportedError_Title:"Title Not Available",k4w_library_openBookContentUnsupportedError_Text:"This title is not available on Kindle Cloud Reader.",k4w_library_openBookLoadFailure_Title:"Error Opening Content",
k4w_library_openBookLoadFailure_Text:"An error occurred while opening the selected item. Please try again later.",k4w_library_openBookSessionLimitExceededError_Title:"Session Limit Reached",k4w_library_openBookSessionLimitExceededError_Text:"You have reached the maximum number of concurrent sessions allowed for this title. Please try again later.",k4w_library_syncFailedError_Title:"Sync Failed",k4w_library_syncFailedError_Text:"An error occurred while syncing. Please try again later.",k4w_library_syncFailedOfflineError_Title:"Sync Failed",
k4w_library_syncFailedOfflineError_Text:"A connection to the Internet is required to view your content in the Cloud.",k4w_library_saveBookOutOfSpace_Title:"Error Saving Content",k4w_library_saveBookOutOfSpace_Text:"There is not enough space to save this item for offline reading. You may continue to read this title while online. Space can be freed by removing other saved titles. You might be able to increase your offline storage space; for more information <a href='http://www.amazon.com/gp/help/customer/display.html/ref=kcr_help_menu?nodeId=200732370#fxoffline' target='_blank'>click here</a>.",
k4w_library_removeBookError_Title:"Error Removing Content",k4w_library_removeBookError_Text:'An error occurred while removing the selected item. Downloaded content can be erased from this computer by choosing "Sign Out" from the Settings menu.',k4w_library_removeBookNetworkError_Title:"Error Removing Content",k4w_library_removeBookNetworkError_Text:"An error occurred while removing the selected item. Please try again later.",k4w_library_storeNotAvailable_Title:"No Internet Connection",k4w_library_storeNotAvailable_Text:"A connection to the Internet is required to shop in the Kindle Store.",
k4w_library_bookNotAvailable_Title:"No Internet Connection",k4w_library_bookNotAvailable_Text:"A connection to the Internet is required to view your content in the Cloud.",k4w_library_loadFailedError_Title:"Error Loading Library",k4w_library_loadFailedError_Text:"An error occurred while trying to load the library.",k4w_bookextras_open_failed_Error_Title:"Unable to Open Book Extras",k4w_bookextras_open_failed_Error_Text:"Book Extras for this book is not available at this time.",k4w_bookextras_offline_cache_failed_Error_Title:"Unable to Open Book Extras",
k4w_bookextras_offline_cache_failed_Error_Text:"Book Extras for this book was not saved for offline use.",k4w_store_open_failed_Error_Title:"Unable to Open Kindle Store",k4w_store_open_failed_Error_Text:"An error occurred while opening the Kindle Store. Please try again later.",k4w_store_open_failed_offline_Error_Title:"Unable to Open Kindle Store",k4w_store_open_failed_offline_Error_Text:"A connection to the Internet is required to access the Kindle Store.",k4w_library_unimplementedFeature_Error_Text:"",
k4w_dialog_offlineLogout_Title:"No Internet Connection",k4w_dialog_offlineLogout_Text:"A connection to the Internet is required to sign out of Kindle Cloud Reader.",k4w_library_unknownError_Title:"Error Opening Content",k4w_library_unknownError_Text:"An error occurred while attempting to open the selected item. Please try again later.",k4w_notification_title_text:"Create, edit, and delete notes and highlights in Cloud Reader.",k4w_notification_preTitle_text:"New!",k4w_notification_body_text:"Select text within a book to create a new note or highlight. Click the icon above to see all your notes and highlights.",
k4w_library_configurationRequest_Text:"",k4w_library_offlineRequest_Text:"",k4w_library_firstRun_Text:"",k4w_addToHomeScreen_text:"Install Kindle Cloud Reader on your iPad: tap ${0} then ${1}",k4w_addToHomeScreen_strong_text:"Add to Home Screen",k4w_notification_strong_text:"Create, edit and delete notes & highlights from Cloud Reader!",k4w_notification_blue_text:"New!",k4w_notification_text:"Select text within a book to create a new note or highlight. Click the icon above to see all your notes and highlights.",
k4w_endOfSample_Title:"End of Sample Content",k4w_endOfSample_Text:"You have reached the end of the sample content.  You can buy the full version from the Kindle Store or return to your sample.",k4w_endOfSample_buy_button:"Buy Full Version",k4w_endOfSample_cancel_button:"Return to Sample",k4w_library_sort_recent:"Sort by Recent",k4w_library_sort_author:"Sort by Author",k4w_library_sort_title:"Sort by Title",k4w_library_sort_recent_label:"Recent",k4w_library_sort_author_label:"Author",k4w_library_sort_title_label:"Title",
k4w_library_context_pin:"Pin Book",k4w_library_context_remove:"Remove Book",k4w_library_context_read:"Open Book",k4w_library_context_download_pin:"Download & Pin Book",k4w_library_deregister_title:"Sign Out",k4w_dialog_message_dismissButton_text:"OK",k4w_dialog_message_retryButton_text:"Try Again",k4w_reader_cover_title:"Cover",k4w_reader_table_of_contents_title:"Table of Contents",k4w_reader_beginning_title:"Beginning",k4w_reader_goto_location_title:"Location...",k4w_reader_book_extras_title:"Book Extras",
k4w_reader_slider_location_popup:"Location ${0} of ${1}",k4w_reader_slider_location:"${0} of ${1}",k4w_reader_slider_percentage:"Location: ${0}%",k4w_reader_downloading:"Downloading: ${0}%",k4w_reader_downloaded:"Downloaded ${0}%",k4w_reader_download_disk_error:"Downloaded: ${0}(Disk Full)",k4w_reader_download_network_error:"Download Stalled: ${0}(Error)",k4w_reader_goto_menu_goto_location_title:"Location...",k4w_reader_goto_menu_goto_message:"Please enter a location: ",k4w_reader_goto_menu_goto_location:"[from ${0} to ${1}]",
k4w_reader_goto_menu_goto_button:"Go to location",k4w_common_confirm_button:"OK",k4w_common_cancel_button:"Cancel",k4w_common_close_button:"Close",k4w_reader_toolbar_library_button:"Library",k4w_reader_toolbar_iOS_sample_close_button:"Close",k4w_reader_settings_sampleText:"Emma Woodhouse, handsome, clever, and rich, with a comfortable home and happy disposition, seemed to unite some of the best blessings of existence; and had lived nearly twenty-one years in the world with very little to distress or vex her.",
k4w_reader_settings_apply_button:"Apply Settings",k4w_reader_settings_fontSize_label:"FONT SIZE",k4w_reader_settings_margins_label:"MARGINS",k4w_reader_settings_colorMode_label:"COLOR MODE",k4w_reader_settings_pageview_label:"PAGE MODE",k4w_reader_sidebar_notes_location:"Location ${0}",k4w_reader_sidebar_bookmark_label:"Bookmark",k4w_reader_sidebar_note_label:"Note",k4w_reader_sidebar_note_highlight:"Highlight",k4w_reader_sidebar_delete:"Delete",k4w_reader_sidebar_empty_note:"This book does not contain any notes or marks.",
k4w_reader_annotation_pane_delete:"Delete",k4w_reader_annotation_pane_edit:"Edit Note",k4w_reader_annotation_pane_goto:"Go To Location",k4w_reader_annotation_pane_cancel:"Cancel",k4w_reader_annotation_pane_save:"Save Note",k4w_reader_annotation_pane_delete_confirm:"Confirm delete?",k4w_reader_annotation_pane_next:"Click for next",k4w_reader_annotation_pane_previous:"Click for previous",k4w_library_progress_dialog_title:"Downloading & Pinning Book",k4w_library_progress_dialog_message:"This title will be saved in the Downloaded tab for offline reading until you remove it. For convenience, we also automatically download recently opened books and keep them until space is needed.",
kindle_dialog_firstRun_offline_title:"Set Up Kindle Cloud Reader for Offline Reading",kindle_dialog_firstRun_chrome_app_title:"Kindle Cloud Reader Works Offline Too",kindle_dialog_firstRun_chrome_app_msg:"<strong>Right-click</strong> on any book cover then select <strong>&#8220;Download & Pin Book&#8221;</strong> to save a book for reading offline. We also store your most recently read books in the Downloaded section of your Library.",kindle_dialog_firstRun_chrome_msg:"Click <strong>&#8220;Enable Offline&#8221;</strong> below and then click <strong>&#8220;Continue&#8221;</strong> at the bottom of your browser window to enable offline reading.",
kindle_dialog_firstRun_ios_prompt_msg:"Tap <strong>&#8220;Increase&#8221;</strong> when prompted.  Then <strong>press and hold</strong> on any book cover in your Library and select <strong>&#8220;Download & Pin Book&#8221;</strong> to save a book for reading offline. We also store your most recently read books in the Downloaded section of your Library.",kindle_dialog_firstRun_safari_prompt_msg:"Click <strong>&#8220;Allow&#8221;</strong> when prompted.  Then <strong>click and hold</strong> on any book cover in your Library and select <strong>&#8220;Download & Pin Book&#8221;</strong> to save a book for reading offline. We also store your most recently read books in the Downloaded section of your Library.",
kindle_dialog_firstRun_firefox_msg:"Click the <strong>&#8220;Allow&#8221;</strong> button twice: once in the popup and once in the bar at the top of your browser window. ",kindle_noDownloadedBooks_title:"You currently have no downloaded books.",kindle_noDownloadedBooks_showmore:"How do I download books?",kindle_noDownloadedBooks_msg:"Your most recently read books are downloaded and displayed here. We automatically remove older books to make room for newer ones. You can also right-click (desktop) or press-and-hold (iPad) on any book cover to &#8220;Download & Pin Book.&#8221; Pinned books are available for offline reading until you remove them.",
k4w_empty_library_title:"You currently have no books in your Kindle Library",k4w_empty_library_main:"Shop from over 950,000* books in the ${0}.",k4w_empty_library_store_name:"Kindle Store",k4w_empty_library_free:"(Thousands of free books too!)",k4w_empty_library_legal:"*Book availability may vary for non-U.S. customers.",kindle_dialog_firstRun_button_text:"Get Started Now",kindle_dialog_firstRun_button_text_chrome:"Not Now",kindle_dialog_firstRun_button_text_chrome_done:"Continue",kindle_dialog_firstRun_button_crx_text:"Enable Offline",
kindle_dialog_firstRun_button_installing_text:"Click Continue Below...",kindle_dialog_firstRun_button_installed_text:"Install Complete",kindle_dialog_enableOffline_button_text:"OK",kindle_dialog_enable_offline_title:"Enable Offline Reading",kindle_dialog_enable_offline_firefox_msg:"Kindle Cloud Reader requires your permission to store books for offline reading. If you selected \u201cNever for This Site\u201d when Firefox asked for permission, you will need to <a href='http://www.amazon.com/gp/help/customer/display.html/ref=kcr_help_menu?nodeId=200732370#fxoffline' target='_blank'>follow these steps</a> to enable offline reading in Firefox.",
k4w_reader_menuButton_back:"Back",k4w_reader_menuButton_goto:"Go to menu",k4w_reader_menuButton_controlPane:"View settings",k4w_reader_menuButton_bookmark:"Toggle bookmark",k4w_reader_menuButton_sync:"Synchronize",k4w_reader_menuButton_notesAndMarks:"Toggle notes and marks",k4w_reader_menuButton_enterImmersive:"Enter immersive reading mode",k4w_reader_menuButton_exitImmersive:"Exit immersive reading mode",k4w_reader_pageArrow_prev:"Previous Page",k4w_reader_pageArrow_next:"Next Page",k4w_reader_storeNotAvailable_message:"No Internet Connection.<br /> A connection to the Internet is required to shop in the Kindle Store.",
k4w_reader_bookNotAvailable_message:"No Internet Connection.<br /> A connection to the Internet is required to view your content in the Cloud.",k4w_reader_context_createHighlight:"Highlight",k4w_reader_context_createNote:"Note",k4w_reader_context_editNote:"Note",k4w_reader_context_deleteHighlight:"Delete",k4w_library_help:"Help",k4w_library_terms_of_use:"Terms of Use",k4w_library_legal_notices:"Legal Notices",k4w_library_contact_us:"Contact Us",k4w_send_feedback_button:"Send",k4w_provide_feedback_title:"Contact Us",
k4w_provide_feedback_text:"Please enter your question or feedback in the space below.",k4w_provide_feedback_error:"An error occurred while attempting to send this message. Please try again later.",k4w_provide_feedback_sending:"Sending...",k4w_provide_feedback_success:"Message successfully sent! &#x2713;",k4w_reader_dialog_unoptimizedFormat_title:"Unsupported Content",k4w_reader_dialog_unoptimizedFormat_message:"This book is not optimized for Kindle Cloud Reader on this device. Please install <a href='http://itunes.apple.com/us/app/kindle/id302584613?mt=8'>Kindle for iPad</a> to read this item.",
k4w_reader_dialog_unoptimizedFormat_close:"Close Book",k4w_reader_dialog_unoptimizedFormat_stopSave:"Cancel Save",k4w_reader_dialog_unoptimizedFormat_continue:"Continue Anyway",k4w_library_caching:"Saving app for offline use",k4w_library_cached:"&#x2713; App ready for offline use",k4w_library_cacheError:"Error saving app. Click here to try again.",k4w_library_cacheError_pad:"Error saving app. Tap here to try again.",k4w_reader_dialog_annotation_pane_title:"Notes & Marks",kindle_dialog_appCache_title_text:"Error Saving Application",
kindle_dialog_appCache_button_text:"OK",kindle_dialog_appCache_message_text:"We encountered an error while trying to save the application for offline reading. To fix this you will need to restart the Safari application and any other running instances of Kindle Cloud Reader.",kindle_dialog_appCache_readmore_text:"How do I restart Safari and/or Kindle Cloud Reader?",kindle_dialog_appCache_step1_text:"Step 1.",kindle_dialog_appCache_step2_text:"Step 2.",kindle_dialog_appCache_step3_text:"Step 3.",kindle_dialog_appCache_step4_text:"Step 4.",
kindle_dialog_appCache_step5_text:"Step 5.",kindle_dialog_appCache_instruction1_text:"Click the iPad Home button to exit this application.",kindle_dialog_appCache_instruction2_text:"Click the iPad Home button twice to show the running applications tray (located at the bottom of your iPad's screen).",kindle_dialog_appCache_instruction3_text:"Locate the Safari application icon and press-and-hold on the icon until a minus button appears in the top left corner. Tap the minus button.",kindle_dialog_appCache_instruction4_text:"Locate any other instances of Kindle Cloud Reader and press-and-hold its icon until a minus button appears in the top left corner. Tap the minus button.",
kindle_dialog_appCache_instruction5_text:"Restart Safari and try loading read.amazon.com again.",kindle_dialog_logout_title:"Signing out of Kindle Cloud Reader...",kindle_dialog_logout_message:"Please wait while we clean up your downloaded content.",k4w_reader_dialog_editNote_title_create:"Create Note",k4w_reader_dialog_editNote_title_edit:"Edit Note",k4w_reader_dialog_editNote_save:"Save",k4w_reader_dialog_editNote_delete:"Delete",k4w_reader_dialog_editNote_cancel:"Cancel",k4w_reader_dialog_editNote_placeholder:"Type your note here"}},
k={en_US:"hh:mm a"},d={en_US:"MMM dd, yyyy"},c={en_US:"hh:mm a MMM dd, yyyy"},b="en_US";return{setLocale:function(c){b=c},getBundle:function(c){return e[c?c:b]},getLocalizedString:function(c,d,k){k=k?k:b;c=e[k]?e[k][c]:void 0;return d?String.prototype.format.apply(c,d):c||""},getLocalizedTime:function(c){return $.format.date(c,k[b])},getLocalizedDate:function(c){return $.format.date(c,d[b])},getLocalizedDateTime:function(d){return $.format.date(d,c[b])}}}();
